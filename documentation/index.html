<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Smooks</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1" />
    <link rel="shortcut icon" href="/assets/images/smooks-favicon.png"/>
    <link rel="stylesheet" href="/assets/css/styles.css" type="text/css"/>
    <link rel="stylesheet" href="/assets/css/asciidoctor.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" media="print" href="/assets/css/commonPrint.css" type="text/css"/>
    <link rel="stylesheet" media="print" href="/assets/css/gumax_print.css" type="text/css"/>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="./index">Smooks</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="/index">Home</a></li>
            <li><a href="/documentation">Documentation</a></li>
            <li><a href="/community">Community</a></li>
            <li><a href="https://github.com/smooks">GitHub</a></li>
            <li><a href="/faq">FAQ</a></li>
            <li><a href="https://github.com/smooks/smooks-examples/tree/v2">Examples</a></li>
            <li><a href="/maven">Maven</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
      <a href="https://github.com/orgs/smooks/repositories"><img decoding="async" style="position: absolute; top: 0; right: 0; border: 0;" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_green_007200.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" loading="lazy" data-recalc-dims="1"></a>
    </nav>

    <div class="main container">
        <h1>User Guide</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is the user guide for Smooks 2. For Smooks 1, visit the <a href="https://www.smooks.org/v1.7/documentation/">v1.7 user guide</a>.
</td>
</tr>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#why_smooks">Why Smooks?</a></li>
<li><a href="#fragment_based_processing">Fragment-Based Processing</a></li>
<li><a href="#whats_new_in_smooks_2">What&#8217;s new in Smooks 2?</a></li>
<li><a href="#migrating_from_smooks_1_7_to_2_0">Migrating from Smooks 1.7 to 2.0</a></li>
<li><a href="#faqs">FAQs</a></li>
<li><a href="#maven">Maven</a></li>
</ul>
</li>
<li><a href="#fundamentals">Fundamentals</a>
<ul class="sectlevel2">
<li><a href="#hello_world_app">Hello World App</a></li>
<li><a href="#smooks_resources">Smooks Resources</a></li>
<li><a href="#input">Input</a></li>
<li><a href="#output">Output</a></li>
<li><a href="#pipeline">Pipeline</a></li>
<li><a href="#delegate_reader">Delegate Reader</a></li>
<li><a href="#cartridge">Cartridge</a></li>
<li><a href="#filter">Filter</a></li>
<li><a href="#bean_context">Bean Context</a></li>
<li><a href="#global_configurations">Global Configurations</a></li>
<li><a href="#configuration_modularization">Configuration Modularization</a></li>
</ul>
</li>
<li><a href="#routing">Routing</a>
<ul class="sectlevel2">
<li><a href="#basic_splitting_and_routing">Basic Splitting and Routing</a></li>
<li><a href="#file">File</a></li>
<li><a href="#jms">JMS</a></li>
<li><a href="#apache_camel">Apache Camel</a></li>
</ul>
</li>
<li><a href="#exporting_results">Exporting Results</a></li>
<li><a href="#performance_tuning">Performance Tuning</a>
<ul class="sectlevel2">
<li><a href="#general">General</a></li>
<li><a href="#smooks_cartridges">Smooks Cartridges</a></li>
<li><a href="#javabean_cartridge">Javabean Cartridge</a></li>
</ul>
</li>
<li><a href="#testing">Testing</a>
<ul class="sectlevel2">
<li><a href="#unit_testing">Unit Testing</a></li>
</ul>
</li>
<li><a href="#extending_smooks">Extending Smooks</a>
<ul class="sectlevel2">
<li><a href="#configuring_smooks_components">Configuring Smooks Components</a></li>
<li><a href="#implementing_a_source_reader">Implementing a Source Reader</a></li>
<li><a href="#implementing_a_fragment_visitor">Implementing a Fragment Visitor</a></li>
</ul>
</li>
<li><a href="#instrumentation">Instrumentation</a>
<ul class="sectlevel2">
<li><a href="#activation">Activation</a></li>
<li><a href="#extending">Extending</a></li>
</ul>
</li>
<li><a href="#consuming_writing_data">Consuming &amp; Writing Data</a>
<ul class="sectlevel2">
<li><a href="#csv">CSV</a></li>
<li><a href="#fixed_length">Fixed-Length</a></li>
<li><a href="#dfdl">DFDL</a></li>
<li><a href="#edi">EDI</a></li>
<li><a href="#edifact">EDIFACT</a></li>
<li><a href="#json">JSON</a></li>
<li><a href="#yaml">YAML</a></li>
<li><a href="#javabeans">JavaBeans</a></li>
<li><a href="#templating">Templating</a></li>
</ul>
</li>
<li><a href="#validating_data">Validating Data</a>
<ul class="sectlevel2">
<li><a href="#rules">Rules</a></li>
<li><a href="#rule_based_validation">Rule-Based Validation</a></li>
</ul>
</li>
<li><a href="#database_support">Database Support</a>
<ul class="sectlevel2">
<li><a href="#jdbc">JDBC</a></li>
<li><a href="#persistence">Persistence</a></li>
<li><a href="#data_access_objects">Data Access Objects</a></li>
<li><a href="#maven_coordinates_13">Maven Coordinates</a></li>
<li><a href="#xml_namespaces_3">XML Namespaces</a></li>
</ul>
</li>
<li><a href="#scripting">Scripting</a>
<ul class="sectlevel2">
<li><a href="#groovy">Groovy</a></li>
</ul>
</li>
<li><a href="#common_use_cases">Common use cases</a>
<ul class="sectlevel2">
<li><a href="#processing_huge_messages_gbs">Processing Huge Messages (GBs)</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Smooks is an extensible Java framework for building XML and non-XML data (CSV, EDI, POJOs, etc&#8230;&#8203;) fragment-based applications. It can be used as a lightweight framework on which to hook your own processing logic for a wide range of data formats but, out-of-the-box, Smooks ships with features that can be used individually or seamlessly together:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Java Binding</strong>: Populate POJOs from a source (CSV, EDI, XML, POJOs, etc&#8230;&#8203;). Populated POJOs can either be the final result of a transformation, or serve as a bridge for further transformations like what is seen in template resources which generate textual results such as XML. Additionally, Smooks supports collections (maps and lists of typed data) that can be referenced from expression languages and templates.</p>
</li>
<li>
<p><strong>Transformation</strong>: perform a wide range of data transformations and mappings. XML to XML, CSV to XML, EDI to XML, XML to EDI, XML to CSV, POJO to XML, POJO to EDI, POJO to CSV, etc&#8230;&#8203;</p>
</li>
<li>
<p><strong>Templating</strong>: extensible template-driven transformations, with support for <a href="https://www.w3.org/TR/xslt/">XSLT</a>, <a href="https://freemarker.apache.org/">FreeMarker</a>, and <a href="https://www.stringtemplate.org/">StringTemplate</a>.</p>
</li>
<li>
<p><strong>Huge Message Processing</strong>: process huge messages (gigabytes!). Split, transform and route fragments to JMS, filesystem, database, and other destinations.</p>
</li>
<li>
<p><strong>Fragment Enrichment</strong>: enrich fragments with data from a database or other data sources.</p>
</li>
<li>
<p><strong>Complex Fragment Validation</strong>: rule-based fragment validation.</p>
</li>
<li>
<p><strong>Fragment Persistence</strong>: read fragments from, and save fragments to, a database with either JDBC, persistence frameworks (like MyBatis, Hibernate, or any JPA compatible framework), or DAOs.</p>
</li>
<li>
<p><strong>Combine</strong>: leverage Smooks&#8217;s transformation, routing and persistence functionality for <em>Extract Transform Load</em> (ETL) operations.</p>
</li>
<li>
<p><strong>Validation</strong>: perform basic or complex validation on fragment content. This is more than simple type/value-range validation.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="why_smooks">Why Smooks?</h3>
<div class="paragraph">
<p>Smooks was conceived to perform <em>fragment-based transformations</em> on messages. Supporting fragment-based transformation opened up the possibility of mixing and matching different technologies within the context of a single transformation. This meant that one could leverage distinct technologies for transforming fragments, depending on the type of transformation required by the fragment in question.</p>
</div>
<div class="paragraph">
<p>In the process of evolving this fragment-based transformation solution, it dawned on us that we were establishing a fragment-based processing paradigm. Concretely, a framework was being built for targeting custom <a href="#visitors">visitor</a> logic at message fragments. A visitor does not need to be restricted to transformation. A visitor could be implemented to apply all sorts of operations on fragments, and therefore, the message as a whole.</p>
</div>
<div class="paragraph">
<p>Smooks supports a wide range of data structures - XML, EDI, JSON, CSV, POJOs (POJO to POJO!). A pluggable reader interface allows you to plug in a reader implementation for any data format.</p>
</div>
</div>
<div class="sect2">
<h3 id="fragment_based_processing">Fragment-Based Processing</h3>
<div class="paragraph">
<p>The primary design goal of Smooks is to provide a framework that isolates and processes fragments in structured data (XML and non-XML) using existing data processing technologies (such as XSLT, plain vanilla Java, Groovy script).</p>
</div>
<div class="paragraph">
<p>A visitor targets a fragment with the visitor&#8217;s resource <em>selector</em> value. The targeted fragment can take in as much or as little of the source stream as you like. A fragment is identified by the name of the node enclosing the fragment. You can target the whole stream using the node name of the root node as the selector or through the reserved <code>#document</code> selector.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The terms <em>fragment</em> and <em>node</em> denote different meanings. It is usually acceptable to use the terms interchangeably because the difference is subtle and, more often than not, irrelevant. A <em>node</em> may be the outer node of a fragment, excluding the child nodes. A <em>fragment</em> is the outer node and all its child nodes along with their character nodes (text, etc&#8230;&#8203;). When a visitor targets a node, it typically means that the visitor can only process the fragment&#8217;s outer node as opposed to the fragment as a whole, that is, the outer node and its child nodes
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="whats_new_in_smooks_2">What&#8217;s new in Smooks 2?</h3>
<div class="paragraph">
<p>Smooks 2 introduces the <a href="https://github.com/smooks/smooks-dfdl-cartridge">DFDL cartridge</a> and revamps its <a href="https://github.com/smooks/smooks-edi-cartridge">EDI cartridge</a>, while dropping support for Java 7 along with other notable changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DFDL cartridge</p>
<div class="ulist">
<ul>
<li>
<p>DFDL is a specification for describing file formats in XML. The DFDL cartridge leverages <a href="https://daffodil.apache.org/">Apache Daffodil</a> to parse files and unparse XML. This opens up Smooks to a wide array of data formats like SWIFT, ISO8583, HL7, and many more.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Added compatibility with Java 9 and later versions; retained compatibility for Java 8</p>
</li>
<li>
<p><a href="#pipeline">Pipeline support</a></p>
<div class="ulist">
<ul>
<li>
<p>Compose any series of transformations on an event outside the main execution context before directing the pipeline output to the execution result stream or to other destinations</p>
</li>
</ul>
</div>
</li>
<li>
<p>Complete overhaul of the EDI cartridge and strengthening of EDI functionality</p>
<div class="ulist">
<ul>
<li>
<p>Rewritten to extend the DFDL cartridge and provide much better support for reading EDI documents</p>
</li>
<li>
<p>Added functionality to serialize EDI documents</p>
</li>
<li>
<p>As in previous Smooks versions, incorporated special support for EDIFACT</p>
</li>
</ul>
</div>
</li>
<li>
<p>SAX NG filter</p>
<div class="ulist">
<ul>
<li>
<p>Replaces SAX filter and supersedes DOM filter</p>
</li>
<li>
<p>Brings with it a new visitor API which unifies the SAX and DOM visitor APIs</p>
</li>
<li>
<p>Cartridges migrated to SAX NG</p>
</li>
<li>
<p>Supports XSLT and StringTemplate resources unlike the legacy SAX filter</p>
</li>
</ul>
</div>
</li>
<li>
<p>Mementos: a convenient way to stash and un-stash a visitor&#8217;s state during its execution lifecycle</p>
</li>
<li>
<p>Independent release cycles for all cartridges and one <a href="https://www.smooks.org/maven">Maven BOM</a> (bill of materials) to track them all</p>
</li>
<li>
<p>License change</p>
<div class="ulist">
<ul>
<li>
<p>After reaching consensus among our code contributors, we&#8217;ve dual-licensed Smooks under <a href="https://choosealicense.com/licenses/lgpl-3.0/">LGPL v3.0</a> and <a href="https://choosealicense.com/licenses/apache-2.0/">Apache License 2.0</a>. This license change keeps Smooks open source while adopting a permissive stance to modifications.</p>
</li>
</ul>
</div>
</li>
<li>
<p>New Smooks XSD schema (<code>xmlns="https://www.smooks.org/xsd/smooks-2.0.xsd"</code>)</p>
<div class="ulist">
<ul>
<li>
<p>Uniform XML namespace declarations: dropped <code>default-selector-namespace</code> and <code>selector-namespace</code> XML attributes in favour of declaring namespaces within the standard <code>xmlns</code> attribute from the <code>smooks-resource-config</code> element.</p>
</li>
<li>
<p>Removed <code>default-selector</code> attribute from <code>smooks-resource-config</code> element: selectors need to be set explicitly</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dropped Smooks-specific annotations in favour of JSR annotations</p>
<div class="ulist">
<ul>
<li>
<p>Farewell <code>@ConfigParam</code>, <code>@Config</code>, <code>@AppContext</code>, and <code>@StreamResultWriter</code>. Welcome <code>@Inject</code>.</p>
</li>
<li>
<p>Farewell <code>@Initialize</code> and <code>@Uninitialize</code>. Welcome <code>@PostConstruct</code> and <code>@PreDestroy</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Separate top-level Java namespaces for API and implementation to provide a cleaner and more intuitive package structure: API interfaces and internal classes were relocated to <code>org.smooks.api</code> and <code>org.smooks.engine</code> respectively</p>
</li>
<li>
<p>Improved XPath support for resource selectors</p>
<div class="ulist">
<ul>
<li>
<p>Functions like <code>not()</code> are now supported</p>
</li>
</ul>
</div>
</li>
<li>
<p>Numerous dependency updates</p>
</li>
<li>
<p>Maven coordinates change: we are now publishing Smooks artifacts under Maven group IDs prefixed with <code>org.smooks</code></p>
</li>
<li>
<p>Replaced default SAX parser implementation from Apache Xerces to <a href="https://github.com/FasterXML/woodstox">FasterXML&#8217;s Woodstox</a>: benchmarks consistently showed Woodstox outperforming Xerces</p>
</li>
<li>
<p><a href="#instrumentation">Monitoring and management support</a> with JMX</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="migrating_from_smooks_1_7_to_2_0">Migrating from Smooks 1.7 to 2.0</h3>
<div class="paragraph">
<p>Comparing the <a href="https://github.com/smooks/smooks/tree/v1.7.1/smooks-examples">code examples</a> for Smooks 1 with <a href="https://github.com/smooks/smooks-examples/tree/v2">those for Smooks 2</a> can be a useful guide in migrating to Smooks 2. While not exhaustive, we have compiled a list of notes to assist your migration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Smooks 2 no longer supports Java 7. Your application needs to be compiled to at least Java 8 to run Smooks 2.</p>
</li>
<li>
<p>Replace class interfaces:</p>
<div class="ulist">
<ul>
<li>
<p><code>org.milyn.delivery.ExecutionLifecycleInitializable</code> with <code>org.smooks.api.lifecycle.PreExecutionLifecycle</code></p>
</li>
<li>
<p><code>org.milyn.delivery.ExecutionLifecycleCleanable</code> with <code>org.smooks.api.lifecycle.PostExecutionLifecycle</code></p>
</li>
<li>
<p><code>org.milyn.delivery.VisitLifecycleCleanable</code> with <code>org.smooks.api.lifecycle.PostFragmentLifecycle</code></p>
</li>
<li>
<p><code>org.milyn.delivery.ConfigurationExpander</code> with <code>org.smooks.api.delivery.ResourceConfigExpander</code></p>
</li>
<li>
<p><code>org.milyn.event.ResourceBasedEvent</code> with <code>org.smooks.api.delivery.event.ResourceAwareEvent</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Remove references to  <code>org.milyn.util.CollectionsUtil</code> and write your own implementation for this class.</p>
</li>
<li>
<p>Implement from <code>org.smooks.api.resource.visitor.sax.ng.SaxNgVisitor</code> instead of <code>org.milyn.delivery.sax.SAXVisitor</code>.</p>
</li>
<li>
<p>Replace <code>Smooks#addConfiguration(&#8230;&#8203;)</code> method calls with <code>Smooks#addResourceConfig(&#8230;&#8203;)</code>.</p>
</li>
<li>
<p>Replace <code>Smooks#addConfigurations(&#8230;&#8203;)</code> method calls with <code>Smooks#addResourceConfigs(&#8230;&#8203;)</code>.</p>
</li>
<li>
<p>Replace references to:</p>
<div class="ulist">
<ul>
<li>
<p><code>org.milyn.javabean.DataDecode</code> with <code>org.smooks.api.converter.TypeConverterFactory</code>.</p>
</li>
<li>
<p><code>org.milyn.cdr.annotation.Configurator</code> with <code>org.smooks.api.lifecycle.LifecycleManager</code>.</p>
</li>
<li>
<p><code>org.milyn.javabean.DataDecoderException</code> with <code>org.smooks.api.converter.TypeConverterException</code>.</p>
</li>
<li>
<p><code>org.milyn.cdr.SmooksResourceConfigurationStore</code> with <code>org.smooks.api.Registry</code>.</p>
</li>
<li>
<p><code>org.milyn.cdr.SmooksResourceConfiguration</code> with <code>org.smooks.api.resource.config.ResourceConfig</code>.</p>
<div class="ulist">
<ul>
<li>
<p>Replace calls to <code>setDefaultResource()</code> with <code>setSystem()</code></p>
</li>
<li>
<p>Replace calls to <code>isDefaultResource()</code> with <code>isSystem()</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>org.milyn.delivery.sax.SAXToXMLWriter</code> with <code>org.smooks.io.DomSerializer</code>.</p>
</li>
<li>
<p><code>org.milyn.delivery.dom.serialize.Serializer</code> references with <code>org.smooks.api.resource.visitor.SerializerVisitor</code></p>
</li>
<li>
<p><code>org.milyn.event.types.ConfigBuilderEvent</code> references with <code>org.smooks.api.delivery.event.ContentDeliveryConfigExecutionEvent</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Replace <code>org.milyn.*</code> Java package references with <code>org.smooks.api</code>, <code>org.smooks.engine</code>, <code>org.smooks.io</code> or <code>org.smooks.support</code>.</p>
</li>
<li>
<p>Change legacy document root fragment selectors from <code>$document</code> to <code>#document</code>.</p>
</li>
<li>
<p>Remove the <code>milyn-smooks-all</code> dependency from the Maven POM and import the <a href="https://www.smooks.org/maven#bill_of_materials_bom">Smooks BOM</a> instead. Declare the corresponding dependency of each Smooks cartridge used within the project but omit the artifact version.</p>
</li>
<li>
<p>Replace Smooks Maven coordinates to match the coordinates as described in the <a href="https://www.smooks.org/maven">Maven guide</a>.</p>
</li>
<li>
<p>Replace <code>ExecutionContext#isDefaultSerializationOn()</code> method calls with
<code>ExecutionContext#getContentDeliveryRuntime().getDeliveryConfig().isDefaultSerializationOn()</code>.</p>
</li>
<li>
<p>Replace <code>ExecutionContext#getContext()</code> method calls with <code>ExecutionContext#getApplicationContext()</code>.</p>
</li>
<li>
<p>Replace <code>org.milyn.cdr.annotation.AppContext</code> annotations with <code>javax.inject.Inject</code> annotations.</p>
</li>
<li>
<p>Replace <code>org.milyn.cdr.annotation.ConfigParam</code> annotations with <code>javax.inject.Inject</code> annotations:</p>
<div class="ulist">
<ul>
<li>
<p>Substitute the <code>@ConfigParam</code> name attribute with the <code>@javax.inject.Named</code> annotation.</p>
</li>
<li>
<p>Wrap <code>java.util.Optional</code> around the field to mimic the behaviour of the <code>@ConfigParam</code> optional attribute.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Replace <code>org.milyn.delivery.annotation.Initialize</code> annotations with <code>jakarta.annotation.PostConstruct</code> annotations.</p>
</li>
<li>
<p>Replace <code>org.milyn.delivery.annotation.Uninitialize</code> annotations with <code>jakarta.annotation.PreDestroy</code> annotations.</p>
</li>
<li>
<p>Follow the <a href="https://github.com/smooks/smooks-examples/tree/master/edifact-to-java">EDIFACT-to-Java example</a> to migrate an implementation that binds an EDIFACT document to a POJO.</p>
</li>
<li>
<p>Follow the <a href="https://github.com/smooks/smooks-examples/tree/master/java-to-edifact">Java-to-EDIFACT example</a> to migrate an implementation that deserialises a POJO into an EDIFACT document.</p>
</li>
<li>
<p>Set <code>ContainerResourceLocator</code> from <code>DefaultApplicationContextBuilder#setResourceLocator</code> instead from <code>ApplicationContext#setResourceLocator</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="faqs">FAQs</h3>
<div class="paragraph">
<p>See the <a href="https://www.smooks.org/faq">FAQ</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="maven">Maven</h3>
<div class="paragraph">
<p>See the <a href="https://www.smooks.org/maven">Maven guide</a> for details on how to integrate Smooks into your project via Maven.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fundamentals">Fundamentals</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A commonly accepted definition of Smooks is of it being a <em>Transformation Engine</em>. Nonetheless, at its core, Smooks makes no reference to <em>data transformation</em>. The core codebase is designed to hook visitor logic into an event stream produced from a source of some kind. As such, in its most distilled form, Smooks is a <em>Structured Data Event Stream Processor</em>.</p>
</div>
<div class="paragraph">
<p>An application of a structured data event processor is transformation. In implementation terms, a Smooks transformation solution is a visitor reading the event stream from a source to produce a different representation of the input. However, Smooks&#8217;s core capabilities enable much more than transformation. A range of other solutions can be implemented based on the fragment-based processing model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Java binding</strong>: population of a POJO from the source.</p>
</li>
<li>
<p><strong>splitting &amp; routing</strong>: perform complex splitting and routing operations on the source stream, including routing data in different formats (XML, EDI, CSV, POJO, etc&#8230;&#8203;) to multiple destinations concurrently.</p>
</li>
<li>
<p><strong>huge message processing</strong>: declaratively consume (transform, or split and route) huge messages without writing boilerplate code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following gives a 10,000 foot view of Smooks:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks/master/docs/images/smooks.png" alt="Image:smooks.png"></span></p>
</div>
<div class="paragraph">
<p>Smooks&#8217;s fundamental behaviour is to take an input <em>source</em>, such as CSV, and from it generate an <em>event stream</em> to which <em>visitors</em> are applied to produce a <em>result</em>, such as EDI. In Smooks nomenclature, this behaviour is called filtering. During filtering, you have other Smooks actors which are participating, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>resources</p>
</li>
<li>
<p>application context</p>
</li>
<li>
<p>execution context</p>
</li>
<li>
<p>bean context</p>
</li>
<li>
<p>registry</p>
</li>
<li>
<p>listeners</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these actors are explained in later sections. Several sources and result types are supported which equate to different transformation types, including but not limited to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>XML to XML</p>
</li>
<li>
<p>XML to POJO</p>
</li>
<li>
<p>POJO to XML</p>
</li>
<li>
<p>POJO to POJO</p>
</li>
<li>
<p>EDI to XML</p>
</li>
<li>
<p>EDI to POJO</p>
</li>
<li>
<p>POJO to EDI</p>
</li>
<li>
<p>CSV to XML</p>
</li>
<li>
<p>CSV to &#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203; to &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Smooks maps the source to the result with the help of a highly-tunable SAX event model. The hierarchical events generated from an XML source (<em>startElement</em>, <em>endElement</em>, etc&#8230;&#8203;) drive the SAX event model though the event model can be just as easily applied to other structured data sources (EDI, CSV, POJO, etc&#8230;&#8203;). The most important events are typically the <em>before</em> and <em>after</em> visit events. The following illustration conveys the hierarchical nature of these events:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks/master/docs/images/Event-model.gif" alt="Image:event-model.gif"></span></p>
</div>
<div class="sect2">
<h3 id="hello_world_app">Hello World App</h3>
<div class="paragraph">
<p>One or more of <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/resource/visitor/sax/ng/SaxNgVisitor.html">SaxNgVisitor</a> interfaces need to be implemented in order to consume the SAX event stream produced from the source, depending on which events are of interest.</p>
</div>
<div class="paragraph">
<p>The following is a hello world app demonstrating how to implement a visitor that is fired on the <code>visitBefore</code> and <code>visitAfter</code> events of a targeted node in the event stream. In this case, Smooks configures the visitor to target element <code>foo</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks/master/docs/images/Simple-example.png" alt="Image:simple-example.png"></span></p>
</div>
<div class="paragraph">
<p>The visitor implementation is straightforward: one method implementation per event. As shown above, a Smooks config (more about <code>resource-config</code> later on) is written to target the visitor at a node&#8217;s <code>visitBefore</code> and <code>visitAfter</code> events.</p>
</div>
<div class="paragraph">
<p>The Java code executing the hello world app is a two-liner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="s">"/smooks/echo-example.xml"</span><span class="o">);</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Observe that in this case the program does not produce a result. The program does not even interact with the filtering process in any way because it does not provide an <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/ExecutionContext.html"><code>ExecutionContext</code></a> to <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/Smooks.html"><code>smooks.filterSource(...)</code></a>.</p>
</div>
<div class="paragraph">
<p>This example illustrated the lower level mechanics of the Smooks&#8217;s programming model. In reality, most users are not going to want to solve their problems at this level of detail. Smooks ships with substantial pre-built functionality, that is, pre-built visitors. Visitors are bundled based on functionality: these bundles are called <em>Cartridges</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="smooks_resources">Smooks Resources</h3>
<div class="paragraph">
<p>A Smooks execution consumes an source of one form or another (XML, EDI, POJO, JSON, CSV, etc&#8230;&#8203;), and from it, generates an event stream that fires different visitors (Java, Groovy, DFDL, XSLT, etc&#8230;&#8203;). The goal of this process can be to produce a new result stream in a different format (data transformation), bind data from the source to POJOs and produce a populated Java object graph (Java binding), produce many fragments (splitting), and so on.</p>
</div>
<div class="paragraph">
<p>At its core, Smooks views visitors and other abstractions as resources. A <em>resource</em> is applied when a <em>selector</em> matches a node in the event stream. The generality of such a processing model can be daunting from a usability perspective because resources are not tied to a particular domain. To counteract this, Smooks 1.1 introduced an <em>Extensible Configuration Model</em> feature that allows specific resource types to be specified in the configuration using dedicated XSD namespaces of their own. Instead of having a generic resource config such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;resource</span> <span class="na">type=</span><span class="s">"ftl"</span><span class="nt">&gt;</span><span class="c">&lt;!-- &lt;item&gt;
    &lt;id&gt;${.vars["order-item"].@id}&lt;/id&gt;
    &lt;productId&gt;${.vars["order-item"].product}&lt;/productId&gt;
    &lt;quantity&gt;${.vars["order-item"].quantity}&lt;/quantity&gt;
    &lt;price&gt;${.vars["order-item"].price}&lt;/price&gt;
&lt;/item&gt;
    --&gt;</span>
    <span class="nt">&lt;/resource&gt;</span>
<span class="nt">&lt;/resource-config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>an Extensible Configuration Model allows us to have a domain-specific resource config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!-- &lt;item&gt;
    &lt;id&gt;${.vars["order-item"].@id}&lt;/id&gt;
    &lt;productId&gt;${.vars["order-item"].product}&lt;/productId&gt;
    &lt;quantity&gt;${.vars["order-item"].quantity}&lt;/quantity&gt;
    &lt;price&gt;${.vars["order-item"].price}&lt;/price&gt;
&lt;/item&gt;
    --&gt;</span>
    <span class="nt">&lt;/ftl:template&gt;</span>
<span class="nt">&lt;/ftl:freemarker&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When comparing the above snippets, the latter resource has:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A more strongly typed domain specific configuration and so is easier to read,</p>
</li>
<li>
<p>Auto-completion support from the user&#8217;s IDE because the Smooks 1.1+ configurations are XSD-based, and</p>
</li>
<li>
<p>No need set the resource type in its configuration.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="visitors">Visitors</h4>
<div class="paragraph">
<p>Central to how Smooks works is the concept of a visitor. A visitor is a Java class performing a specific task on the targeted fragment such as applying an XSLT script, binding fragment data to a POJO, validate fragments, etc&#8230;&#8203;</p>
</div>
</div>
<div class="sect3">
<h4 id="selectors">Selectors</h4>
<div class="paragraph">
<p>Resource selectors are another central concept in Smooks. A selector chooses the node/s a visitor should visit, as well working as a simple opaque lookup value for non-visitor logic.</p>
</div>
<div class="paragraph">
<p>When the resource is a visitor, Smooks will interpret the selector as an <a href="http://www.w3.org/TR/xpath/">XPath-like</a> expression. There are a number of things to be aware of:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The order in which the XPath expression is applied is the reverse of a normal order, like what hapens in an XSLT script. Smooks inspects backwards from the targeted fragment node, as opposed to  forwards from the root node.</p>
</li>
<li>
<p>Not all of the XPath specification is supported. A selector supports the following XPath syntax:</p>
<div class="ulist">
<ul>
<li>
<p><code>text()</code> and attribute value selectors: <code>a/b[text() = 'abc']</code>, <code>a/b[text() = 123]</code>, <code>a/b[@id = 'abc']</code>, <code>a/b[@id = 123]</code>.</p>
<div class="ulist">
<ul>
<li>
<p><code>text()</code> is only supported on the last selector step in an expression: <code>a/b[text() = 'abc']</code> is legal while <code>a/b[text() = 'abc']/c</code> is illegal.</p>
</li>
<li>
<p><code>text()</code> is only supported on visitor implementations that implement the <code>AfterVisitor</code> interface <strong>only</strong>. If the visitor implements the <code>BeforeVisitor</code> or <code>ChildrenVisitor</code> interfaces, an error will result.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>or</code> &amp; <code>and</code> logical operations: <code>a/b[text() = 'abc' and @id = 123]</code>, <code>a/b[text() = 'abc' or @id = 123]</code></p>
</li>
<li>
<p>Namespaces on both the elements and attributes: <code>a:order/b:address[@b:city = 'NY']</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This requires the namespace prefix-to-URI mappings to be defined. A configuration error will result if not defined. Read the <a href="#namespace-declaration">namespace declaration</a> section for more details.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Supports <code>=</code> (equals), <code>!=</code> (not equals), <code>&lt;</code> (less than), <code>&gt;</code> (greater than).</p>
</li>
<li>
<p>Index selectors: <code>a/b[3]</code>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="namespace_declaration">Namespace Declaration</h4>
<div class="paragraph">
<p>The <code>xmlns</code> attribute is used to bind a selector prefix to a namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:c=</span><span class="s">"http://c"</span> <span class="na">xmlns:d=</span><span class="s">"http://d"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"c:item[@c:code = '8655']/d:units[text() = 1]"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;resource&gt;</span>com.acme.visitors.MyCustomVisitorImpl<span class="nt">&lt;/resource&gt;</span>
    <span class="nt">&lt;/resource-config&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, namespace prefix-to-URI mappings can be declared using the legacy core config <code>namespace</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;core:namespaces&gt;</span>
        <span class="nt">&lt;core:namespace</span> <span class="na">prefix=</span><span class="s">"c"</span> <span class="na">uri=</span><span class="s">"http://c"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;core:namespace</span> <span class="na">prefix=</span><span class="s">"d"</span> <span class="na">uri=</span><span class="s">"http://d"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/core:namespaces&gt;</span>

    <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"c:item[@c:code = '8655']/d:units[text() = 1]"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;resource&gt;</span>com.acme.visitors.MyCustomVisitorImpl<span class="nt">&lt;/resource&gt;</span>
    <span class="nt">&lt;/resource-config&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="input">Input</h3>
<div class="paragraph">
<p>Smooks relies on a <em>Reader</em> for ingesting a source and generating a SAX event stream. A reader is any class extending <a href="https://docs.oracle.com/javase/8/docs/api/org/xml/sax/XMLReader.html"><code>XMLReader</code></a>. By default, Smooks uses the <code>XMLReader</code> returned from <a href="https://docs.oracle.com/javase/8/docs/api/org/xml/sax/helpers/XMLReaderFactory.html"><code>XMLReaderFactory.createXMLReader()</code></a>. You can easily implement your own <code>XMLReader</code> to create a non-XML reader that generates the source event stream for Smooks to process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;reader</span> <span class="na">class=</span><span class="s">"com.acme.ZZZZReader"</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!--
        Other Smooks resources, e.g. &lt;jb:bean&gt; configs for
        binding data from the ZZZZ data stream into POJOs....
    --&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>reader</code> config element is referencing a user-defined <code>XMLReader</code>. It can be configured with a set of handlers, features and parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;reader</span> <span class="na">class=</span><span class="s">"com.acme.ZZZZReader"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;handlers&gt;</span>
        <span class="nt">&lt;handler</span> <span class="na">class=</span><span class="s">"com.X"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;handler</span> <span class="na">class=</span><span class="s">"com.Y"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/handlers&gt;</span>
    <span class="nt">&lt;features&gt;</span>
        <span class="nt">&lt;setOn</span> <span class="na">feature=</span><span class="s">"http://a"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;setOn</span> <span class="na">feature=</span><span class="s">"http://b"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;setOff</span> <span class="na">feature=</span><span class="s">"http://c"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;setOff</span> <span class="na">feature=</span><span class="s">"http://d"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/features&gt;</span>
    <span class="nt">&lt;params&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"param1"</span><span class="nt">&gt;</span>val1<span class="nt">&lt;/param&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"param2"</span><span class="nt">&gt;</span>val2<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;/params&gt;</span>
<span class="nt">&lt;/reader&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Packaged Smooks modules, known as <a href="#Cartridge">cartridges</a>, provide support for non-XML readers but, by default, Smooks expects an XML source. Omit the class name from the <code>reader</code> element to set features on the default XML reader:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;reader&gt;</span>
    <span class="nt">&lt;features&gt;</span>
        <span class="nt">&lt;setOn</span> <span class="na">feature=</span><span class="s">"http://a"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;setOn</span> <span class="na">feature=</span><span class="s">"http://b"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;setOff</span> <span class="na">feature=</span><span class="s">"http://c"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;setOff</span> <span class="na">feature=</span><span class="s">"http://d"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/features&gt;</span>
<span class="nt">&lt;/reader&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="output">Output</h3>
<div class="paragraph">
<p>Smooks can present output to the outside world in two ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As instances of <a href="https://docs.oracle.com/javase/8/docs/api/javax/xml/transform/Result.html"><code>Result</code></a>: client code extracts output from the <code>Result</code> instance after passing an empty one to <code>Smooks#filterSource(...)</code>.</p>
</li>
<li>
<p>As side effects: during filtering, resource output is sent to web services, local storage, queues, data stores, and other locations. Events trigger the routing of fragments to external endpoints such as what happens when <a href="https://github.com/smooks/smooks-routing-cartridge/blob/master/README.adoc">splitting and routing</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Unless configured otherwise, a Smooks execution does not accumulate the input data to produce all the outputs. The reason is simple: performance! Consider a document consisting of hundreds of thousands (or millions) of orders that need to be split up and routed to different systems in different formats, based on different conditions. The only way of handing documents of these magnitudes is by streaming them.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Smooks can generate output in either, or both, of the above ways, all in a single filtering pass of the source. It does not need to filter the source multiple times in order to generate multiple outputs, critical for performance.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="result">Result</h4>
<div class="paragraph">
<p>A look at the Smooks API reveals that Smooks can be supplied with multiple <code>Result</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">filterSource</span><span class="o">(</span><span class="nc">Source</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Result</span><span class="o">...</span> <span class="n">results</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SmooksException</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Smooks can work with the standard JDK <a href="https://docs.oracle.com/javase/8/docs/api/javax/xml/transform/stream/StreamResult.html"><code>StreamResult</code></a> and <a href="https://docs.oracle.com/javase/8/docs/api/javax/xml/transform/dom/DOMResult.html"><code>DOMResult</code></a> result types, as well as the Smooks specific ones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/io/payload/JavaResult.html"><code>JavaResult</code></a>: result type for capturing the contents of the Smooks JavaBean context.</p>
</li>
<li>
<p><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/io/payload/StringResult.html"><code>StringResult</code></a>: <code>StreamResult</code> extension wrapping a <code>StringWriter</code>, useful for testing.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
As yet, Smooks does not support capturing output to multiple <code>Result</code> instances of the same type. For example, you can specify multiple <code>StreamResult</code> instances in <code>Smooks.filterSource(...)</code> but Smooks will only output to the first <code>StreamResult</code> instance.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="stream_results">Stream Results</h5>
<div class="paragraph">
<p>The <code>StreamResult</code> and <code>DOMResult</code> types receive special attention from Smooks. When the <a href="#user-content-settings"><code>default.serialization.on</code></a> global parameter is turned on, which by default it is, Smooks serializes the stream of events to XML while filtering the source. The XML is fed to the <code>Result</code> instance if a <code>StreamResult</code> or <code>DOMResult</code> is passed to <code>Smooks#filterSource</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is the mechanism used to perform a standard 1-input/1-xml-output character-based transformation.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="side_effects">Side Effects</h4>
<div class="paragraph">
<p>Smooks is also able to generate different types of output during filtering, that is, while filtering the source event stream but before it reaches the end of the stream. A classic example of this output type is when it is used to split and route fragments to different endpoints for processing by other processes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pipeline">Pipeline</h3>
<div class="paragraph">
<p>A pipeline is a flexible, yet simple, Smooks construct that isolates the processing of a targeted event from its main processing as well as from the processing of other pipelines. In practice, this means being able to compose any series of transformations on an event outside the main execution context before directing the pipeline output to the execution result stream or to other destinations. With pipelines, you can enrich data, rename/remove nodes, and much more.</p>
</div>
<div class="paragraph">
<p>Under the hood, a pipeline is just another instance of Smooks, made self-evident from the Smooks config element declaring a pipeline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span><span class="nt">&gt;</span>

   <span class="nt">&lt;core:smooks</span> <span class="na">filterSourceOn=</span><span class="s">"..."</span><span class="nt">&gt;</span>
       <span class="nt">&lt;core:action&gt;</span>
           ...
       <span class="nt">&lt;/core:action&gt;</span>
       <span class="nt">&lt;core:config&gt;</span>
           <span class="nt">&lt;smooks-resource-list&gt;</span>
               ...
           <span class="nt">&lt;/smooks-resource-list&gt;</span>
       <span class="nt">&lt;/core:config&gt;</span>
   <span class="nt">&lt;/core:smooks&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>core:smooks</code> fires a nested Smooks execution whenever an event in the stream matches the <code>filterSourceOn</code> selector. The pipeline within the inner <code>smooks-resource-list</code> element visits the selected event and its child events. It is worth highlighting that the inner <code>smooks-resource-list</code> element behaves identically to the outer one, and therefore, it accepts resources like visitors, readers, and even pipelines (a pipeline within a pipeline!). Moreover, a pipeline is transparent to its nested resources: a resource’s behaviour remains the same whether it’s declared inside a pipeline or outside it.</p>
</div>
<div class="paragraph">
<p>The optional <code>core:action</code> element tells the nested Smooks instance what to do with the pipeline’s output. The next sections list the supported actions.</p>
</div>
<div class="sect3">
<h4 id="inline">Inline</h4>
<div class="paragraph">
<p>Merges the pipeline&#8217;s output with the result stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">...
<span class="nt">&lt;core:action&gt;</span>
    <span class="nt">&lt;core:inline&gt;</span>
        ...
    <span class="nt">&lt;/core:inline&gt;</span>
<span class="nt">&lt;/core:action&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As described in the subsequent sections, an inline action replaces, prepends, or appends content.</p>
</div>
<div class="sect4">
<h5 id="replace">Replace</h5>
<div class="paragraph">
<p>Substitutes the selected fragment with the pipeline output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">...
<span class="nt">&lt;core:inline&gt;</span>
    <span class="nt">&lt;core:replace/&gt;</span>
<span class="nt">&lt;/core:inline&gt;</span>
...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="prepend_before">Prepend Before</h5>
<div class="paragraph">
<p>Adds the output before the selector start tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;core:inline&gt;</span>
    <span class="nt">&lt;core:prepend-before/&gt;</span>
<span class="nt">&lt;/core:inline&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="prepend_after">Prepend After</h5>
<div class="paragraph">
<p>Adds the output after the selector start tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;core:inline&gt;</span>
    <span class="nt">&lt;core:prepend-after/&gt;</span>
<span class="nt">&lt;/core:inline&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="append_before">Append Before</h5>
<div class="paragraph">
<p>Adds the output before the selector end tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;core:inline&gt;</span>
    <span class="nt">&lt;core:append-before/&gt;</span>
<span class="nt">&lt;/core:inline&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="append_after">Append After</h5>
<div class="paragraph">
<p>Adds the output after the selector end tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;core:inline&gt;</span>
    <span class="nt">&lt;core:append-after/&gt;</span>
<span class="nt">&lt;/core:inline&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bind_to">Bind To</h4>
<div class="paragraph">
<p>Binds the output to the execution context’s bean store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">...
<span class="nt">&lt;core:action&gt;</span>
    <span class="nt">&lt;core:bindTo</span> <span class="na">id=</span><span class="s">"..."</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/core:action&gt;</span>
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="output_to">Output To</h4>
<div class="paragraph">
<p>Directs the output to a different stream other than the result stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">...
<span class="nt">&lt;core:action&gt;</span>
    <span class="nt">&lt;core:outputTo</span> <span class="na">outputStreamResource=</span><span class="s">"..."</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/core:action&gt;</span>
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="delegate_reader">Delegate Reader</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>core:delegate-reader</code> was introduced in Smooks 2.0.0-M3 and will be renamed to <code>core:rewrite</code> in the next release of Smooks.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>core:delegate-reader</code> construct is a reader designed to offer a convenient mechanism for substituting the event stream entering a <a href="#pipeline">pipeline</a> with one that the pipeline resources can process.</p>
</div>
<div class="paragraph">
<p><code>core:delegate-reader</code> enables one or more of its enclosed visitors to substitute targeted events with new events. In the example that follows, the pipeline feeds the event stream to <code>core:delegate-reader</code>, and <code>core:delegate-reader</code> in turn, feeds targeted events to the nested FreeMarker visitors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span>
                      <span class="na">xmlns:edifact=</span><span class="s">"https://www.smooks.org/xsd/smooks/edifact-2.0.xsd"</span><span class="nt">&gt;</span>

    ...
    ...

    <span class="nt">&lt;core:smooks</span> <span class="na">filterSourceOn=</span><span class="s">"#document"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;core:action&gt;</span>
            <span class="nt">&lt;core:inline&gt;</span>
                <span class="nt">&lt;core:replace/&gt;</span>
            <span class="nt">&lt;/core:inline&gt;</span>
        <span class="nt">&lt;/core:action&gt;</span>
        <span class="nt">&lt;core:config&gt;</span>
            <span class="nt">&lt;smooks-resource-list&gt;</span>
                <span class="nt">&lt;core:delegate-reader&gt;</span>
                    <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"#document"</span> <span class="na">applyBefore=</span><span class="s">"true"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;ftl:template&gt;</span>header.xml.ftl<span class="nt">&lt;/ftl:template&gt;</span>
                    <span class="nt">&lt;/ftl:freemarker&gt;</span>
                    <span class="nt">&lt;core:smooks</span> <span class="na">filterSourceOn=</span><span class="s">"record"</span> <span class="na">maxNodeDepth=</span><span class="s">"0"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;core:config&gt;</span>
                            <span class="nt">&lt;smooks-resource-list&gt;</span>
                                <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"#document"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;ftl:template&gt;</span>body.xml.ftl<span class="nt">&lt;/ftl:template&gt;</span>
                                <span class="nt">&lt;/ftl:freemarker&gt;</span>
                            <span class="nt">&lt;/smooks-resource-list&gt;</span>
                        <span class="nt">&lt;/core:config&gt;</span>
                    <span class="nt">&lt;/core:smooks&gt;</span>
                    <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"#document"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;ftl:template&gt;</span>footer.xml.ftl<span class="nt">&lt;/ftl:template&gt;</span>
                    <span class="nt">&lt;/ftl:freemarker&gt;</span>
                <span class="nt">&lt;/core:delegate-reader&gt;</span>

                <span class="nt">&lt;edifact:unparser</span> <span class="na">schemaUri=</span><span class="s">"/d96a/EDIFACT-Messages.dfdl.xsd"</span> <span class="na">unparseOnNode=</span><span class="s">"*"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;edifact:messageTypes&gt;</span>
                        <span class="nt">&lt;edifact:messageType&gt;</span>ORDERS<span class="nt">&lt;/edifact:messageType&gt;</span>
                    <span class="nt">&lt;/edifact:messageTypes&gt;</span>
                <span class="nt">&lt;/edifact:unparser&gt;</span>
            <span class="nt">&lt;/smooks-resource-list&gt;</span>
        <span class="nt">&lt;/core:config&gt;</span>
    <span class="nt">&lt;/core:smooks&gt;</span>

    ...
    ...
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A visitor within <code>core:delegate-reader</code> writes XML fragments to the result stream, replacing the targeted events. For example, in the config above, the FreeMarker visitors are replacing the <code>#document</code> and <code>record</code> events with materialised XML templates. More precisely, <code>core:delegate-reader</code> converts the materialised XML into a new event stream which is then processed by the downstream pipeline resources, in this case, <code>edifact:unparser</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The full example is <a href="https://github.com/smooks/smooks-examples/tree/v2/pipelines">available in the smooks-examples repository</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When implementing your own visitor for <code>core:delegate-reader</code>, call <code>org.smooks.io.Stream#out(org.smooks.api.ExecutionContext).write(java.lang.String)</code> within one of the overridden visit methods to replace the event stream as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">org.smooks.benchmark</span><span class="o">;</span>

<span class="o">...</span>
<span class="o">...</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BibliographyVisitor</span> <span class="kd">implements</span> <span class="nc">AfterVisitor</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">TEMPLATE</span> <span class="o">=</span> <span class="s">"&lt;entry&gt;&lt;author&gt;%s&lt;/author&gt;&lt;title&gt;%s&lt;/title&gt;&lt;/entry&gt;"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">DOMXPath</span> <span class="n">domXPath</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">DOMXPath</span> <span class="n">titleXPath</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postConstruct</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">JaxenException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">domXPath</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMXPath</span><span class="o">(</span><span class="s">"//author"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">titleXPath</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMXPath</span><span class="o">(</span><span class="s">"//title"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Element</span><span class="o">&gt;</span> <span class="n">authors</span> <span class="o">=</span> <span class="o">((</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Element</span><span class="o">&gt;)</span> <span class="n">domXPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">element</span><span class="o">));</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Element</span><span class="o">&gt;</span> <span class="n">titles</span> <span class="o">=</span> <span class="o">((</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Element</span><span class="o">&gt;)</span> <span class="n">titleXPath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">element</span><span class="o">));</span>
            <span class="nc">Stream</span><span class="o">.</span><span class="na">out</span><span class="o">(</span><span class="n">executionContext</span><span class="o">).</span><span class="na">write</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="no">TEMPLATE</span><span class="o">,</span> <span class="n">authors</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="s">"N/A"</span> <span class="o">:</span> <span class="n">authors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getTextContent</span><span class="o">(),</span> <span class="s">"&lt;![CDATA["</span> <span class="o">+</span> <span class="o">(</span><span class="n">titles</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="s">"N/A"</span> <span class="o">:</span> <span class="n">titles</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getTextContent</span><span class="o">()))</span> <span class="o">+</span> <span class="s">"]]&gt;"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">JaxenException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SmooksException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>BibliographyVisitor</code> is a custom visitor which visits end events. The <code>visitAfter</code> method evaluates the author elements together with the title elements and writes XML to the result stream replacing the selected events.</p>
</div>
</div>
<div class="sect2">
<h3 id="cartridge">Cartridge</h3>
<div class="paragraph">
<p>The basic functionality of Smooks can be extended through the development of a Smooks cartridge. A cartridge is a Java archive (JAR) containing reusable resources (also known as <em>Content Handlers</em>). A cartridge augments Smooks with support for a specific type input source or event handling.</p>
</div>
<div class="paragraph">
<p>Visit the <a href="https://github.com/orgs/smooks/repositories?q=cartridge&amp;type=all&amp;language=&amp;sort=">GitHub repositories page</a> for the complete list of Smooks cartridges.</p>
</div>
</div>
<div class="sect2">
<h3 id="filter">Filter</h3>
<div class="paragraph">
<p>A Smooks filter delivers generated events from a reader to the application&#8217;s resources. Smooks 1 had the DOM and SAX filters. The DOM filter was simple to use but kept all the events in memory while the SAX filter, though more complex, delivered the events in streaming fashion. Having two filter types meant two different visitor APIs and execution paths, with all the baggage it entailed.</p>
</div>
<div class="paragraph">
<p>Smooks 2 unifies the legacy DOM and SAX filters without sacrificing convenience or performance. The new SAX NG filter drops the API distinction between DOM and SAX. Instead, the filter streams SAX events  as <strong>partial</strong> DOM elements to SAX NG visitors targeting the element. A SAX NG visitor can read the targeted node as well as any of the node&#8217;s ancestors but not the targeted node&#8217;s children or siblings in order to keep the memory footprint to a minimum.</p>
</div>
<div class="paragraph">
<p>The SAX NG filter can mimic DOM by setting its <code>max.node.depth</code> parameter to 0 (default value is 1), allowing each visitor to process the complete DOM tree in its <code>visitAfter(...)</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;params&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"max.node.depth"</span><span class="nt">&gt;</span>0<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;/params&gt;</span>
    ...
<span class="nt">&lt;/smooks&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>max.node.depth</code> value of greater than 1 will tell the filter to read and keep an node&#8217;s descendants up to the desired depth. Take the following input as an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order</span> <span class="na">id=</span><span class="s">"332"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;customer</span> <span class="na">number=</span><span class="s">"123"</span><span class="nt">&gt;</span>Joe<span class="nt">&lt;/customer&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;order-items&gt;</span>
        <span class="nt">&lt;order-item</span> <span class="na">id=</span><span class="s">"1"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;product&gt;</span>1<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;</span>
            <span class="nt">&lt;price&gt;</span>8.80<span class="nt">&lt;/price&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
        <span class="nt">&lt;order-item</span> <span class="na">id=</span><span class="s">"2"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;product&gt;</span>2<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;</span>
            <span class="nt">&lt;price&gt;</span>8.80<span class="nt">&lt;/price&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
        <span class="nt">&lt;order-item</span> <span class="na">id=</span><span class="s">"3"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;product&gt;</span>3<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;</span>
            <span class="nt">&lt;price&gt;</span>8.80<span class="nt">&lt;/price&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
    <span class="nt">&lt;/order-items&gt;</span>
<span class="nt">&lt;/order&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Along with the config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;params&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"max.node.depth"</span><span class="nt">&gt;</span>2<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;/params&gt;</span>

    <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;resource&gt;</span>org.acme.MyVisitor<span class="nt">&lt;/resource&gt;</span>
    <span class="nt">&lt;/resource-config&gt;</span>

<span class="nt">&lt;/smooks&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At any given time, there will always be a single <em>order-item</em> in memory containing <em>product</em> because <code>max.node.depth</code> is 2. Each new <em>order-item</em> overwrites the previous <em>order-item</em> to minimise the memory footprint. <code>MyVisitor#visitAfter(...)</code> is invoked 3 times, each invocation corresponding to an <em>order-item</em> fragment. The first invocation will process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order-item</span> <span class="na">id=</span><span class="s">'1'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;product&gt;</span>2<span class="nt">&lt;/product&gt;</span>
<span class="nt">&lt;/order-item&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While the second invocation will process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order-item</span> <span class="na">id=</span><span class="s">'2'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;product&gt;</span>2<span class="nt">&lt;/product&gt;</span>
<span class="nt">&lt;/order-item&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whereas the last invocation will process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order-item</span> <span class="na">id=</span><span class="s">'3'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;product&gt;</span>3<span class="nt">&lt;/product&gt;</span>
<span class="nt">&lt;/order-item&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programmatically, implementing <code>org.smooks.api.resource.visitor.sax.ng.ParameterizedVisitor</code> will give you fine-grained control over the visitor&#8217;s targeted element depth:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DomVisitor</span> <span class="kd">implements</span> <span class="nc">ParameterizedVisitor</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitBefore</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Element: "</span> <span class="o">+</span> <span class="nc">XmlUtil</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMaxNodeDepth</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ParameterizedVisitor#getMaxNodeDepth()</code> returns an integer denoting the targeted element&#8217;s maximum tree depth the visitor can accept in its <code>visitAfter(...)</code> method.</p>
</div>
<div class="sect3">
<h4 id="settings">Settings</h4>
<div class="paragraph">
<p>Filter-specific knobs are set through the <em>smooks-core</em> configuration namespace (<code>https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd</code>) introduced in Smooks 1.3:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;core:filterSettings</span> <span class="na">type=</span><span class="s">"SAX NG"</span> <i class="conum" data-value="1"></i><b>(1)</b>
                         <span class="na">defaultSerialization=</span><span class="s">"true"</span> <i class="conum" data-value="2"></i><b>(2)</b>
                         <span class="na">terminateOnException=</span><span class="s">"true"</span> <i class="conum" data-value="3"></i><b>(3)</b>
                         <span class="na">closeSource=</span><span class="s">"true"</span> <i class="conum" data-value="4"></i><b>(4)</b>
                         <span class="na">closeResult=</span><span class="s">"true"</span> <i class="conum" data-value="5"></i><b>(5)</b>
                         <span class="na">rewriteEntities=</span><span class="s">"true"</span> <i class="conum" data-value="6"></i><b>(6)</b>
                         <span class="na">readerPoolSize=</span><span class="s">"3"</span><span class="nt">/&gt;</span> <i class="conum" data-value="7"></i><b>(7)</b>

    <span class="c">&lt;!-- Other visitor configs etc... --&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>type</code> (default: <code>SAX NG</code>): the type of processing model that will be used. <code>SAX NG</code> is the recommended type. The <code>DOM</code> type is deprecated.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>defaultSerialization</code> (default: <code>true</code>): if default serialization should be switched on. Default serialization being turned on simply tells Smooks to locate a <code>StreamResult</code> (or <code>DOMResult</code>) in the Result objects provided to the <code>Smooks.filterSource</code> method and to serialize all events to that <code>Result</code> instance. This behavior can be turned off using this global configuration parameter and can be overridden on a per-fragment basis by targeting a visitor at that fragment that takes ownership of the <code>org.smooks.io.FragmentWriter</code> object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>terminateOnException</code> (default: <code>true</code>): whether an exception should terminate execution.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>closeSource</code> (default: <code>true</code>): close <code>Inp</code> instance streams passed to the <code>Smooks.filterSource</code> method. The exception here is <code>System.in</code>, which will never be closed.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>closeResult</code>: close Result streams passed to the <code>[Smooks.filterSource</code> method (default "true"). The exception here is <code>System.out</code> and <code>System.err</code>, which will never be closed.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>rewriteEntities</code>: rewrite XML entities when reading and writing (default serialization) XML.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>readerPoolSize</code>: reader Pool Size (default 0). Some Reader implementations are very expensive to create (e.g. Xerces). Pooling Reader instances (i.e. reusing) can result in a huge performance improvement, especially when processing lots of "small" messages. The default value for this setting is 0 (i.e. unpooled - a new Reader instance is created for each message). Configure in line with your applications threading model.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting">Troubleshooting</h4>
<div class="paragraph">
<p>Smooks streams events that can be captured, and inspected, while in-flight or after execution. <code>HtmlReportGenerator</code> is one such class that inspects in-flight events to go on and generate an HTML report from the execution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="s">"/smooks/smooks-transform-x.xml"</span><span class="o">);</span>
<span class="nc">ExecutionContext</span> <span class="n">executionContext</span> <span class="o">=</span> <span class="n">smooks</span><span class="o">.</span><span class="na">createExecutionContext</span><span class="o">();</span>

<span class="n">executionContext</span><span class="o">.</span><span class="na">getContentDeliveryRuntime</span><span class="o">().</span><span class="na">addExecutionEventListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">HtmlReportGenerator</span><span class="o">(</span><span class="s">"/tmp/smooks-report.html"</span><span class="o">));</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span> <span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">inputStream</span><span class="o">),</span> <span class="k">new</span> <span class="nc">StreamResult</span><span class="o">(</span><span class="n">outputStream</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>HtmlReportGenerator</code> is a useful tool in the developer&#8217;s arsenal for diagnosing issues, or for comprehending a transformation.</p>
</div>
<div class="paragraph">
<p>An example <code>HtmlReportGenerator</code> report can be seen <a href="http://www.milyn.org/docs/smooks-report/report.html">online here</a>.</p>
</div>
<div class="paragraph">
<p>Of course you can also write and use your own <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/delivery/event/ExecutionEventListener.html">ExecutionEventListener</a> implementations.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Only use the HTMLReportGenerator in development. When enabled, the HTMLReportGenerator incurs a significant performance overhead and with large message, can even result in OutOfMemory exceptions.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="terminate">Terminate</h4>
<div class="paragraph">
<p>You can terminate Smooks&#8217;s filtering before it reaches the end of a stream. The following config terminates filtering at the end of the customer fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Visitors... --&gt;</span>
    <span class="nt">&lt;core:terminate</span> <span class="na">onElement=</span><span class="s">"customer"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default behavior is to terminate at the end of the targeted fragment, on the <code>visitAfter</code> event. To terminate at the start of the targeted fragment, on the <code>visitBefore</code> event, set the <code>terminateBefore</code> attribute to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Visitors... --&gt;</span>
    <span class="nt">&lt;core:terminate</span> <span class="na">onElement=</span><span class="s">"customer"</span> <span class="na">terminateBefore=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bean_context">Bean Context</h3>
<div class="paragraph">
<p>The <em>Bean Context</em> is a container for objects which can be accessed within during a Smooks execution. One bean context is created per execution context, that is, per <code>Smooks#filterSource(...)</code> operation. Provide an <code>org.smooks.io.payload.JavaResult</code> object to <code>Smooks#filterSource(...)</code> if you want the contents of the bean context to be returned at the end of the filtering process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//Get the data to filter</span>
<span class="nc">StreamSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"data.xml"</span><span class="o">));</span>

<span class="c1">//Create a Smooks instance (cachable)</span>
<span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="s">"smooks-config.xml"</span><span class="o">);</span>

<span class="c1">//Create the JavaResult, which will contain the filter result after filtering</span>
<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="c1">//Filter the data from the source, putting the result into the JavaResult</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

<span class="c1">//Getting the Order bean which was created by the JavaBean cartridge</span>
<span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Order</span><span class="o">)</span><span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"order"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Resources like visitors access the bean context&#8217;s beans at runtime from the <code>BeanContext</code>. The <code>BeanContext</code> is retrieved from <code>ExecutionContext#getBeanContext()</code>. You should first retrieve a <code>BeanId</code> from the <code>BeanIdStore</code> when adding or retrieving objects from the <code>BeanContext</code>. A <code>BeanId</code> is a special key that ensures higher performance then <code>String</code> keys, however <code>String</code> keys are also supported. The <code>BeanIdStore</code> must be retrieved from <code>ApplicationContext#getBeanIdStore()</code>. A <code>BeanId</code> object can be created by calling <code>BeanIdStore#register(String)</code>. If you know that the <code>BeanId</code> is already registered, then you can retrieve it by calling <code>BeanIdStore#getBeanId(String)</code>. <code>BeanId</code> is scoped at the application context. You normally register it in the <code>@PostConstruct</code> annotated method of your visitor implementation and then reference it as member variable from the <code>visitBefore</code> and <code>visitAfter</code> methods.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>BeanId</code> and <code>BeanIdStore</code> are thread-safe.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="pre_installed_beans">Pre-installed Beans</h4>
<div class="paragraph">
<p>A number of pre-installed beans are available in the bean context at runtime:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/bean/context/preinstalled/UniqueID.html"><code>PUUID</code></a>: This <code>UniqueId</code> instance provides unique identifiers for the filtering <code>ExecutionContext</code>.</p>
</li>
<li>
<p><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/bean/context/preinstalled/Time.html"><code>PTIME</code></a>: This <code>Time</code> instance provides time-based data for the filtering ExecutionContext.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following are examples of how each of these would be used in a FreeMarker template.</p>
</div>
<div class="literalblock">
<div class="title">Unique ID of the ExecutionContext:</div>
<div class="content">
<pre>${PUUID.execContext}</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Random Unique ID:</div>
<div class="content">
<pre>${PUUID.random}</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Filtering start time in milliseconds:</div>
<div class="content">
<pre>${PTIME.startMillis}</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Filtering start time in nanoseconds:</div>
<div class="content">
<pre>${PTIME.startNanos}</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Filtering start date:</div>
<div class="content">
<pre>${PTIME.startDate}</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Current time in milliseconds:</div>
<div class="content">
<pre>${PTIME.nowMillis}</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Current time in nanoSeconds:</div>
<div class="content">
<pre>${PTIME.nowNanos}</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Current date:</div>
<div class="content">
<pre>${PTIME.nowDate}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="global_configurations">Global Configurations</h3>
<div class="paragraph">
<p>Global configuration settings are, as the name implies, configuration options that can be set once and be applied to all resources in a configuration.</p>
</div>
<div class="paragraph">
<p>Smooks supports two types of globals, default properties and global parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Global Configuration Parameters: Every in a Smooks configuration can specify elements for configuration parameters. These parameter values are available at runtime through the <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/resource/config/ResourceConfig.html"><code>ResourceConfig</code></a>, or are reflectively injected through the <code>@Inject</code> annotation. Global Configuration Parameters are parameters that are defined centrally (see below) and are accessible to all runtime components via the <code>ExecutionContext</code> (vs <code>ResourceConfig</code>). More on this in the following sections.</p>
</li>
<li>
<p>Default Properties: Specify default values for attributes. These defaults are automatically applied to <code>ResourceConfig</code> s  when their corresponding does not specify the attribute. More on this in the following section.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="global_configuration_parameters">Global Configuration Parameters</h4>
<div class="paragraph">
<p>Global properties differ from the default properties in that they are not specified on the root element and are not automatically applied to resources.</p>
</div>
<div class="paragraph">
<p>Global parameters are specified in a <code>&lt;params&gt;</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;params&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"xyz.param1"</span><span class="nt">&gt;</span>param1-val<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/params&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Global Configuration Parameters are accessible via the <code>ExecutionContext</code> e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">param1</span> <span class="o">=</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getConfigParameter</span><span class="o">(</span><span class="s">"xyz.param1"</span><span class="o">,</span> <span class="s">"defaultValueABC"</span><span class="o">);</span>
    <span class="o">....</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="default_properties">Default Properties</h4>
<div class="paragraph">
<p>Default properties are properties that can be set on the root element of a Smooks configuration and have them applied to all resource configurations in smooks-conf.xml file. For example, if you have a resource configuration file in which all the resource configurations have the same selector value, you could specify a <code>default-target-profile=order</code> to save specifying the profile on every resource configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">default-target-profile=</span><span class="s">"order"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resource-config&gt;</span>
        <span class="nt">&lt;resource&gt;</span>com.acme.VisitorA<span class="nt">&lt;/resource&gt;</span>
        ...
    <span class="nt">&lt;/resource-config&gt;</span>

    <span class="nt">&lt;resource-config&gt;</span>
        <span class="nt">&lt;resource&gt;</span>com.acme.VisitorB<span class="nt">&lt;/resource&gt;</span>
        ...
    <span class="nt">&lt;/resource-config&gt;</span>

<span class="nt">&lt;smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following default configuration options are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>default-target-profile*</code>: Default target profile that will be applied to all resources in the smooks configuration file, where a target-profile is not defined.</p>
</li>
<li>
<p><code>default-condition-ref</code>: Refers to a global condition by the conditions id. This condition is applied to resources that define an empty "condition" element (i.e. ) that does not reference a globally defined condition.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration_modularization">Configuration Modularization</h3>
<div class="paragraph">
<p>Smooks configurations are easily modularized through use of the <code>&lt;import&gt;</code> element. This allows you to split Smooks configurations into multiple reusable configuration files and then compose the top level configurations using the <code>&lt;import&gt;</code> element e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;import</span> <span class="na">file=</span><span class="s">"bindings/order-binding.xml"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;import</span> <span class="na">file=</span><span class="s">"templates/order-template.xml"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also inject replacement tokens into the imported configuration by using <code>&lt;param&gt;</code> sub-elements on the <code>&lt;import&gt;</code>. This allows you to make tweaks to the imported configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="c">&lt;!-- Top level configuration... --&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;import</span> <span class="na">file=</span><span class="s">"bindings/order-binding.xml"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"orderRootElement"</span><span class="nt">&gt;</span>order<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;/import&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="c">&lt;!-- Imported parameterized bindings/order-binding.xml configuration... --&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"org.acme.Order"</span> <span class="na">createOnElement=</span><span class="s">"@orderRootElement@"</span><span class="nt">&gt;</span>
        .....
    <span class="nt">&lt;/jb:bean&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how the replacement token injection points are specified using <code>@tokenname@</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="routing">Routing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A common approach to processing large/huge messages is to split them out into smaller messages that can be processed independently. Of course splitting and routing is not just a solution for processing huge
messages. It&#8217;s often needed with smaller messages as well (message size may be irrelevant) where, for example, order items in an order message need to be split out and routed (based on content - "Content Base Routing") to different departments or partners for processing. Under these conditions, the message formats required at the different destinations may also vary e.g.,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"destination1" required XML via the file system,</p>
</li>
<li>
<p>"destination2" requires Java objects via a JMS Queue,</p>
</li>
<li>
<p>"destination3" picks the messages up from a table in a database, etc&#8230;&#8203;</p>
</li>
<li>
<p>"destination4" requires EDI messages via a JMS Queue,</p>
</li>
<li>
<p>etc etc</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With Smooks, all of the above is possible. You can perform multiple splitting and routing operations to multiple destinations (of different types) in a single pass over a message.</p>
</div>
<div class="paragraph">
<p>The basic concept is simple. As you stream the message through Smooks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Repeatedly create a standalone message (split) for the fragment to be routed.</p>
</li>
<li>
<p>Repeatedly bind the split message into the bean context under a unique beanId.</p>
</li>
<li>
<p>Repeatedly route the split message to the required endpoint (File, DB, JMS, ESB).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We emphasize "Repeatedly" (above) so as to reinforce the point that these operations happen for each instance of the split message found in the source message e.g. for each in an message.</p>
</div>
<div class="paragraph">
<p>As for points #1 and #2 above specifically, Smooks offers two approaches to creating the split messages:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A basic (untransformed/unenriched) fragment split and bind. This is a very simple configuration that simply serializes a message fragment (repeatedly) to its XML form and stores it in the bean context as a String.</p>
</li>
<li>
<p>A more complex approach using the Java Binding and Templating Cartridges, where you configure Smooks to extract data from the source message and into the bean context (using configs) and then (optionally) apply templates to create the split messages. This is more complex, but offers the following advantages:</p>
<div class="ulist">
<ul>
<li>
<p>Allows for transformation of the split fragments i.e. not just XML as with the basic option.</p>
</li>
<li>
<p>Allows for enrichment of the message.</p>
</li>
<li>
<p>Allows for more complex splits, with the ability to merge data from multiple source fragments into each split message e.g. not just the fragments, but the order info too.</p>
</li>
<li>
<p>Allows for splitting and routing of Java Objects as the Split messages (e.g., over JMS).</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>With the more complex approach outlined above, the key to processing huge messages (not an issue for the more basic approach) is to make sure that you always maintain a small memory footprint. You can do this using the JavaBean Cartridge by making sure you&#8217;re only binding the most relevant message data (into the bean context) at any one time. In the following sections, the examples are all based on splitting and routing of order-items out of an order message. The solutions shown all work for huge messages because the Smooks JavaBean Cartridge binding configurations are implemented such that the only data held in memory at any given time is the main order details (order header etc&#8230;&#8203;), and the  "current" order item details.</p>
</div>
<div class="sect2">
<h3 id="basic_splitting_and_routing">Basic Splitting and Routing</h3>
<div class="paragraph">
<p>As stated above, the easiest way to split and route fragments of a message is to use the basic <code>&lt;frag:serialize&gt;</code> and <em>&lt;*:router&gt;</em> components (<code>&lt;jms:router&gt;</code>, <code>&lt;file:router&gt;</code>, etc&#8230;&#8203;) from the Routing Cartridge. The <code>&lt;frag:serialize&gt;</code> component has its own configuration in the <code>https://www.smooks.org/xsd/smooks/fragment-routing-1.5.xsd</code> namespace.</p>
</div>
<div class="paragraph">
<p>The following is an example for serializing the contents of a SOAP message body and storing it in the Bean Context under the beanId of <code>soapBody</code>:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:frag=</span><span class="s">"https://www.smooks.org/xsd/smooks/fragment-routing-1.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;frag:serialize</span> <span class="na">fragment=</span><span class="s">"Envelope/Body"</span> <span class="na">bindTo=</span><span class="s">"soapBody"</span> <span class="na">childContentOnly=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the Smooks code for executing this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">configStream</span><span class="o">);</span>
<span class="nc">JavaResult</span> <span class="n">javaResult</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">soapMessageStream</span><span class="o">),</span> <span class="n">javaResult</span><span class="o">);</span>

<span class="nc">String</span> <span class="n">bodyContent</span> <span class="o">=</span> <span class="n">javaResult</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"soapBody"</span><span class="o">).</span><span class="na">toString</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And of course, you can do all of this programmatically too (i.e., no need for the XML config):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">addVisitor</span><span class="o">(</span><span class="k">new</span> <span class="nc">FragmentSerializer</span><span class="o">().</span><span class="na">setBindTo</span><span class="o">(</span><span class="s">"soapBody"</span><span class="o">),</span> <span class="s">"Envelope/Body"</span><span class="o">);</span>

<span class="nc">JavaResult</span> <span class="n">javaResult</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">soapMessageStream</span><span class="o">),</span> <span class="n">javaResult</span><span class="o">);</span>

<span class="nc">String</span> <span class="n">bodyContent</span> <span class="o">=</span> <span class="n">javaResult</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"soapBody"</span><span class="o">).</span><span class="na">toString</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code snippets above only show how to create the split messages and bind them into the bean context, from where they can be accessed. How about routing these split messages to another endpoint for processing?Well it&#8217;s easy, just use one of the routing components as outlined in the following sections.</p>
</div>
<div class="paragraph">
<p>The following is a quick example, showing the config for routing split messages (this time fragments) to a JMS Destination for processing:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:frag=</span><span class="s">"https://www.smooks.org/xsd/smooks/fragment-routing-1.5.xsd"</span> <span class="na">xmlns:jms=</span><span class="s">"https://www.smooks.org/xsd/smooks/jms-routing-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Create the split messages for the order items... --&gt;</span>
    <span class="nt">&lt;frag:serialize</span> <span class="na">fragment=</span><span class="s">"order-items/order-item"</span> <span class="na">bindTo=</span><span class="s">"orderItem"</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Route each order items split mesage to the orderItem JMS processing queue... --&gt;</span>
    <span class="nt">&lt;jms:router</span> <span class="na">routeOnElement=</span><span class="s">"order-items/order-item"</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">destination=</span><span class="s">"orderItemProcessingQueue"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details on the JMS routing aspects of the above example, see the JMS Router documentation (below). The &lt;jms:router&gt; could be substituted for any of the other routers e.g. if using with JBoss ESB, you could use the <code>&lt;esbr:routeBean&gt;</code> configuration to route the split message to any ESB endpoint.</p>
</div>
</div>
<div class="sect2">
<h3 id="file">File</h3>
<div class="paragraph">
<p>File based routing is performed via the <code>&lt;file:outputStream&gt;</code> configuration from the
<code>https://www.smooks.org/xsd/smooks/file-routing-2.0.xsd</code> configuration namespace.</p>
</div>
<div class="paragraph">
<p>This section illustrates how you can combine the following Smooks functionality to split a message out into smaller messages on the file system.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Javabean cartridge for extracting data from the message and holding it in variables in the bean context. In this case, we could also use DOM NodeModels for capturing the order and order-item data to be used as the templating data models.</p>
</li>
<li>
<p>The <code>&lt;file:outputStream&gt;</code> configuration from the routing cartridge for managing file system streams (naming, opening, closing, throttling creation, etc&#8230;&#8203;).</p>
</li>
<li>
<p>The templating cartridge (FreeMarker Templates) for generating the individual split messages from data bound in the bean context by the JavaBean cartridge (see #1 above). The templating result is written to the file output stream (#2 above).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the example, we want to process a huge order message and route the individual order item details to file. The following illustrates what we want to achieve. As you can see, the split messages don&#8217;t just contain data from the order item fragments. They also contain data from the order header and root elements.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks-routing-cartridge/master/docs/images/File-split-required.png" alt="Image:file-split-required.png"></span></p>
</div>
<div class="paragraph">
<p>To achieve this with Smooks, we assemble the following Smooks configuration:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span>
                      <span class="na">xmlns:file=</span><span class="s">"https://www.smooks.org/xsd/smooks/file-routing-2.0.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span><span class="nt">&gt;</span>

        <span class="c">&lt;!-- Extract and decode data from the message. Used in the freemarker template (below).
             Note that we could also use a NodeModel here... --&gt;</span>
(1)     <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"java.util.Hashtable"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"orderId"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order/@id"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerNumber"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"header/customer/@number"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerName"</span> <span class="na">data=</span><span class="s">"header/customer"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"orderItem"</span> <span class="na">beanIdRef=</span><span class="s">"orderItem"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/jb:bean&gt;</span>
(2)     <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">class=</span><span class="s">"java.util.Hashtable"</span> <span class="na">createOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"itemId"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order-item/@id"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productId"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"order-item/product"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order-item/quantity"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"Double"</span> <span class="na">data=</span><span class="s">"order-item/price"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/jb:bean&gt;</span>

        <span class="c">&lt;!-- Create/open a file output stream. This is writen to by the freemarker template (below).. --&gt;</span>
(3)     <span class="nt">&lt;file:outputStream</span> <span class="na">openOnElement=</span><span class="s">"order-item"</span> <span class="na">resourceName=</span><span class="s">"orderItemSplitStream"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;file:fileNamePattern&gt;</span>order-${order.orderId}-${order.orderItem.itemId}.xml<span class="nt">&lt;/file:fileNamePattern&gt;</span>
            <span class="nt">&lt;file:destinationDirectoryPattern&gt;</span>target/orders<span class="nt">&lt;/file:destinationDirectoryPattern&gt;</span>
            <span class="nt">&lt;file:listFileNamePattern&gt;</span>order-${order.orderId}.lst<span class="nt">&lt;/file:listFileNamePattern&gt;</span>

            <span class="nt">&lt;file:highWaterMark</span> <span class="na">mark=</span><span class="s">"10"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/file:outputStream&gt;</span>

        <span class="c">&lt;!--
         Every time we hit the end of an &lt;order-item&gt; element, apply this freemarker template,
         outputting the result to the "orderItemSplitStream" OutputStream, which is the file
         output stream configured above.
        --&gt;</span>
(4)     <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ftl:template&gt;</span>target/classes/orderitem-split.ftl<span class="nt">&lt;/ftl:template&gt;</span>
            <span class="nt">&lt;ftl:use&gt;</span>
                <span class="c">&lt;!-- Output the templating result to the "orderItemSplitStream" file output stream... --&gt;</span>
                <span class="nt">&lt;ftl:outputTo</span> <span class="na">outputStreamResource=</span><span class="s">"orderItemSplitStream"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/ftl:use&gt;</span>
        <span class="nt">&lt;/ftl:freemarker&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Smooks Resource configuration #1 and #2 define the Java Bindings for extracting the order header information (config #1) and the order-item information (config #2). This is the key to processing a huge message; making sure that we only have the current order item in memory at any one time. The Smooks Javabean Cartridge manages all this for you, creating and recreating the orderItem beans as the fragments are being processed.</p>
</div>
<div class="paragraph">
<p>The <code>&lt;file:outputStream&gt;</code> configuration in configuration #3 manages the generation of the files on the file system. As you can see from the configuration, the file names can be dynamically constructed from data in the bean context. You can also see that it can throttle the creation of the files via the <code>highWaterMark</code> configuration parameter. This helps you manage file creation so as not to overwhelm the target file system.</p>
</div>
<div class="paragraph">
<p>Smooks Resource configuration #4 defines the FreeMarker templating resource used to write the split messages to the OutputStream created by the <code>file:outputStream</code> (config #3). See how config #4 references the <code>file:outputStream</code> resource. The Freemarker template is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>&lt;orderitem id="${.vars["order-item"].@id}" order="${order.@id}"&gt;
    &lt;customer&gt;
        &lt;name&gt;${order.header.customer}&lt;/name&gt;
        &lt;number&gt;${order.header.customer.@number}&lt;/number&gt;
    &lt;/customer&gt;
    &lt;details&gt;
        &lt;productId&gt;${.vars["order-item"].product}&lt;/productId&gt;
        &lt;quantity&gt;${.vars["order-item"].quantity}&lt;/quantity&gt;
        &lt;price&gt;${.vars["order-item"].price}&lt;/price&gt;
    &lt;/details&gt;
&lt;/orderitem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jms">JMS</h3>
<div class="paragraph">
<p>JMS routing is performed via the <code>&lt;jms:router&gt;</code> configuration from the <code>https://www.smooks.org/xsd/smooks/jms-routing-2.0.xsd</code> configuration namespace.</p>
</div>
<div class="paragraph">
<p>The following is an example <code>&lt;jms:router&gt;</code> configuration that routes an <code>orderItem_xml</code> bean to a JMS Queue named <code>smooks.exampleQueue</code> (also read the "Routing to File" example):</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:jms=</span><span class="s">"https://www.smooks.org/xsd/smooks/jms-routing-2.0.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span><span class="nt">&gt;</span>

(1)     <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"order,order-item"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;resource&gt;</span>org.smooks.engine.resource.visitor.dom.DomModelCreator<span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;/resource-config&gt;</span>

(2)     <span class="nt">&lt;jms:router</span> <span class="na">routeOnElement=</span><span class="s">"order-item"</span> <span class="na">beanId=</span><span class="s">"orderItem_xml"</span> <span class="na">destination=</span><span class="s">"smooks.exampleQueue"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;jms:message&gt;</span>
                <span class="c">&lt;!-- Need to use special FreeMarker variable ".vars" --&gt;</span>
                <span class="nt">&lt;jms:correlationIdPattern&gt;</span>${order.@id}-${.vars["order-item"].@id}<span class="nt">&lt;/jms:correlationIdPattern&gt;</span>
            <span class="nt">&lt;/jms:message&gt;</span>
            <span class="nt">&lt;jms:highWaterMark</span> <span class="na">mark=</span><span class="s">"3"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/jms:router&gt;</span>

(3)     <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--
             Note in the template that we need to use the special FreeMarker variable ".vars"
             because of the hyphenated variable names ("order-item"). See http://freemarker.org/docs/ref_specvar.html.
            --&gt;</span>
            <span class="nt">&lt;ftl:template&gt;</span>/orderitem-split.ftl<span class="nt">&lt;/ftl:template&gt;</span>
            <span class="nt">&lt;ftl:use&gt;</span>
                <span class="c">&lt;!-- Bind the templating result into the bean context, from where
                     it can be accessed by the JMSRouter (configured above). --&gt;</span>
                <span class="nt">&lt;ftl:bindTo</span> <span class="na">id=</span><span class="s">"orderItem_xml"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/ftl:use&gt;</span>
        <span class="nt">&lt;/ftl:freemarker&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, we route the result of a FreeMarker templating operation to the JMS Queue (i.e. as a String). We could also have routed a full Object Model, in which case it would be routed as a Serialized ObjectMessage.</p>
</div>
</div>
<div class="sect2">
<h3 id="apache_camel">Apache Camel</h3>
<div class="paragraph">
<p>It is possible to route fragments to Apache Camel endpoints using the <code>&lt;camel:route&gt;</code> configuration from the <code>https://www.smooks.org/xsd/smooks/camel-1.5.xsd</code> configuration namespace.</p>
</div>
<div class="paragraph">
<p>For example, you can route to Camel endpoint by specifying the following in your Smooks configuration:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:camel=</span><span class="s">"https://www.smooks.org/xsd/smooks/camel-1.5.xsd"</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- Create some bean instances from the input source... --&gt;</span>
  <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span>  <span class="err">...</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- etc... See Smooks Java Binding docs --&gt;</span>
  <span class="nt">&lt;/jb:bean&gt;</span>

  <span class="c">&lt;!-- Route bean to camel endpoints... --&gt;</span>
  <span class="nt">&lt;camel:route</span> <span class="na">beanid=</span><span class="s">"orderItem"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;camel:to</span> <span class="na">endpoint=</span><span class="s">"direct:slow"</span> <span class="na">if=</span><span class="s">"orderItem.priority == 'Normal'"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;camel:to</span> <span class="na">endpoint=</span><span class="s">"direct:express"</span> <span class="na">if=</span><span class="s">"orderItem.priority == 'High'"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/camel:route&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, we route Java Beans from Smooks&#8217;s <code>BeanContext</code> to the Camel Endpoints. Note that you can also apply templates (e.g., FreeMarker) to these same beans and route the templating result instead of beans (e.g., as XML, CSV or other).</p>
</div>
<div class="paragraph">
<p>The above configuration shows routing using the <code>beanId</code> attribute. It is also possible to route using an attribute named <code>routeOnElement</code>.</p>
</div>
<div class="sect4">
<h5 id="apache_camel_integration">Apache Camel Integration</h5>
<div class="paragraph">
<p>Integrating Smooks from Apache Camel lets you to access all the features of Smooks from within Camel. You can take an existing Smooks configuration and use this in your Camel routes using one of the options that are described in this chapter.</p>
</div>
<div class="paragraph">
<p>Using Smooks in Camel can be done in three ways:</p>
</div>
<div class="sect5">
<h6 id="smookscomponent">SmooksComponent</h6>
<div class="paragraph">
<p>The <code>SmooksComponent</code> is a Camel <a href="https://camel.apache.org/component.html">Component</a> which can used when  you want to process the Camel Message Body using Smooks. You can do this by adding a route in your Camel route configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">from</span><span class="o">(</span><span class="s">"file://inputDir?noop=true"</span><span class="o">)</span>
<span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"smooks://smooks-config.xml"</span><span class="o">)</span>
<span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"jms:queue:order"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Smooks Component is configured with a mandatory configuration file, which is <em>smooks-config-xml</em> in the example above. By just looking at the above route definition it is not clear what type of output that the SmooksComponent is producing. This is actually expressed in the Smooks configuration using the <a href="https://www.smooks.org/v2/documentation/#exporting_results">exports</a> element.</p>
</div>
<div class="paragraph">
<p>If you prefer/require programmatic configuration of Smooks you can use the <a href="#smooksprocessor"><code>SmooksProcessor</code></a> to achieve this.</p>
</div>
<div class="sect6">
<h7 id="options">Options</h7>
<div class="paragraph">
<p>An Apache Component can take options that are specified after the Smooks configuration file. Currently only one option is available for the SmooksComponent:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>reportPath</code> which is path (including the file name) to the Smooks Execution Report to be generated.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect5">
<h6 id="smooksdataformat">SmooksDataFormat</h6>
<div class="paragraph">
<p><code>SmooksDataFormat</code> is a Camel DataFormat which is capable of transforming from one data format to another and back again. You would use this when you are only interested in transforming from one format to another and not interested in other Smooks features.</p>
</div>
<div class="paragraph">
<p>Below is an example of using <code>SmooksDataFormat</code> to transform a comma separated value string into a <code>java.util.List</code> of Customer object instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">SmooksDataFormat</span> <span class="n">sdf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SmooksDataFormat</span><span class="o">(</span><span class="s">"csv-smooks-unmarshal-config.xml"</span><span class="o">);</span>
<span class="n">from</span><span class="o">(</span><span class="s">"direct:unmarshal"</span><span class="o">)</span>
<span class="o">.</span><span class="na">unmarshal</span><span class="o">(</span><span class="n">sdf</span><span class="o">)</span>
<span class="o">.</span><span class="na">convertBodyTo</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"mock:result"</span><span class="o">);</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="smooksprocessor">SmooksProcessor</h6>
<div class="paragraph">
<p>Using <code>SmooksProcessor</code> gives you full control over Smooks, for example if you want to programatically create the underlying Smooks instance you’d use <code>SmooksProcessor</code>. When using <code>SmooksProcessor</code>, you can pass a Smooks instance to its constructor and prior to that programmatically configure Smooks.</p>
</div>
<div class="paragraph">
<p>Below is an example of using the <code>SmooksProcessor</code> in a Camel route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="s">"edi-to-xml-smooks-config.xml"</span><span class="o">);</span>
<span class="nc">ExecutionContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">smooks</span><span class="o">.</span><span class="na">createExecutionContext</span><span class="o">();</span>
<span class="o">...</span>
<span class="nc">SmooksProcessor</span> <span class="n">processor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SmooksProcessor</span><span class="o">(</span><span class="n">smooks</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>

<span class="n">from</span><span class="o">(</span><span class="s">"file://input?noop=true"</span><span class="o">)</span>
<span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">processor</span><span class="o">)</span>
<span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"mock:result"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to the <code>SmooksComponent</code> we have not specified the result type that Smooks produces (if any that is). Instead this is expressed in the Smooks configuration using the <a href="https://www.smooks.org/v2/documentation/#exporting_results">exports</a> element, or you can do the same programmatically like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>
<span class="nc">ExecutionContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">smooks</span><span class="o">.</span><span class="na">createExecutionContext</span><span class="o">();</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">setExports</span><span class="o">(</span><span class="k">new</span> <span class="nc">Exports</span><span class="o">(</span><span class="nc">StringResult</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
<span class="nc">SmooksProcessor</span> <span class="n">processor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SmooksProcessor</span><span class="o">(</span><span class="n">smooks</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
<span class="o">...</span>
<span class="n">from</span><span class="o">(</span><span class="s">"file://input?noop=true"</span><span class="o">)</span>
<span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">processor</span><span class="o">)</span>
<span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"mock:result"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
See the <a href="https://github.com/smooks/smooks-examples/tree/v1.0.5/camel">Apache Camel examples</a> in the examples page.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="maven_coordinates">Maven Coordinates</h5>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-camel-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exporting_results">Exporting Results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using Smooks standalone you are in full control of the type of output that Smooks produces since you specify it by passing a certain Result to the filter method. But when integrating Smooks with other frameworks (JBossESB, Mule, Camel, and others) this needs to be specified inside the framework&#8217;s configuration. Starting with version 1.4 of Smooks you can now declare the data types that Smooks produces and you can use the Smooks api to retrieve the Result(s) that Smooks exports.</p>
</div>
<div class="paragraph">
<p>To declare the type of result that Smooks produces you use the 'exports' element as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span> <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;core:exports&gt;</span>
      <span class="nt">&lt;core:result</span> <span class="na">type=</span><span class="s">"org.smooks.io.payload.JavaResult"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/core:exports&gt;</span>
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The newly added exports element declares the results that are produced by this Smooks configuration. A exports element can contain one or more result elements. A framework that uses Smooks could then perform filtering like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Get the Exported types that were configured.</span>
<span class="nc">Exports</span> <span class="n">exports</span> <span class="o">=</span> <span class="nc">Exports</span><span class="o">.</span><span class="na">getExports</span><span class="o">(</span><span class="n">smooks</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">());</span>
<span class="k">if</span> <span class="o">(</span><span class="n">exports</span><span class="o">.</span><span class="na">hasExports</span><span class="o">())</span>
<span class="o">{</span>
    <span class="c1">// Create the instances of the Result types.</span>
    <span class="c1">// (Only the types, i.e the Class type are declared in the 'type' attribute.</span>
    <span class="nc">Result</span><span class="o">[]</span> <span class="n">results</span> <span class="o">=</span> <span class="n">exports</span><span class="o">.</span><span class="na">createResults</span><span class="o">();</span>
    <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span> <span class="n">getSource</span><span class="o">(</span><span class="n">exchange</span><span class="o">),</span> <span class="n">results</span><span class="o">);</span>
    <span class="c1">// The Results(s) will now be populate by Smooks filtering process and</span>
    <span class="c1">// available to the framework in question.</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There might also be cases where you only want a portion of the result extracted and returned. You can use the ‘extract’ attribute to specify this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;core:exports&gt;</span>
      <span class="nt">&lt;core:result</span> <span class="na">type=</span><span class="s">"org.smooks.io.payload.JavaResult"</span> <span class="na">extract=</span><span class="s">"orderBean"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/core:exports&gt;</span>
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The extract attribute is intended to be used when you are only interested in a sub-section of a produced result. In the example above we are saying that we only want the object named orderBean to be exported. The other contents of the JavaResult will be ignored. Another example where you might want to use this kind of extracting could be when you only want a ValidationResult of a certain type, for example to only return validation errors.</p>
</div>
<div class="paragraph">
<p>Below is an example of using the extracts option from an embedded framework:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Get the Exported types that were configured.</span>
<span class="nc">Exports</span> <span class="n">exports</span> <span class="o">=</span> <span class="nc">Exports</span><span class="o">.</span><span class="na">getExports</span><span class="o">(</span><span class="n">smooks</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">());</span>
<span class="k">if</span> <span class="o">(</span><span class="n">exports</span><span class="o">.</span><span class="na">hasExports</span><span class="o">())</span>
<span class="o">{</span>
    <span class="c1">// Create the instances of the Result types.</span>
    <span class="c1">// (Only the types, i.e the Class type are declared in the 'type' attribute.</span>
    <span class="nc">Result</span><span class="o">[]</span> <span class="n">results</span> <span class="o">=</span> <span class="n">exports</span><span class="o">.</span><span class="na">createResults</span><span class="o">();</span>
    <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span> <span class="n">getSource</span><span class="o">(</span><span class="n">exchange</span><span class="o">),</span> <span class="n">results</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="n">objects</span> <span class="o">=</span> <span class="nc">Exports</span><span class="o">.</span><span class="na">extractResults</span><span class="o">(</span><span class="n">results</span><span class="o">,</span> <span class="n">exports</span><span class="o">);</span>
    <span class="c1">// Now make the object available to the framework that this code is running:</span>
    <span class="c1">// Camel, JBossESB, Mule, etc...</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="performance_tuning">Performance Tuning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like with any Software, when configured or used incorrectly, performance can be one of the first things to suffer. Smooks is no different in this regard.</p>
</div>
<div class="sect2">
<h3 id="general">General</h3>
<div class="ulist">
<ul>
<li>
<p>Cache and reuse the Smooks Object. Initialization of Smooks takes some time and therefore it is important that it is reused.</p>
</li>
<li>
<p><strong><a href="#user-content-settings">Pool reader instances</a></strong> where possible. This can result in a huge performance boost, as some readers are very expensive to create.</p>
</li>
<li>
<p>If possible, use <a href="#filter-settings">SAX NG filtering</a>. However, you need to check that all Smooks cartridges in use are SAX NG compatible. SAX NG processing is faster than DOM processing and has a consistently small memory footprint. It is especially recommended for processing large messages. See the <a href="#filtering-process-selection-dom-or-sax">Filtering Process Selection (DOM or SAX?)</a> section. SAX NG is the default filter since Smooks 2.</p>
</li>
<li>
<p>Turn off debug logging. Smooks performs some intensive debug logging in parts of the code. This can result in significant additional processing overhead and lower throughput. Also remember that NOT having your logging configured (at all) may result in debug log statements being executed!!</p>
</li>
<li>
<p><strong>Contextual selectors</strong> can obviously have a negative effect on performance e.g. evaluating a match for a selector like "a/b/c/d/e" will obviously require more processing than that of a selector like "d/e". Obviously there will be situations where your data model will require deep selectors, but where it does not, you should try to optimize them for the sake of performance.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="smooks_cartridges">Smooks Cartridges</h3>
<div class="paragraph">
<p>Every cartridge can have its own performance optimization tips.</p>
</div>
</div>
<div class="sect2">
<h3 id="javabean_cartridge">Javabean Cartridge</h3>
<div class="ulist">
<ul>
<li>
<p>If possible don&#8217;t use the Virtual Bean Model. Create Beans instead of maps. Creating and adding data to Maps is a lot slower then creating simple POJO&#8217;s and calling the setter methods.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">Testing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="unit_testing">Unit Testing</h3>
<div class="paragraph">
<p>Unit testing with Smooks is simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyMessageTransformTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_transform</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"smooks-config.xml"</span><span class="o">));</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Source</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"input-message.xml"</span> <span class="o">)</span> <span class="o">);</span>
            <span class="nc">StringResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringResult</span><span class="o">();</span>

            <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

            <span class="c1">// compare the expected xml with the transformation result.</span>
            <span class="nc">XMLUnit</span><span class="o">.</span><span class="na">setIgnoreWhitespace</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="nc">XMLAssert</span><span class="o">.</span><span class="na">assertXMLEqual</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"expected.xml"</span><span class="o">)),</span> <span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getResult</span><span class="o">()));</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">smooks</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The test case above uses <a href="https://www.xmlunit.org/">XMLUnit</a>.</p>
</div>
<div class="paragraph">
<p>The following maven dependency was used for xmlunit in the above test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>xmlunit<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>xmlunit<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="extending_smooks">Extending Smooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All existing Smooks functionality (Java Binding, EDI processing, etc&#8230;&#8203;) is built through extension of a number of well-defined APIs. We will look at these APIs in the coming sections.</p>
</div>
<div class="paragraph">
<p>The main extension points/APIs in Smooks are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Reader APIs</strong>: Those for processing Source/Input data (Readers) so as to make it consumable by other Smooks components as a series of well defined hierarchical events (based on the SAX event model) for all of the message fragments and sub-fragments.</p>
</li>
<li>
<p><strong>Visitor APIs</strong>: Those for consuming the message fragment SAX events produced by a source/input reader.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Another very important aspect of writing Smooks extensions is how these components are configured. Because this is common to all Smooks components, we will look at this first.</p>
</div>
<div class="sect2">
<h3 id="configuring_smooks_components">Configuring Smooks Components</h3>
<div class="paragraph">
<p>All Smooks components are configured in exactly the same way. As far as the Smooks Core code is concerned, all Smooks components are "resources" and are configured via a ResourceConfig instance, which we talked about in earlier sections.</p>
</div>
<div class="paragraph">
<p>Smooks provides mechanisms for constructing namespace (XSD) specific XML configurations for components, but the most basic configuration (and the one that maps directly to the ResourceConfig class) is the basic XML configuration from the base configuration namespace (<a href="https://www.smooks.org/xsd/smooks-2.0.xsd">https://www.smooks.org/xsd/smooks-2.0.xsd</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;resource&gt;&lt;/resource&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">""</span><span class="nt">&gt;&lt;/param&gt;</span>
    <span class="nt">&lt;/resource-config&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>selector</code> attribute is the mechanism by which the resource is "selected" e.g. can be an XPath for a visitor. We&#8217;ll see more of this in the coming sections.</p>
</li>
<li>
<p>The <code>resource</code> element is the actual resource. This can be a Java Class name or some other form of resource (such as a template). For the purposes of this section however, lets just assume the resource to by a Java Class name.</p>
</li>
<li>
<p>The <code>param</code> elements are configuration parameters for the resource defined in the resource element.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Smooks takes care of all the details of creating the runtime representation of the resource (e.g. constructing the class named in the resource element) and injecting all the configuration parameters. It also works out what the resource type is, and from that, how to interpret things like the selector e.g., if the resource is a visitor instance, it knows the selector is an XPath, selecting a Source message fragment.</p>
</div>
<div class="sect3">
<h4 id="configuration_annotations">Configuration Annotations</h4>
<div class="paragraph">
<p>After your component has been created, you need to configure it with the element details. This is done using the <code>@Inject</code> annotation.</p>
</div>
<div class="sect4">
<h5 id="inject">@Inject</h5>
<div class="paragraph">
<p>The <em>Inject</em> annotation reflectively injects the named parameter (from the elements) having the same name as the annotated property itself (the name can actually be different, but by default, it matches against the name of the component property).</p>
</div>
<div class="paragraph">
<p>Suppose we have a component as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSeeder</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">File</span> <span class="n">seedDataFile</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">File</span> <span class="nf">getSeedDataFile</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">seedDataFile</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// etc...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We configure this component in Smooks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"dataSeeder"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;resource&gt;</span>com.acme.DataSeeder<span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"seedDataFile"</span><span class="nt">&gt;</span>./seedData.xml<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;/resource-config&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This annotation eliminates a lot of noisy code from your component because it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Handles decoding of the value before setting it on the annotated component property. Smooks provides type converters for all the main types (Integer, Double, File, Enums, etc&#8230;&#8203;), but you can implement and use a custom TypeConverter where the out-of-the-box converters don&#8217;t cover specific decoding requirements. Smooks will automatically use your custom converter if it is registered. See the TypeConverter Javadocs for details on registering a TypeConverter implementation such that Smooks will automatically locate it for converting a specific data type.</p>
</li>
<li>
<p>Supports enum constraints for the injected property, generating a configuration exception where the configured value is not one of the defined choice values. For example, you may have a property which has a constrained value set of "ON" and "OFF". You can use an enum for the property type to constrain the value, raise exceptions, etc&#8230;&#8203;:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Inject</span>
<span class="kd">private</span> <span class="nc">OnOffEnum</span> <span class="n">foo</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Can specify default property values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Inject</span>
<span class="kd">private</span> <span class="nc">Boolean</span> <span class="n">foo</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Can specify whether the property is optional:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Inject</span>
<span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Optional</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">foo</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, all properties are required but setting a default implicitly marks the property as being optional.</p>
</div>
</div>
<div class="sect4">
<h5 id="postconstruct_and_predestroy">@PostConstruct and @PreDestroy</h5>
<div class="paragraph">
<p>The <em>Inject</em> annotation is great for configuring your component with simple values, but sometimes your component needs more involved configuration for which we need to write some "initialization" code. For this, Smooks provides <code>@PostConstruct</code>.</p>
</div>
<div class="paragraph">
<p>On the other side of this, there are times when we need to undo work performed during initialization when the associated Smooks instance is being discarded (garbage collected) e.g. to release some resources acquired during initialization, etc&#8230;&#8203; For this, Smooks provides the <code>@PreDestroy</code>.</p>
</div>
<div class="paragraph">
<p>The basic initialization/un-initialization sequence can be described as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(..);</span>

    <span class="c1">// Initialize all annotated components</span>
    <span class="nd">@PostConstruct</span>

        <span class="c1">// Use the smooks instance through a series of filterSource invocations...</span>
        <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(...);</span>
        <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(...);</span>
        <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(...);</span>
        <span class="o">...</span> <span class="n">etc</span> <span class="o">...</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="c1">// Uninitialize all annotated components</span>
    <span class="nd">@PreDestroy</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, lets assume we have a component that opens multiple connections to a database on initialization and then needs to release all those database resources when we close the Smooks instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiDataSourceAccessor</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">File</span> <span class="n">dataSourceConfig</span><span class="o">;</span>

    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Datasource</span><span class="o">&gt;</span> <span class="n">datasources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Datasource</span><span class="o">&gt;();</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createDataSources</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Add DS creation code here....</span>
        <span class="c1">// Read the dataSourceConfig property to read the DS configs...</span>
    <span class="o">}</span>

    <span class="nd">@PreDestroy</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">releaseDataSources</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Add DS release code here....</span>
    <span class="o">}</span>

    <span class="c1">// etc...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Notes</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@PostConstruct</code> and <code>@PreDestroy</code> methods must be public, zero-arg methods.</p>
</li>
<li>
<p><code>@Inject</code> properties are all initialized before the first <code>@PostConstruct</code> method is called. Therefore, you can use <code>@Inject</code> component properties as input to the initialization process.</p>
</li>
<li>
<p><code>@PreDestroy</code> methods are all called in response to a call to the <code>Smooks.close</code> method.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="defining_custom_configuration_namespaces">Defining Custom Configuration Namespaces</h4>
<div class="paragraph">
<p>Smooks supports a mechanism for defining custom configuration namespaces for components. This allows you to support custom, XSD based (validatable), configurations for your components Vs treating them all as vanilla Smooks resources via the base configuration.</p>
</div>
<div class="paragraph">
<p>The basic process involves:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Writing an configuration XSD for your component that extends the base <a href="https://www.smooks.org/xsd/smooks-2.0.xsd">https://www.smooks.org/xsd/smooks-2.0.xsd</a> configuration namespace. This XSD must be supplied on the classpath with your component. It must be located in the <em>/META-INF</em> folder and have the same path as the namespace URI. For example, if your extended namespace URI is  <a href="http://www.acme.com/schemas/smooks/acme-core-1.0.xsd" class="bare">http://www.acme.com/schemas/smooks/acme-core-1.0.xsd</a>, then the physical XSD file must be supplied on the classpath in "/META-INF/schemas/smooks/acme-core-1.0.xsd".</p>
</li>
<li>
<p>Writing a Smooks configuration namespace mapping configuration file that maps the custom namespace configuration into a <code>ResourceConfig</code> instance. This file must be named (by convention) based on the name of the namespace it is mapping and must be physically located on the classpath in the same folder as the XSD. Extending the above example, the Smooks mapping file would be "/META-INF/schemas/smooks/acme-core-1.0.xsd-smooks.xml". Note the "-smooks.xml" postfix.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The easiest way to get familiar with this mechanism is by looking at existing extended namespace configurations within the Smooks code itself. All Smooks components (including e.g. the Java Binding functionality) use this mechanism for defining their configurations. Smooks Core itself defines a number of extended configuration namesaces, <a href="https://github.com/smooks/smooks/tree/v2.0.0-RC4/core/src/main/resources/META-INF/xsd">as can be seen in the source</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementing_a_source_reader">Implementing a Source Reader</h3>
<div class="paragraph">
<p>Implementing and configuring a new Source Reader for Smooks is straightforward. The Smooks specific parts of the process are easy and are not really the issue. The level of effort involved is a function of the complexity of the Source data format for which you are implementing the reader.</p>
</div>
<div class="paragraph">
<p>Implementing a Reader for your custom data format immediately opens all Smooks capabilities to that data format e.g. Java Binding, Templating, Persistence, Validation, Splitting &amp; Routing, etc&#8230;&#8203; So a relatively small investment can yield a quite significant return. The only requirement, from a Smooks perspective, is that the Reader implements the standard <code>org.xml.sax.XMLReader</code> interface from the Java JDK. However, if you want to be able to configure the Reader implementation, it needs to implement the <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/resource/reader/SmooksXMLReader.html"><code>org.smooks.api.resource.reader.SmooksXMLReader</code></a> interface (which is just an extension of <code>org.xml.sax.XMLReader</code>). So, you can easily use (or extend) an existing <code>org.xml.sax.XMLReader</code> implementation, or implement a new Reader from scratch.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now look at a simple example of implementing a Reader for use with Smooks. In this example, we will implement a Reader that can read a stream of Comma Separated Value (CSV) records, converting the CSV stream into a stream of SAX events that can be processed by Smooks, allowing you to do all the things Smooks allows (Java Binding, etc&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>We start by implementing the basic Reader class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCSVReader</span> <span class="kd">implements</span> <span class="nc">SmooksXMLReader</span> <span class="o">{</span>

    <span class="c1">// Implement all of the XMLReader methods...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Two methods from the <code>XMLReader</code> interface are of particular interest:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>setContentHandler(ContentHandler)</strong>: This method is called by Smooks Core. It sets the <a href="https://docs.oracle.com/javase/8/docs/api/org/xml/sax/ContentHandler.html"><code>ContentHandler</code></a> instance for the reader. The <code>ContentHandler</code> instance methods are called from inside the <em>parse(InputSource)</em> method.</p>
</li>
<li>
<p><strong>parse(InputSource)</strong>: This is the method that receives the Source data input stream, parses it (i.e. in the case of this example, the CSV stream) and generates the SAX event stream through calls to the <code>ContentHandler</code> instance supplied in the <code>setContentHandler(ContentHandler)</code> method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We need to configure our CSV reader with the names of the fields associated with the CSV records. Configuring a custom reader implementation is the same as for any Smooks component, as described in the <a href="#configuring-smooks-components">Configuring Smooks Components</a> section above.</p>
</div>
<div class="paragraph">
<p>So focusing a little more closely on the above methods and our fields configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCSVReader</span> <span class="kd">implements</span> <span class="nc">SmooksXMLReader</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">ContentHandler</span> <span class="n">contentHandler</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">fields</span><span class="o">;</span> <span class="c1">// Auto decoded and injected from the "fields" &lt;param&gt; on the reader config.</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentHandler</span><span class="o">(</span><span class="nc">ContentHandler</span> <span class="n">contentHandler</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">contentHandler</span> <span class="o">=</span> <span class="n">contentHandler</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">InputSource</span> <span class="n">csvInputSource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">SAXException</span> <span class="o">{</span>
        <span class="c1">// TODO: Implement parsing of CSV Stream...</span>
    <span class="o">}</span>

    <span class="c1">// Other XMLReader methods...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So now we have our basic Reader implementation stub. We can start writing unit tests to test the new reader implementation.</p>
</div>
<div class="paragraph">
<p>First thing we need is some sample CSV input. Lets use a simple list of names:</p>
</div>
<div class="literalblock">
<div class="title">names.csv</div>
<div class="content">
<pre>Tom,Fennelly
Mike,Fennelly
Mark,Jones</pre>
</div>
</div>
<div class="paragraph">
<p>Second thing we need is a test Smooks configuration to configure Smooks with our MyCSVReader. As stated before, everything in Smooks is a resource and can be configured with the basic configuration. While this works fine, it&#8217;s a little noisy, so Smooks provides a basic configuration element specifically for the purpose of configuring a reader. The configuration for our test looks like the following:</p>
</div>
<div class="listingblock">
<div class="title">mycsvread-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;reader</span> <span class="na">class=</span><span class="s">"com.acme.MyCSVReader"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;params&gt;</span>
            <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"fields"</span><span class="nt">&gt;</span>firstname,lastname<span class="nt">&lt;/param&gt;</span>
        <span class="nt">&lt;/params&gt;</span>
    <span class="nt">&lt;/reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And of course we need the JUnit test class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCSVReaderTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"mycsvread-config.xml"</span><span class="o">));</span>
        <span class="nc">StringResult</span> <span class="n">serializedCSVEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringResult</span><span class="o">();</span>

        <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"names.csv"</span><span class="o">)),</span> <span class="n">serializedCSVEvents</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">serializedCSVEvents</span><span class="o">);</span>

        <span class="c1">// TODO: add assertions, etc...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So now we have a basic setup with our custom Reader implementation, as well as a unit test that we can use to drive our development. Of course, our reader <code>parse</code> method is not doing anything yet and our test class is not making any assertions, etc&#8230;&#8203; So lets start implementing the <code>parse</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCSVReader</span> <span class="kd">implements</span> <span class="nc">SmooksXMLReader</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">ContentHandler</span> <span class="n">contentHandler</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">fields</span><span class="o">;</span> <span class="c1">// Auto decoded and injected from the "fields" &lt;param&gt; on the reader config.</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentHandler</span><span class="o">(</span><span class="nc">ContentHandler</span> <span class="n">contentHandler</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">contentHandler</span> <span class="o">=</span> <span class="n">contentHandler</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">InputSource</span> <span class="n">csvInputSource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">SAXException</span> <span class="o">{</span>
        <span class="nc">BufferedReader</span> <span class="n">csvRecordReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">csvInputSource</span><span class="o">.</span><span class="na">getCharacterStream</span><span class="o">());</span>
        <span class="nc">String</span> <span class="n">csvRecord</span><span class="o">;</span>

        <span class="c1">// Send the start of message events to the handler...</span>
        <span class="n">contentHandler</span><span class="o">.</span><span class="na">startDocument</span><span class="o">();</span>
        <span class="n">contentHandler</span><span class="o">.</span><span class="na">startElement</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">NULL_NS_URI</span><span class="o">,</span> <span class="s">"message-root"</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AttributesImpl</span><span class="o">());</span>

        <span class="n">csvRecord</span> <span class="o">=</span> <span class="n">csvRecordReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
        <span class="k">while</span><span class="o">(</span><span class="n">csvRecord</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">fieldValues</span> <span class="o">=</span> <span class="n">csvRecord</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>

            <span class="c1">// perform checks...</span>

            <span class="c1">// Send the events for this record...</span>
            <span class="n">contentHandler</span><span class="o">.</span><span class="na">startElement</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">NULL_NS_URI</span><span class="o">,</span> <span class="s">"record"</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AttributesImpl</span><span class="o">());</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fields</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">contentHandler</span><span class="o">.</span><span class="na">startElement</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">NULL_NS_URI</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="s">""</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AttributesImpl</span><span class="o">());</span>
                <span class="n">contentHandler</span><span class="o">.</span><span class="na">characters</span><span class="o">(</span><span class="n">fieldValues</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">toCharArray</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">fieldValues</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">length</span><span class="o">());</span>
                <span class="n">contentHandler</span><span class="o">.</span><span class="na">endElement</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">NULL_NS_URI</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="s">""</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">contentHandler</span><span class="o">.</span><span class="na">endElement</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">NULL_NS_URI</span><span class="o">,</span> <span class="s">"record"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>

            <span class="n">csvRecord</span> <span class="o">=</span> <span class="n">csvRecordReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// Send the end of message events to the handler...</span>
        <span class="n">contentHandler</span><span class="o">.</span><span class="na">endElement</span><span class="o">(</span><span class="nc">XMLConstants</span><span class="o">.</span><span class="na">NULL_NS_URI</span><span class="o">,</span> <span class="s">"message-root"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
        <span class="n">contentHandler</span><span class="o">.</span><span class="na">endDocument</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Other XMLReader methods...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the unit test class now, you should see the following output on the console (formatted):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;message-root&gt;</span>
    <span class="nt">&lt;record&gt;</span>
        <span class="nt">&lt;firstname&gt;</span>Tom<span class="nt">&lt;/firstname&gt;</span>
        <span class="nt">&lt;lastname&gt;</span>Fennelly<span class="nt">&lt;/lastname&gt;</span>
    <span class="nt">&lt;/record&gt;</span>
    <span class="nt">&lt;record&gt;</span>
        <span class="nt">&lt;firstname&gt;</span>Mike<span class="nt">&lt;/firstname&gt;</span>
        <span class="nt">&lt;lastname&gt;</span>Fennelly<span class="nt">&lt;/lastname&gt;</span>
    <span class="nt">&lt;/record&gt;</span>
    <span class="nt">&lt;record&gt;</span>
        <span class="nt">&lt;firstname&gt;</span>Mark<span class="nt">&lt;/firstname&gt;</span>
        <span class="nt">&lt;lastname&gt;</span>Jones<span class="nt">&lt;/lastname&gt;</span>
    <span class="nt">&lt;/record&gt;</span>
<span class="nt">&lt;/message-root&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After this, it is just a case of expanding the tests, hardening the reader implementation code, etc&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Now you can use your reader to perform all sorts of operations supported by Smooks. As an example, the following configuration could be used to bind the names into a List of PersonName objects:</p>
</div>
<div class="listingblock">
<div class="title">java-binding-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span> <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;reader</span> <span class="na">class=</span><span class="s">"com.acme.MyCSVReader"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;params&gt;</span>
            <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"fields"</span><span class="nt">&gt;</span>firstname,lastname<span class="nt">&lt;/param&gt;</span>
        <span class="nt">&lt;/params&gt;</span>
    <span class="nt">&lt;/reader&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"peopleNames"</span> <span class="na">class=</span><span class="s">"java.util.ArrayList"</span> <span class="na">createOnElement=</span><span class="s">"message-root"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">beanIdRef=</span><span class="s">"personName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"personName"</span> <span class="na">class=</span><span class="s">"com.acme.PersonName"</span> <span class="na">createOnElement=</span><span class="s">"message-root/record"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"first"</span> <span class="na">data=</span><span class="s">"record/firstname"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"last"</span> <span class="na">data=</span><span class="s">"record/lastname"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then a test for this configuration could look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCSVReaderTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_java_binding</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"java-binding-config.xml"</span><span class="o">));</span>
        <span class="nc">JavaResult</span> <span class="n">javaResult</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

        <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"names.csv"</span><span class="o">)),</span> <span class="n">javaResult</span><span class="o">);</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PersonName</span><span class="o">&gt;</span> <span class="n">peopleNames</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">PersonName</span><span class="o">&gt;)</span> <span class="n">javaResult</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"peopleNames"</span><span class="o">);</span>

        <span class="c1">// TODO: add assertions etc</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more on Java Binding, see the <a href="https://github.com/smooks/smooks-javabean-cartridge/blob/master/README.adoc#java-binding">Java Binding</a> section.</p>
</div>
<div class="paragraph">
<p><strong>Tips</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reader instances are never used concurrently. Smooks Core will create a new instance for every message, or, will pool and reuse instances as per the <a href="#user-content-settings"><em>readerPoolSize</em> FilterSettings property</a>.</p>
</li>
<li>
<p>If your Reader requires access to the Smooks ExecutionContext for the current filtering context, your Reader needs to implement the <code>SmooksXMLReader</code> interface.</p>
</li>
<li>
<p>If your Source data is a binary data stream your Reader must implement the <code>StreamReader</code> interface. See next section.</p>
</li>
<li>
<p>You can programmatically configure your reader (e.g. in your unit tests) using a <code>GenericReaderConfigurator</code> instance, which you then set on the Smooks instance.</p>
</li>
<li>
<p>While the basic configuration is fine, it&#8217;s possible to define a custom configuration namespace (XSD) for your custom CSV Reader implementation. This topic is not covered here. Review the source code to see the extended configuration namespace for the Reader implementations supplied with Smooks (out-of-the-box) e.g. the EDIReader, CSVReader, JSONReader, etc&#8230;&#8203; From this, you should be able to work out how to do this for your own custom Reader.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="implementing_a_binary_source_reader">Implementing a Binary Source Reader</h4>
<div class="paragraph">
<p>Prior to Smooks v1.5, binary readers needed to implement the <code>StreamReader</code> interface. This is no longer a requirement. All <code>XMLReader</code> instances receive an <code>InputSource</code> (to their parse method) that contains an <code>InputStream</code> if the <code>InputStream</code> was provided in the <code>StreamSource</code> passed in the <code>Smooks.filterSource</code> method call. This means that all <code>XMLReader</code> instance are guaranteed to receive an <code>InputStream</code> if one is available, so no need to mark the <code>XMLReader</code> instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="implementing_a_flat_file_source_reader">Implementing a Flat File Source Reader</h4>
<div class="paragraph">
<p>In Smooks v1.5 we tried to make it a little easier to implement a custom reader for reading flat file data formats. By flat file we mean "record" based data formats, where the data in the message is structured in flat records as opposed to a more hierarchical structure. Examples of this would be Comma Separated Value (CSV) and Fixed Length Field (FLF). The new API introduced in Smooks v1.5 should remove the complexity of the XMLReader API (as outlined above).</p>
</div>
<div class="paragraph">
<p>The API is composed of 2 interfaces plus a number of support classes.These interfaces work as a pair. They need to be implemented if you wish to use this API for processing a custom Flat File format not already supported by Smooks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 * {@link RecordParser} factory class.
 * &lt;p/&gt;
 * Configurable by the Smooks {@link org.smooks.cdr.annotation.Configurator}
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RecordParserFactory</span> <span class="o">{</span>

    <span class="cm">/**
     * Create a new Flat File {@link RecordParser} instance.
     * @return A new {@link RecordParser} instance.
     */</span>
    <span class="nc">RecordParser</span> <span class="nf">newRecordParser</span><span class="o">();</span>
<span class="o">}</span>


<span class="cm">/**
 * Flat file Record Parser.
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RecordParser</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">RecordParserFactory</span><span class="o">&gt;</span>  <span class="o">{</span>

    <span class="cm">/**
     * Set the parser factory that created the parser instance.
     * @param factory The parser factory that created the parser instance.
     */</span>
    <span class="kt">void</span> <span class="nf">setRecordParserFactory</span><span class="o">(</span><span class="no">T</span> <span class="n">factory</span><span class="o">);</span>

    <span class="cm">/**
     * Set the Flat File data source on the parser.
     * @param source The flat file data source.
     */</span>
    <span class="kt">void</span> <span class="nf">setDataSource</span><span class="o">(</span><span class="nc">InputSource</span> <span class="n">source</span><span class="o">);</span>

    <span class="cm">/**
     * Parse the next record from the message stream and produce a {@link Record} instance.
     * @return The records instance.
     * @throws IOException Error reading message stream.
     */</span>
    <span class="nc">Record</span> <span class="nf">nextRecord</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously the <code>RecordParserFactory</code> implementation is responsible for creating the <code>RecordParser</code> instances for the Smooks runtime. The <code>RecordParserFactory</code> is the class that Smooks configures, so it is in here you place all your <code>@Inject</code> details. The created <code>RecordParser</code> instances are supplied with a reference to the <code>RecordParserFactory</code> instance that created them, so it is easy enough the provide them with access to the configuration via getters on the <code>RecordParserFactory</code> implementation.</p>
</div>
<div class="paragraph">
<p>The <code>RecordParser</code> implementation is responsible for parsing out each record (a <code>Record</code> contains a set of <code>Fields</code>) in the <code>nextRecord()</code> method. Each instance is supplied with the <code>Reader</code> to the message stream via the <code>setReader(Reader)</code> method. The <code>RecordParser</code> should store a reference to this <code>Reader</code> and use it in the <code>nextRecord()</code> method. A new instance of a given <code>RecordParser</code> implementation is created for each message being filtered by Smooks.</p>
</div>
<div class="paragraph">
<p>Configuring your implementation in the Smooks configuration is as simple as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:ff=</span><span class="s">"https://www.smooks.org/xsd/smooks/flatfile-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;ff:reader</span> <span class="na">fields=</span><span class="s">"first,second,third"</span> <span class="na">parserFactory=</span><span class="s">"com.acme.ARecordParserFactory"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;params&gt;</span>
            <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"aConfigParameter"</span><span class="nt">&gt;</span>aValue<span class="nt">&lt;/param&gt;</span>
            <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"bConfigParameter"</span><span class="nt">&gt;</span>bValue<span class="nt">&lt;/param&gt;</span>
        <span class="nt">&lt;/params&gt;</span>
    <span class="nt">&lt;/ff:reader&gt;</span>

    <span class="c">&lt;!--
 Other Smooks configurations e.g. &lt;jb:bean&gt; configurations
 --&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Flat File configuration also supports basic Java binding configurations, inlined in the reader configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:ff=</span><span class="s">"https://www.smooks.org/xsd/smooks/flatfile-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;ff:reader</span> <span class="na">fields=</span><span class="s">"firstname,lastname,gender,age,country"</span> <span class="na">parserFactory=</span><span class="s">"com.acme.PersonRecordParserFactory"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- The field names must match the property names on the Person class. --&gt;</span>
        <span class="nt">&lt;ff:listBinding</span> <span class="na">beanId=</span><span class="s">"people"</span> <span class="na">class=</span><span class="s">"com.acme.Person"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/ff:reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To execute this configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">configStream</span><span class="o">);</span>
<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">messageReader</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"people"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Smooks also supports creation of Maps from the record set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:ff=</span><span class="s">"https://www.smooks.org/xsd/smooks/flatfile-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;ff:reader</span> <span class="na">fields=</span><span class="s">"firstname,lastname,gender,age,country"</span> <span class="na">parserFactory=</span><span class="s">"com.acme.PersonRecordParserFactory"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ff:mapBinding</span> <span class="na">beanId=</span><span class="s">"people"</span> <span class="na">class=</span><span class="s">"com.acme.Person"</span> <span class="na">keyField=</span><span class="s">"firstname"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/ff:reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration would produce a Map of Person instances, keyed by the "firstname" value of each Person. It would be executed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">configStream</span><span class="o">);</span>
<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">messageReader</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"people"</span><span class="o">);</span>

<span class="nc">Person</span> <span class="n">tom</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Tom"</span><span class="o">);</span>
<span class="nc">Person</span> <span class="n">mike</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Mike"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#virtual-object-models-maps&#8212;&#8203;lists">Virtual Models</a> are also supported, so you can define the <strong>class</strong> attribute as a java.util.Map and have the record field values bound into Map instances, which are in turn added to a List or a Map.</p>
</div>
<div class="sect4">
<h5 id="variablefieldrecordparser_and_variablefieldrecordparserfactory">VariableFieldRecordParser and VariableFieldRecordParserFactory</h5>
<div class="paragraph">
<p>VariableFieldRecordParser and VariableFieldRecordParserFactory are abstract implementations of the <code>RecordParser</code> and <code>RecordParserFactory</code> interface. They provide very useful base implementations for a Flat File Reader, providing base support for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The utility java binding configurations as outlined in the previous section.</p>
</li>
<li>
<p>Support for "variable field" records i.e. a flat file message that contains multiple record definitions. The different records are identified by the value of the first field in the record and are defined as follows: <code>fields="book[name,author] | magazine[*]"</code>. Note the record definitions are pipe separated. "book" records will have a first field value of "book" while "magazine" records will have a first field value of "magazine". Astrix ("*") as the field definition for a record basically tells the reader to generate the field names in the generated events (e.g. "field_0", "field_1", etc&#8230;&#8203;).</p>
</li>
<li>
<p>The ability to read the next record chunk, with support for a simple record delimiter, or a regular expression (regex) pattern that marks the beginning of each record.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The CSV and Regex readers are implemented using these abstract classes. See the <a href="https://github.com/smooks/smooks-examples/tree/v2/csv-variable-record">csv-variable-record</a> and <a href="https://github.com/smooks/smooks-examples/tree/v2/flatfile-to-xml-regex">flatfile-to-xml-regex</a> examples. The <a href="https://github.com/smooks/smooks-examples/tree/v2/flatfile-to-xml-regex">Regex Reader</a> implementation is also a good example that can be used as a basis for your own custom flat file reader.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementing_a_fragment_visitor">Implementing a Fragment Visitor</h3>
<div class="paragraph">
<p>Visitors are the workhorse of Smooks. Most of the out-of-the-box functionality in Smooks (Java binding, templating, persistence, etc&#8230;&#8203;) was created by creating one or more visitors. Visitors often collaborate through the <code>ExecutionContext</code> and <code>ApplicationContext</code> objects, accomplishing a common goal by working together.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Smooks treats all visitors as stateless objects. A visitor instance must be usable concurrently across multiple messages, that is, across multiple concurrent calls to the <code>Smooks.filterSource</code> method.All state associated with the current <code>Smooks.filterSource</code> execution must be stored in the <code>ExecutionContext</code>. For more details see the <a href="#executioncontext-and-applicationcontext">ExecutionContext and ApplicationContex</a> section.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sax_ng_visitor_api">SAX NG Visitor API</h4>
<div class="paragraph">
<p>The SAX NG visitor API is made up of a number of interfaces. These interfaces are based on the
<a href="https://docs.oracle.com/javase/8/docs/api/org/xml/sax/ContentHandler.html">SAX events</a> that a SaxNgVisitor implementation can capture and processes. Depending on the use case being solved with the SaxNgVisitor implementation, you may need to implement one or all of these interfaces.</p>
</div>
<div class="paragraph">
<p><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/resource/visitor/sax/ng/BeforeVisitor.html"><code>BeforeVisitor</code></a>: Captures the <em>startElement</em> SAX event for the targeted fragment element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeforeVisitor</span> <span class="kd">extends</span> <span class="nc">Visitor</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">visitBefore</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/resource/visitor/sax/ng/ChildrenVisitor.html"><code>ChildrenVisitor</code></a>: Captures the <em>character</em> based SAX events for the targeted fragment element, as well as Smooks generated (pseudo) events corresponding to the <em>startElement</em> events of child fragment elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChildrenVisitor</span> <span class="kd">extends</span> <span class="nc">Visitor</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">visitChildText</span><span class="o">(</span><span class="nc">CharacterData</span> <span class="n">characterData</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SmooksException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">;</span>

    <span class="kt">void</span> <span class="nf">visitChildElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">childElement</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SmooksException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/resource/visitor/sax/ng/AfterVisitor.html"><code>AfterVisitor</code></a>: Captures the <em>endElement</em> SAX event for the targeted fragment element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AfterVisitor</span> <span class="kd">extends</span> <span class="nc">Visitor</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a convenience for those implementations that need to capture all the SAX events, the above three interfaces are pulled together into a single interface in the <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/resource/visitor/sax/ng/ElementVisitor.html"><code>ElementVisitor</code></a> interface.</p>
</div>
<div class="paragraph">
<p>Illustrating these events using a piece of XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;message&gt;</span>
    <span class="nt">&lt;target-fragment&gt;</span>      <span class="err">&lt;</span>--- BeforeVisitor.visitBefore
        Text!!                       <span class="err">&lt;</span>--- ChildrenVisitor.visitChildText
        <span class="nt">&lt;child&gt;</span>                      <span class="err">&lt;</span>--- ChildrenVisitor.visitChildElement
        <span class="nt">&lt;/child&gt;</span>
    <span class="nt">&lt;/target-fragment&gt;</span>     <span class="err">&lt;</span>--- AfterVisitor.visitAfter
<span class="nt">&lt;/message&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Of course, the above is just an illustration of a Source message event stream and it looks like XML, but could be EDI, CSV, JSON, etc&#8230;&#8203; Think of this as just an XML serialization of a Source message event stream, serialized as XML for easy reading.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://docs.oracle.com/javase/8/docs/api/org/w3c/dom/Element.html">Element</a>: As can be seen from the above SAX NG interfaces, <code>Element</code> type is passed in all method calls. This object contains details about the targeted fragment element, including attributes and their values. We&#8217;ll discuss text accumulation and <code>StreamResult</code> writing in the coming sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="text_accumulation">Text Accumulation</h4>
<div class="paragraph">
<p>SAX is a stream based processing model. It doesn&#8217;t create a Document Object Model (DOM) of any form. It doesn&#8217;t "accumulate" event data in any way. This is why it is a suitable processing model for processing huge message streams.</p>
</div>
<div class="paragraph">
<p>The <code>Element</code> will always contain attributes associated with the targeted element, but will not contain the fragment child text data, whose SAX events (<code>ChildrenVisitor.visitChildText</code>) occur between the <code>BeforeVisitor.visitBefore</code> and <code>AfterVisitor.visitAfter</code> events (see above illustration). The filter does not accumulate text events on the <code>Element</code> because, as already stated, that could result in a significant performance drain. Of course the downside to this is the fact that if your <code>SaxNgVisitor</code> implementation needs access to the text content of a fragment, you need to explicitly tell Smooks to <strong>accumulate text</strong> for the targeted fragment. This is done by stashing the text into a memento from within the <code>ChildrenVisitor.visitChildText</code> method and then restoring the memento from within the <code>AfterVisitor.visitAfter</code> method implementation of your <code>SaxNgVisitor</code> as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyVisitor</span> <span class="kd">implements</span> <span class="nc">ChildrenVisitor</span><span class="o">,</span> <span class="nc">AfterVisitor</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitChildText</span><span class="o">(</span><span class="nc">CharacterData</span> <span class="n">characterData</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">executionContext</span><span class="o">.</span><span class="na">getMementoCaretaker</span><span class="o">().</span><span class="na">stash</span><span class="o">(</span><span class="k">new</span> <span class="nc">TextAccumulatorMemento</span><span class="o">(</span><span class="k">new</span> <span class="nc">NodeVisitable</span><span class="o">(</span><span class="n">characterData</span><span class="o">.</span><span class="na">getParentNode</span><span class="o">()),</span> <span class="k">this</span><span class="o">),</span> <span class="n">textAccumulatorMemento</span> <span class="o">-&gt;</span> <span class="n">textAccumulatorMemento</span><span class="o">.</span><span class="na">accumulateText</span><span class="o">(</span><span class="n">characterData</span><span class="o">.</span><span class="na">getTextContent</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitChildElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">childElement</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TextAccumulatorMemento</span> <span class="n">textAccumulatorMemento</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextAccumulatorMemento</span><span class="o">(</span><span class="k">new</span> <span class="nc">NodeVisitable</span><span class="o">(</span><span class="n">element</span><span class="o">),</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">executionContext</span><span class="o">.</span><span class="na">getMementoCaretaker</span><span class="o">().</span><span class="na">restore</span><span class="o">(</span><span class="n">textAccumulatorMemento</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">fragmentText</span> <span class="o">=</span> <span class="n">textAccumulatorMemento</span><span class="o">.</span><span class="na">getTextContent</span><span class="o">();</span>

        <span class="c1">// ... etc ...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is a bit ugly having to implement <code>ChildrenVisitor.visitChildText</code> just to tell Smooks to accumulate the text events for the targeted fragment. For that reason, we have the <code>@TextConsumer</code> annotation that can be used to annotate your <code>SaxNgVisitor</code> implementation, removing the need to implement the <code>ChildrenVisitor.visitChildText</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@TextConsumer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyVisitor</span> <span class="kd">implements</span> <span class="nc">AfterVisitor</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">fragmentText</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getTextContent</span><span class="o">();</span>

        <span class="c1">// ... etc ...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the complete fragment text will not be available until the <code>AfterVisitor.visitAfter</code> event.</p>
</div>
</div>
<div class="sect3">
<h4 id="streamresult_writingserialization">StreamResult Writing/Serialization</h4>
<div class="paragraph">
<p>The <code>Smooks.filterSource(Source, Result)</code> method can take one or more of a number of different <code>Result</code> type implementations, one of which is the <code>StreamResult</code> class (see <a href="#multiple-outputsresults">Multiple Outputs/Results</a>). By default, Smooks will always serialize the full Source event stream as XML to any <code>StreamResult</code> instance provided to the <code>Smooks.filterSource(Source, Result)</code> method.</p>
</div>
<div class="paragraph">
<p>So, if the Source provided to the <code>Smooks.filterSource(Source, Result)</code> method is an XML stream and a  <a href="https://docs.oracle.com/javase%2F8%2Fdocs%2Fapi%2F%2F/javax/xml/transform/stream/StreamResult.html"><code>StreamResult</code></a> instance is provided as one of the <code>Result</code> instances, the Source XML will be written out to the
<code>StreamResult</code> unmodified, unless the Smooks instance is configured with one or more <code>SaxNgVisitor</code> implementations that modify one or more fragments. In other words, Smooks streams the Source in and back out again through the <code>StreamResult</code> instance. Default serialization can be turned on/off by <a href="#user-content-settings">configuring the filter settings</a>.</p>
</div>
<div class="paragraph">
<p>If you want to modify the serialized form of one of the message fragments (i.e. "transform"), you need to implement a <code>SaxNgVisitor</code> to do so and target it at the message fragment using an XPath-like expression.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Of course, you can also modify the serialized form of a message fragment using one of the out-of-the-box <a href="#templating">Templating</a> components. These components are also <code>SaxNgVisitor</code> implementations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The key to implementing a <code>SaxNgVisitor</code> geared towards transforming the serialized form of a fragment is telling Smooks that the <code>SaxNgVisitor</code> implementation in question will be writing to the <code>StreamResult</code>. You need to tell Smooks this because Smooks supports targeting of multiple <code>SaxNgVisitor</code> implementations at a single fragment, but only one <code>SaxNgVisitor</code> is allowed to write to the <code>StreamResult</code>, per fragment. If a second <code>SaxNgVisitor</code> attempts to write to the <code>StreamResult</code>, a <code>SAXWriterAccessException</code> will result and you will need to modify your Smooks configuration.</p>
</div>
<div class="paragraph">
<p>In order to be "the one" that writes to the <em>StreamResult</em>, the <em>SaxNgVisitor</em> needs to <strong>acquire ownership</strong> of the <em>Writer</em> to the <em>StreamResult</em>. It does this by simply making a call to the <em>ExecutionContext.getWriter().write(&#8230;&#8203;)</em> method from inside the <em>BeforeVisitor.visitBefore</em> methods implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyVisitor</span> <span class="kd">implements</span> <span class="nc">ElementVisitor</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitBefore</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>

        <span class="c1">// ... write the start of the fragment...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitChildText</span><span class="o">(</span><span class="nc">CharacterData</span> <span class="n">characterData</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>

        <span class="c1">// ... write the child text...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitChildElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">childElement</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>

        <span class="c1">// ... close the fragment...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you need to control serialization of sub-fragments you need to reset the <code>Writer</code> instance so as to divert serialization of the sub-fragments. You do this by calling <code>ExecutionContext.setWriter</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sometimes you know that the target fragment you are serializing/transforming will never have sub-fragments. In this situation, it&#8217;s a bit ugly to have to implement the <code>BeforeVisitor.visitBefore</code> method just to make a call to the <code>ExecutionContext.getWriter().write(...)</code> method to acquire ownership of the <code>Writer</code>. For this reason, we have the <code>@StreamResultWriter</code> annotation. Used in combination with the <code>@TextConsumer</code> annotation, we can remove the need to implement all but the <code>AfterVisitor.visitAfter</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@TextConsumer</span>
<span class="nd">@StreamResultWriter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyVisitor</span> <span class="kd">implements</span> <span class="nc">AfterVisitor</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>

        <span class="c1">// ... serialize to the writer ...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="domserializer">DomSerializer</h5>
<div class="paragraph">
<p>Smooks provides the <code>DomSerializer</code> class to make serializing of element data, as XML, a little easier. This class allows you to write a <code>SaxNgVisitor</code> implementation like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@StreamResultWriter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyVisitor</span> <span class="kd">implements</span> <span class="nc">ElementVisitor</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">DomSerializer</span> <span class="n">domSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DomSerializer</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitBefore</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeStartElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SmooksException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitChildText</span><span class="o">(</span><span class="nc">CharacterData</span> <span class="n">characterData</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeText</span><span class="o">(</span><span class="n">characterData</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SmooksException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitChildElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SmooksException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SmooksException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeEndElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SmooksException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may have noticed that the arguments in the <code>DomSerializer</code> constructor are boolean. This is the <code>closeEmptyElements</code> and <code>rewriteEntities</code> args which should be based on the <code>closeEmptyElements</code> and <code>rewriteEntities</code> filter setting, respectively. Smooks provides a small code optimization/assist here. If you annotate the <code>DomSerializer</code> field with <code>@Inject</code>, Smooks will create the <code>DomSerializer</code> instance and initialize it with the <code>closeEmptyElements</code> and <code>rewriteEntities</code> filter settings for the associated Smooks instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@TextConsumer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyVisitor</span> <span class="kd">implements</span> <span class="nc">AfterVisitor</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">DomSerializer</span> <span class="n">domSerializer</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SmooksException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeStartElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeText</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeEndElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SmooksException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="visitor_configuration">Visitor Configuration</h4>
<div class="paragraph">
<p><code>SaxNgVisitor</code> configuration works in exactly the same way as any other Smooks component. See <a href="#configuring-smooks-components">Configuring Smooks Components</a>.</p>
</div>
<div class="paragraph">
<p>The most important thing to note with respect to configuring visitor instances is the fact that the <code>selector</code> attribute is interpreted as an XPath (like) expression. For more on this see the docs on <a href="#selectors">Selectors</a>.</p>
</div>
<div class="paragraph">
<p>Also note that visitors can be programmatically configured on a Smooks instance. Among other things, this is very useful for unit testing.</p>
</div>
<div class="sect4">
<h5 id="example_visitor_configuration">Example Visitor Configuration</h5>
<div class="paragraph">
<p>Let&#8217;s assume we have a very simple <code>SaxNgVisitor</code> implementation as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@TextConsumer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChangeItemState</span> <span class="kd">implements</span> <span class="nc">AfterVisitor</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">DomSerializer</span> <span class="n">domSerializer</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">newState</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitAfter</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">element</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"state"</span><span class="o">,</span> <span class="n">newState</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeStartElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeText</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
            <span class="n">domSerializer</span><span class="o">.</span><span class="na">writeEndElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SmooksException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Declaratively configuring <code>ChangeItemState</code> to fire on fragments having a status of "OK" is as simple as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"order-items/order-item[@status = 'OK']"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;resource&gt;</span>com.acme.ChangeItemState <span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"newState"</span><span class="nt">&gt;</span>COMPLETED<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;/resource-config&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course it would be really nice to be able to define a cleaner and more strongly typed configuration for the <code>ChangeItemState</code> component, such that it could be configured something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:order=</span><span class="s">"http://www.acme.com/schemas/smooks/order.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;order:changeItemState</span> <span class="na">itemElement=</span><span class="s">"order-items/order-item[@status = 'OK']"</span> <span class="na">newState=</span><span class="s">"COMPLETED"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For details on this, see the section on <a href="#defining-custom-configuration-namespaces">Defining Custom Configuration Namespaces</a>.</p>
</div>
<div class="paragraph">
<p>This visitor could also be programmatically configured on a Smooks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">addVisitor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChangeItemState</span><span class="o">().</span><span class="na">setNewState</span><span class="o">(</span><span class="s">"COMPLETED"</span><span class="o">),</span> <span class="s">"order-items/order-item[@status = 'OK']"</span><span class="o">);</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">inReader</span><span class="o">),</span> <span class="k">new</span> <span class="nc">StreamResult</span><span class="o">(</span><span class="n">outWriter</span><span class="o">));</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="visitor_instance_lifecycle">Visitor Instance Lifecycle</h4>
<div class="paragraph">
<p>One aspect of the visitor lifecycle has already been discussed in the general context of Smooks component <a href="#initialize-and-uninitialize">initialization and un-initialization</a>.</p>
</div>
<div class="paragraph">
<p>Smooks supports two additional component lifecycle events, specific to visitor components, via the <code>PostExecutionLifecycle</code> and <code>PostFragmentLifecycle</code> interfaces.</p>
</div>
<div class="sect4">
<h5 id="postexecutionlifecycle">PostExecutionLifecycle</h5>
<div class="paragraph">
<p>Visitor components implementing this lifecycle interface will be able to perform post <code>Smooks.filterSource</code> lifecycle operations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PostExecutionLifecycle</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">onPostExecution</span><span class="o">(</span><span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic call sequence can be described as follows (note the onPostExecution calls):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(..);</span>

        <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(...);</span>
            <span class="o">**</span> <span class="nc">VisitorXX</span><span class="o">.</span><span class="na">onPostExecution</span> <span class="o">**</span>
        <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(...);</span>
            <span class="o">**</span> <span class="nc">VisitorXX</span><span class="o">.</span><span class="na">onPostExecution</span> <span class="o">**</span>
        <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(...);</span>
            <span class="o">**</span> <span class="nc">VisitorXX</span><span class="o">.</span><span class="na">onPostExecution</span> <span class="o">**</span>
        <span class="o">...</span> <span class="n">etc</span> <span class="o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This lifecycle method allows you to ensure that resources scoped around the <code>Smooks.filterSource</code> execution lifecycle can be cleaned up for the associated <code>ExecutionContext</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="postfragmentlifecycle">PostFragmentLifecycle</h5>
<div class="paragraph">
<p>Visitor components implementing this lifecycle interface will be able to perform post <code>AfterVisitor.visitAfter</code> lifecycle operations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PostFragmentLifecycle</span> <span class="kd">extends</span> <span class="nc">Visitor</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">onPostFragment</span><span class="o">(</span><span class="nc">Fragment</span><span class="o">&lt;?&gt;</span> <span class="n">fragment</span><span class="o">,</span> <span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic call sequence can be described as follows (note the onPostFragment calls):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>smooks.filterSource(...);

    &lt;message&gt;
        &lt;target-fragment&gt;      &lt;--- VisitorXX.visitBefore
            Text!!                       &lt;--- VisitorXX.visitChildText
            &lt;child&gt;                      &lt;--- VisitorXX.visitChildElement
            &lt;/child&gt;
        &lt;/target-fragment&gt;     &lt;--- VisitorXX.visitAfter
        ** VisitorXX.onPostFragment **
        &lt;target-fragment&gt;      &lt;--- VisitorXX.visitBefore
            Text!!                       &lt;--- VisitorXX.visitChildText
            &lt;child&gt;                      &lt;--- VisitorXX.visitChildElement
            &lt;/child&gt;
        &lt;/target-fragment&gt;     &lt;--- VisitorXX.visitAfter
        ** VisitorXX.onPostFragment **
    &lt;/message&gt;
    VisitorXX.onPostExecution

smooks.filterSource(...);

    &lt;message&gt;
        &lt;target-fragment&gt;      &lt;--- VisitorXX.visitBefore
            Text!!                       &lt;--- VisitorXX.visitChildText
            &lt;child&gt;                      &lt;--- VisitorXX.visitChildElement
            &lt;/child&gt;
        &lt;/target-fragment&gt;     &lt;--- VisitorXX.visitAfter
        ** VisitorXX.onPostFragment **
        &lt;target-fragment&gt;      &lt;--- VisitorXX.visitBefore
            Text!!                       &lt;--- VisitorXX.visitChildText
            &lt;child&gt;                      &lt;--- VisitorXX.visitChildElement
            &lt;/child&gt;
        &lt;/target-fragment&gt;     &lt;--- VisitorXX.visitAfter
        ** VisitorXX.onPostFragment **
    &lt;/message&gt;
    VisitorXX.onPostExecution</pre>
</div>
</div>
<div class="paragraph">
<p>This lifecycle method allows you to ensure that resources scoped around a single fragment execution of a SaxNgVisitor implementation can be cleaned up for the associated <code>ExecutionContext</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="executioncontext">ExecutionContext</h4>
<div class="paragraph">
<p><code>ExecutionContext</code> is scoped specifically around a single execution of a <code>Smooks.filterSource</code> method. <strong>All Smooks visitors must be stateless within the context of a single execution</strong>. A visitor
is created once in Smooks and referenced across multiple concurrent executions of the <code>Smooks.filterSource</code> method. All data stored in an <code>ExecutionContext</code> instance will be lost on completion of the <code>Smooks.filterSource</code> execution. <code>ExecutionContext</code> is a parameter in all visit invocations.</p>
</div>
</div>
<div class="sect3">
<h4 id="applicationcontext">ApplicationContext</h4>
<div class="paragraph">
<p><code>ApplicationContext</code> is scoped around the associated Smooks instance: only one <code>ApplicationContext</code> instance exists per Smooks instance. This context object can be used to store data that needs to be maintained (and accessible) across multiple <code>Smooks.filterSource</code> executions. Components (any component, including <code>SaxNgVisitor</code> components) can gain access to their associated <code>ApplicationContext</code> instance by declaring an <code>ApplicationContext</code> class property and annotating it with <code>@Inject</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MySmooksResource</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">ApplicationContext</span> <span class="n">appContext</span><span class="o">;</span>

    <span class="c1">// etc...</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="instrumentation">Instrumentation</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Smooks instrumentation is available starting from v2.0.0-RC4.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A Smooks application can be instrumented with <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jmx/index.html">JMX</a> which allows IT operations to monitor and manage Smooks from tools such as JConsole, Grafana, and NewRelic. Apart from the MBeans provided by the Java runtime and third-party libraries, Smooks provides MBeans for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>resources (e.g., resource config parameters)</p>
</li>
<li>
<p>visitors (e.g., performance metrics, failure visit count, events visited)</p>
</li>
<li>
<p>reader pools (e.g., no. of active readers)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="activation">Activation</h3>
<div class="paragraph">
<p>To activate instrumentation in Smooks, you need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the <code>smooks-management</code> module to your Java class path. The Maven coordinates for this module are:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-management<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Declare <code>management:instrumentationResource</code> in the Smooks config to activate instrumentation:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:management=</span><span class="s">"https://www.smooks.org/xsd/smooks/management-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;management:instrumentationResource/&gt;</span>

    ...
    ...
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>management:instrumentationResource</code> supports the following attributes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">usePlatformMBeanServer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to use the MBeanServer from this JVM.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mBeanServerDefaultDomain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default JMX domain of the MBeanServer.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.smooks</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mBeanObjectDomainName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JMX domain that all object names will use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.smooks</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeHostName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to include the hostname in the MBean naming.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Optionally, declare the <code>org.smooks.management.InstrumentationInterceptor</code> interceptor to instrument visitors:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:management=</span><span class="s">"https://www.smooks.org/xsd/smooks/management-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;management:instrumentationResource/&gt;</span>

    <span class="nt">&lt;core:interceptors&gt;</span>
        <span class="nt">&lt;core:interceptor</span> <span class="na">class=</span><span class="s">"org.smooks.management.InstrumentationInterceptor"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/core:interceptors&gt;</span>

    ...
    ...
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="extending">Extending</h3>
<div class="paragraph">
<p>In addition to the Smooks classes that are already instrumented, you can instrument your own classes with the help of annotations located in the <code>org.smooks.management.annotation</code> package which are listed below:</p>
</div>
<div class="sect3">
<h4 id="managedresource">@ManagedResource</h4>
<div class="paragraph">
<p>Annotating a class with <code>org.smooks.management.annotation.ManagedResource</code> effectively turns the class into an MBean which allows an instance of the class to be registered with an MBean server. Here is an example of a class annotated with <code>@ManagedResource</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="o">...</span>
<span class="o">...</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.management.InstrumentationAgent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.management.InstrumentationResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedResource</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.management.ObjectName</span><span class="o">;</span>

<span class="nd">@ManagedResource</span><span class="o">(</span><span class="n">description</span> <span class="o">=</span> <span class="s">"My Class"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyManagedClass</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">MyManagedClass</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">InstrumentationResource</span> <span class="n">instrumentationResource</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="nc">InstrumentationResource</span><span class="o">.</span><span class="na">INSTRUMENTATION_RESOURCE_TYPED_KEY</span><span class="o">);</span>
        <span class="nc">InstrumentationAgent</span> <span class="n">instrumentationAgent</span> <span class="o">=</span> <span class="n">instrumentationResource</span><span class="o">.</span><span class="na">getInstrumentationAgent</span><span class="o">();</span>

        <span class="n">instrumentationAgent</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ObjectName</span><span class="o">(</span><span class="s">"org.smooks:type=app,name=MyClass"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="o">...</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Line 17 from the snippet above uses <code>InstrumentationAgent</code> to register the <code>@ManagedResource</code> annotated object with the MBean server so that it can be queried and invoked by JMX clients. <code>InstrumentationAgent</code> is obtained from an instance of <code>org.smooks.api.management.InstrumentationResource</code>. The singleton <code>InstrumentationResource</code> can be looked up from the Smooks registry as shown in line 14.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<a href="#activation">Instrumentation needs to be activated</a> in order to obtain a non-null <code>InstrumentationResource</code> from the lookup.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="managedattribute">@ManagedAttribute</h4>
<div class="paragraph">
<p>Annotating a method with <code>org.smooks.management.annotation.ManagedAttribute</code> exposes the method as an MBean attribute. Here is an example of a method annotated with <code>@ManagedAttribute</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">...</span>
<span class="o">...</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedAnnotation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedResource</span><span class="o">;</span>

<span class="nd">@ManagedResource</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyManagedClass</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">myAttribute</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="o">...</span>

    <span class="nd">@ManagedAttribute</span><span class="o">(</span><span class="n">description</span> <span class="o">=</span> <span class="s">"My attribute"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getMyAttribute</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">myAttribute</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="managedoperation">@ManagedOperation</h4>
<div class="paragraph">
<p>Annotating a method with <code>org.smooks.management.annotation.ManagedOperation</code> exposes the method and its parameters as an MBean operation. Here is an example of a method annotated with <code>@ManagedOperation</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">...</span>
<span class="o">...</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedOperation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedResource</span><span class="o">;</span>

<span class="nd">@ManagedResource</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyManagedClass</span> <span class="o">{</span>

    <span class="o">...</span>
    <span class="o">...</span>

    <span class="nd">@ManagedOperation</span><span class="o">(</span><span class="n">description</span> <span class="o">=</span> <span class="s">"My operation"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myOperation</span><span class="o">(</span><span class="nc">String</span> <span class="n">myFirstParam</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">mySecondParam</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="managednotification">@ManagedNotification</h4>
<div class="paragraph">
<p>Annotating a class with <code>org.smooks.management.annotation.ManagedNotification</code> allows JMX clients to subscribe to notifications broadcasted from instances of this class. Here is an example of a method annotated with <code>@ManagedNotification</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre><span class="o">...</span>
<span class="o">...</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.management.InstrumentationAgent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.management.InstrumentationResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.ModelMBeanAssembler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedNotification</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedResource</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.management.MBeanException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.management.Notification</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.management.ObjectName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.management.modelmbean.ModelMBeanInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.management.modelmbean.RequiredModelMBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="o">;</span>

<span class="nd">@ManagedResource</span>
<span class="nd">@ManagedNotification</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"My Notification"</span><span class="o">,</span> <span class="n">notificationTypes</span> <span class="o">=</span> <span class="o">{</span><span class="s">"javax.management.Notification"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyManagedClass</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RequiredModelMBean</span> <span class="n">requiredModelMBean</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicLong</span> <span class="n">sequenceNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">MyManagedClass</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">InstrumentationResource</span> <span class="n">instrumentationResource</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="nc">InstrumentationResource</span><span class="o">.</span><span class="na">INSTRUMENTATION_RESOURCE_TYPED_KEY</span><span class="o">);</span>
        <span class="nc">InstrumentationAgent</span> <span class="n">instrumentationAgent</span> <span class="o">=</span> <span class="n">instrumentationResource</span><span class="o">.</span><span class="na">getInstrumentationAgent</span><span class="o">();</span>

        <span class="nc">ModelMBeanAssembler</span> <span class="n">modelMBeanAssembler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelMBeanAssembler</span><span class="o">();</span>
        <span class="nc">ModelMBeanInfo</span> <span class="n">modelMBeanInfo</span> <span class="o">=</span> <span class="n">modelMBeanAssembler</span><span class="o">.</span><span class="na">getModelMbeanInfo</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">requiredModelMBean</span> <span class="o">=</span> <span class="n">instrumentationAgent</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ObjectName</span><span class="o">(</span><span class="s">"org.smooks:type=app,name=MyClass"</span><span class="o">),</span> <span class="n">modelMBeanInfo</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendNotification</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MBeanException</span> <span class="o">{</span>
        <span class="nc">Notification</span> <span class="n">notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">(</span><span class="s">"My Notification"</span><span class="o">,</span> <span class="n">requiredModelMBean</span><span class="o">,</span> <span class="n">sequenceNumber</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">requiredModelMBean</span><span class="o">.</span><span class="na">sendNotification</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>As illustrated above in lines 29-30, to register a <code>@ManagedNotification</code> instance, the MBean descriptor should be assembled dynamically with <code>org.smooks.management.ModelMBeanAssembler</code>. The assembled <code>javax.management.modelmbean.ModelMBeanInfo</code> is then registered using <code>InstrumentationAgent</code> as shown in line 31. <code>InstrumentationAgent.register(Object, ObjectName, ModelMBeanInfo, boolean)</code> returns a <code>RequiredModelMBean</code> object that can be referenced to broadcast notifications, seen in lines 35-36.</p>
</div>
</div>
<div class="sect3">
<h4 id="managednotifications">@ManagedNotifications</h4>
<div class="paragraph">
<p>Adding more than one notification type can be achieved with <code>org.smooks.management.annotation.ManagedNotifications</code>. Here is an example of a method annotated with <code>@ManagedNotifications</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">...</span>
<span class="o">...</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.management.InstrumentationAgent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.api.management.InstrumentationResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.ModelMBeanAssembler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedNotification</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedNotifications</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.smooks.management.annotation.ManagedResource</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.management.MBeanException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.management.Notification</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.management.ObjectName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.management.modelmbean.ModelMBeanInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.management.modelmbean.RequiredModelMBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="o">;</span>

<span class="nd">@ManagedResource</span>
<span class="nd">@ManagedNotifications</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="nd">@ManagedNotification</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"My Notification"</span><span class="o">,</span> <span class="n">notificationTypes</span> <span class="o">=</span> <span class="o">{</span><span class="s">"javax.management.Notification"</span><span class="o">}),</span>
<span class="nd">@ManagedNotification</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Another Notification"</span><span class="o">,</span> <span class="n">notificationTypes</span> <span class="o">=</span> <span class="o">{</span><span class="s">"javax.management.Notification"</span><span class="o">})})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyManagedClass</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RequiredModelMBean</span> <span class="n">requiredModelMBean</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicLong</span> <span class="n">sequenceNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">MyManagedClass</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">InstrumentationResource</span> <span class="n">instrumentationResource</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="nc">InstrumentationResource</span><span class="o">.</span><span class="na">INSTRUMENTATION_RESOURCE_TYPED_KEY</span><span class="o">);</span>
        <span class="nc">InstrumentationAgent</span> <span class="n">instrumentationAgent</span> <span class="o">=</span> <span class="n">instrumentationResource</span><span class="o">.</span><span class="na">getInstrumentationAgent</span><span class="o">();</span>

        <span class="nc">ModelMBeanAssembler</span> <span class="n">modelMBeanAssembler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelMBeanAssembler</span><span class="o">();</span>
        <span class="nc">ModelMBeanInfo</span> <span class="n">modelMBeanInfo</span> <span class="o">=</span> <span class="n">modelMBeanAssembler</span><span class="o">.</span><span class="na">getModelMbeanInfo</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">requiredModelMBean</span> <span class="o">=</span> <span class="n">instrumentationAgent</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ObjectName</span><span class="o">(</span><span class="s">"org.smooks:type=app,name=MyClass"</span><span class="o">),</span> <span class="n">modelMBeanInfo</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMyNotification</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MBeanException</span> <span class="o">{</span>
        <span class="nc">Notification</span> <span class="n">notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">(</span><span class="s">"My Notification"</span><span class="o">,</span> <span class="n">requiredModelMBean</span><span class="o">,</span> <span class="n">sequenceNumber</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">requiredModelMBean</span><span class="o">.</span><span class="na">sendNotification</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendAnotherNotification</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MBeanException</span> <span class="o">{</span>
        <span class="nc">Notification</span> <span class="n">notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">(</span><span class="s">"Another Notification"</span><span class="o">,</span> <span class="n">requiredModelMBean</span><span class="o">,</span> <span class="n">sequenceNumber</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">requiredModelMBean</span><span class="o">.</span><span class="na">sendNotification</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="consuming_writing_data">Consuming &amp; Writing Data</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="csv">CSV</h3>
<div class="paragraph">
<p>This example shows an XML resource configuration of a CSV reader:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:csv=</span><span class="s">"https://www.smooks.org/xsd/smooks/csv-1.7.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--
        Configure the CSV to parse the message into a stream of SAX events.
    --&gt;</span>
    <span class="nt">&lt;csv:reader</span> <span class="na">fields=</span><span class="s">"firstname,lastname,gender,age,country"</span> <span class="na">separator=</span><span class="s">"|"</span> <span class="na">quote=</span><span class="s">"'"</span> <span class="na">skipLines=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration will generate an event stream of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;csv-set&gt;</span>
    <span class="nt">&lt;csv-record&gt;</span>
        <span class="nt">&lt;firstname&gt;</span>Tom<span class="nt">&lt;/firstname&gt;</span>
        <span class="nt">&lt;lastname&gt;</span>Fennelly<span class="nt">&lt;/lastname&gt;</span>
        <span class="nt">&lt;gender&gt;</span>Male<span class="nt">&lt;/gender&gt;</span>
        <span class="nt">&lt;age&gt;</span>21<span class="nt">&lt;/age&gt;</span>
        <span class="nt">&lt;country&gt;</span>Ireland<span class="nt">&lt;/country&gt;</span>
    <span class="nt">&lt;/csv-record&gt;</span>
    <span class="nt">&lt;csv-record&gt;</span>
        <span class="nt">&lt;firstname&gt;</span>Tom<span class="nt">&lt;/firstname&gt;</span>
        <span class="nt">&lt;lastname&gt;</span>Fennelly<span class="nt">&lt;/lastname&gt;</span>
        <span class="nt">&lt;gender&gt;</span>Male<span class="nt">&lt;/gender&gt;</span>
        <span class="nt">&lt;age&gt;</span>21<span class="nt">&lt;/age&gt;</span>
        <span class="nt">&lt;country&gt;</span>Ireland<span class="nt">&lt;/country&gt;</span>
    <span class="nt">&lt;/csv-record&gt;</span>
<span class="nt">&lt;/csv-set&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="defining_fields">Defining fields</h4>
<div class="paragraph">
<p>Fields can be defined in either of two ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the <code>fields</code> attribute of the <code>&lt;csv:reader&gt;</code> configuration (as shown above).</p>
</li>
<li>
<p>As the first record in the message after setting the <code>fieldsInMessage</code> attribute of the <code>&lt;csv:reader&gt;</code> configuration to <code>true</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The field names must follow the same naming rules like XML element names:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Names can contain letters, numbers, and other characters</p>
</li>
<li>
<p>Names cannot start with a number or punctuation character</p>
</li>
<li>
<p>Names cannot start with the letters xml (or XML, or Xml, etc&#8230;&#8203;)</p>
</li>
<li>
<p>Names cannot contain spaces</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By setting the <code>rootElementName</code> and <code>recordElementName</code> attributes you can modify the and element names. The same naming rules apply for these names.</p>
</div>
<div class="sect4">
<h5 id="multi_record_field_definitions">Multi-Record Field Definitions</h5>
<div class="paragraph">
<p>All Flat File based reader configurations (including the CSV reader) support <em>Multi-Record Field Definitions</em>, which means that the reader can support CSV message streams containing varying (multiple different types) CSV record types.</p>
</div>
<div class="paragraph">
<p>Take the following CSV message example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>book,22 Britannia Road,Amanda Hodgkinson
magazine,Time,April,2011
magazine,Irish Garden,Jan,2011
book,The Finkler Question,Howard Jacobson</pre>
</div>
</div>
<div class="paragraph">
<p>In this stream, we have 2 record types of "book" and "magazine". We configure the CSV reader to process this stream as follows:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;csv:reader</span> <span class="na">fields=</span><span class="s">"book[name,author] | magazine[*]"</span> <span class="na">rootElementName=</span><span class="s">"sales"</span> <span class="na">indent=</span><span class="s">"true"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This reader configuration will generate the following output for the above sample message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;sales&gt;</span>
    <span class="nt">&lt;book</span> <span class="na">number=</span><span class="s">"1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;name&gt;</span>22 Britannia Road<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;author&gt;</span>Amanda Hodgkinson<span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;/book&gt;</span>
    <span class="nt">&lt;magazine</span> <span class="na">number=</span><span class="s">"2"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;field_0&gt;</span>Time<span class="nt">&lt;/field_0&gt;</span>
        <span class="nt">&lt;field_1&gt;</span>April<span class="nt">&lt;/field_1&gt;</span>
        <span class="nt">&lt;field_2&gt;</span>2011<span class="nt">&lt;/field_2&gt;</span>
    <span class="nt">&lt;/magazine&gt;</span>
    <span class="nt">&lt;magazine</span> <span class="na">number=</span><span class="s">"3"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;field_0&gt;</span>Irish Garden<span class="nt">&lt;/field_0&gt;</span>
        <span class="nt">&lt;field_1&gt;</span>Jan<span class="nt">&lt;/field_1&gt;</span>
        <span class="nt">&lt;field_2&gt;</span>2011<span class="nt">&lt;/field_2&gt;</span>
    <span class="nt">&lt;/magazine&gt;</span>
    <span class="nt">&lt;book</span> <span class="na">number=</span><span class="s">"4"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;name&gt;</span>The Finkler Question<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;author&gt;</span>Howard Jacobson<span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;/book&gt;</span>
<span class="nt">&lt;/sales&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the syntax in the <code>fields</code> attribute. Each record definition is separated by the pipe character <code>|</code>. Each record definition is constructed as <em>record-name[field-name,field-name]</em>. <em>record-name</em> is matched against the first field in the incoming message and so used to select the appropriate record definition to be used for outputting that record. Also note how you can use an astrix character ('*') when you don&#8217;t want to name the record fields. In this case (as when extra/unexpected fields are present in a record), the reader will generate the output field elements using a generated element name e.g. "field_0", "field_1", etc&#8230;&#8203; See the "magazine" record in the previous example.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Multi Record Field Definitions are not supported when the fields are defined in the message (<code>fieldsInMessage="true"</code>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="string_manipulation_functions">String Manipulation Functions</h5>
<div class="paragraph">
<p>Like the fixed-length cartridge, string manipulation functions can be defined per field. These functions are executed before that the data is converted into SAX events. The functions are defined after field name, separated with a question mark.</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:csv=</span><span class="s">"https://www.smooks.org/xsd/smooks/csv-1.7.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;csv:reader</span> <span class="na">fields=</span><span class="s">"lastname?trim.capitalize,country?upper_case"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Take a look at the fixed-length cartridge&#8217;s <a href="https://github.com/smooks/smooks-fixed-length-cartridge/blob/master/README.adoc#string-manipulation-functions">string manipulation functions</a> to learn about the available functions and how the functions can be chained.</p>
</div>
</div>
<div class="sect4">
<h5 id="ignoring_fields">Ignoring Fields</h5>
<div class="paragraph">
<p>One or more fields of a CSV record can be ignored by specifying the <code>$ignore$</code> token in the fields configuration value. You can specify the number of fields to be ignored simply by following the $ignore$ token with a number e.g. <code>$ignore$3</code> to ignore the next 3 fields. <code>$ignore$+</code> ignores all fields to the end of the CSV record.</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:csv=</span><span class="s">"https://www.smooks.org/xsd/smooks/csv-1.7.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;csv:reader</span> <span class="na">fields=</span><span class="s">"firstname,$ignore$2,age,$ignore$+"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="binding_csv_records_to_java">Binding CSV Records to Java</h5>
<div class="paragraph">
<p>Smooks v1.2 added support for making the binding of CSV records to Java objects a very trivial task. You no longer need to use the Javabean Cartridge directly (i.e. Smooks main Java binding functionality).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This feature is not supported for Multi Record Field Definitions (see above), or when the fields are defined in the incoming message (<code>fieldsInMessage="true"</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A Persons CSV record set such as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Tom,Fennelly,Male,4,Ireland
Mike,Fennelly,Male,2,Ireland</pre>
</div>
</div>
<div class="paragraph">
<p>Can be bound to a Person of (no getters/setters):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">country</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Gender</span> <span class="n">gender</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">Gender</span> <span class="o">{</span>
    <span class="nc">Male</span><span class="o">,</span>
    <span class="nc">Female</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using a config of the form:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:csv=</span><span class="s">"https://www.smooks.org/xsd/smooks/csv-1.7.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;csv:reader</span> <span class="na">fields=</span><span class="s">"firstname,lastname,gender,age,country"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- Note how the field names match the property names on the Person class. --&gt;</span>
        <span class="nt">&lt;csv:listBinding</span> <span class="na">beanId=</span><span class="s">"people"</span> <span class="na">class=</span><span class="s">"org.smooks.csv.Person"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/csv:reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To execute this configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">configStream</span><span class="o">);</span>
<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">csvStream</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"people"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Smooks also supports creation of Maps from the CSV record set:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:csv=</span><span class="s">"https://www.smooks.org/xsd/smooks/csv-1.7.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;csv:reader</span> <span class="na">fields=</span><span class="s">"firstname,lastname,gender,age,country"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;csv:mapBinding</span> <span class="na">beanId=</span><span class="s">"people"</span> <span class="na">class=</span><span class="s">"org.smooks.csv.Person"</span> <span class="na">keyField=</span><span class="s">"firstname"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/csv:reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration would produce a map of Person instances, keyed by the "firstname" value of each Person. It would be executed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">configStream</span><span class="o">);</span>
<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">csvStream</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"people"</span><span class="o">);</span>

<span class="nc">Person</span> <span class="n">tom</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Tom"</span><span class="o">);</span>
<span class="nc">Person</span> <span class="n">mike</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Mike"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#virtual-object-models-maps&#8212;&#8203;lists">Virtual Models</a> are also supported, so you can define the <code>class</code> attribute as a <code>java.util.Map</code> and have the CSV field values bound into Map instances, which are in turn added to a List or a Map.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="java_api">Java API</h4>
<div class="paragraph">
<p>Programmatically configuring the CSV Reader on a Smooks instance is trivial. A number of options are available.</p>
</div>
<div class="sect4">
<h5 id="configuring_directly_on_the_smooks_instance">Configuring Directly on the Smooks Instance</h5>
<div class="paragraph">
<p>The following code configures a Smooks instance with a <code>CSVReader</code> for reading a people record set (see above), binding the record set into a List of Person instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">setReaderConfig</span><span class="o">(</span><span class="k">new</span> <span class="nc">CSVReaderConfigurator</span><span class="o">(</span><span class="s">"firstname,lastname,gender,age,country"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">setBinding</span><span class="o">(</span><span class="k">new</span> <span class="nc">CSVBinding</span><span class="o">(</span><span class="s">"people"</span><span class="o">,</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">CSVBindingType</span><span class="o">.</span><span class="na">LIST</span><span class="o">)));</span>

<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">csvReader</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"people"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course configuring the Java binding is totally optional. The Smooks instance could instead (or in conjunction with) be programmatically configured with other visitors for carrying out other forms of processing on the CSV record set.</p>
</div>
</div>
<div class="sect4">
<h5 id="csv_list_and_map_binders">CSV List and Map Binders</h5>
<div class="paragraph">
<p>If you&#8217;re just interested in binding CSV records directly onto a <code>List</code> or <code>Map</code> of a Java type that reflects the data in your CSV records, then you can use the <code>CSVListBinder</code> or <code>CSVMapBinder</code> classes.</p>
</div>
<div class="paragraph">
<p>CSVListBinder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Note: The binder instance should be cached and reused...</span>
<span class="nc">CSVListBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CSVListBinder</span><span class="o">(</span><span class="s">"firstname,lastname,gender,age,country"</span><span class="o">,</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">csvStream</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>CSVMapBinder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Note: The binder instance should be cached and reused...</span>
<span class="nc">CSVMapBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CSVMapBinder</span><span class="o">(</span><span class="s">"firstname,lastname,gender,age,country"</span><span class="o">,</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"firstname"</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">csvStream</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need more control over the binding process, revert back to the lower level APIs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#configuring-directly-on-the-smooks-instance">Configuring Directly on the Smooks Instance</a></p>
</li>
<li>
<p><a href="#java-binding">Java Binding</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven_coordinates_2">Maven Coordinates</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-csv-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml_namespace">XML Namespace</h4>
<div class="literalblock">
<div class="content">
<pre>xmlns:csv="https://www.smooks.org/xsd/smooks/csv-1.7.xsd"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fixed_length">Fixed-Length</h3>
<div class="paragraph">
<p>A simple/basic fixed-length reader configuration:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:fl=</span><span class="s">"https://www.smooks.org/xsd/smooks/fixed-length-1.4.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Configure the fixed-length reader to parse the message into a stream of SAX events. --&gt;</span>
    <span class="nt">&lt;fl:reader</span> <span class="na">fields=</span><span class="s">"firstname[10],lastname[10],gender[1],age[2],country[2]"</span> <span class="na">skipLines=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example input file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#HEADER
Tom       Fennelly  M 21 IE
Maurice  Zeijen     M 27 NL</pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration will generate an event stream of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;set&gt;</span>
    <span class="nt">&lt;record&gt;</span>
        <span class="nt">&lt;firstname&gt;</span>Tom       <span class="nt">&lt;/firstname&gt;</span>
        <span class="nt">&lt;lastname&gt;</span>Fennelly  <span class="nt">&lt;/lastname&gt;</span>
        <span class="nt">&lt;gender&gt;</span>M<span class="nt">&lt;/gender&gt;</span>
        <span class="nt">&lt;age&gt;</span> 21<span class="nt">&lt;/age&gt;</span>
        <span class="nt">&lt;country&gt;</span>IE<span class="nt">&lt;/country&gt;</span>
    <span class="nt">&lt;/record&gt;</span>
    <span class="nt">&lt;record&gt;</span>
        <span class="nt">&lt;firstname&gt;</span>Maurice  <span class="nt">&lt;/firstname&gt;</span>
        <span class="nt">&lt;lastname&gt;</span>Zeijen     <span class="nt">&lt;/lastname&gt;</span>
        <span class="nt">&lt;gender&gt;</span>M<span class="nt">&lt;/gender&gt;</span>
        <span class="nt">&lt;age&gt;</span>27<span class="nt">&lt;/age&gt;</span>
        <span class="nt">&lt;country&gt;</span>NL<span class="nt">&lt;/country&gt;</span>
    <span class="nt">&lt;/record&gt;</span>
<span class="nt">&lt;/set&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="defining_fields_2">Defining fields</h4>
<div class="paragraph">
<p>Fields are defined in the 'fields' attribute as a comma separated list of names and field lengths. The field lengths must be defined between the brackets after the field name (see the example above).</p>
</div>
<div class="paragraph">
<p>The field names must follow the same naming rules like XML element names:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Names can contain letters, numbers, and other characters</p>
</li>
<li>
<p>Names cannot start with a number or punctuation character</p>
</li>
<li>
<p>Names cannot start with the letters xml (or XML, or Xml, etc&#8230;&#8203;)</p>
</li>
<li>
<p>Names cannot contain spaces</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By setting the <code>rootElementName</code> and <code>recordElementName</code> attributes you can modify the and element names. The same naming rules apply for these names.</p>
</div>
<div class="sect4">
<h5 id="string_manipulation_functions_2">String manipulation functions</h5>
<div class="paragraph">
<p>String manipulation functions can be defined per field. These functions are executed before that the data is converted into SAX events. The functions are defined after the field length definitions and are optionally separated with a question mark.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:fl=</span><span class="s">"https://www.smooks.org/xsd/smooks/fixed-length-1.4.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Configure the fixed-length reader to parse the message into a stream of SAX events.  --&gt;</span>
    <span class="nt">&lt;fl:reader</span> <span class="na">fields=</span><span class="s">"firstname[10]?trim,lastname[10]trim.capitalize,gender[1],age[2],country[2]"</span> <span class="na">skipLines=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following functions are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>upper_case</code>: Returns the upper case version of the string.</p>
</li>
<li>
<p><code>lower_case</code>: Returns the lower case version of the string.</p>
</li>
<li>
<p><code>cap_first</code>: Returns the string with the very first word of the string capitalized.</p>
</li>
<li>
<p><code>uncap_first</code>: Returns the string with the very first word of the string un-capitalized. The opposite to <code>cap_first</code>.</p>
</li>
<li>
<p><code>capitalize</code>: Returns the string with all words capitalized.</p>
</li>
<li>
<p><code>trim</code>: Returns the string without leading and trailing white-spaces.</p>
</li>
<li>
<p><code>left_trim</code>: Returns the string without leading white-spaces.</p>
</li>
<li>
<p><code>right_trim</code>: Returns the string without trailing white-spaces.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Functions can be chained via the point separator: <code>trim.upper_case</code>. It depends on the reader how the functions are defined per field. Please look at the individual chapters of the readers for that information.</p>
</div>
</div>
<div class="sect4">
<h5 id="ignoring_fields_2">Ignoring Fields</h5>
<div class="paragraph">
<p>Characters ranges of a fixed-length record can be ignored by specifying the <code>$ignore$[10]</code> token in the fields configuration value. You must specify the number of characters that need be ignored, just as a normal field.</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:fl=</span><span class="s">"https://www.smooks.org/xsd/smooks/fixed-length-1.4.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;fl:reader</span> <span class="na">fields=</span><span class="s">"firstname,$ignore$[2],age,$ignore$[10]"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binding_fixed_length_records_to_java">Binding Fixed-Length Records to Java</h4>
<div class="paragraph">
<p>Smooks v1.2 has added support for making the binding of fixed-length records to Java Objects a very trivial task. You don&#8217;t need to use the Javabean Cartridge directly (i.e. Smooks main Java binding functionality).</p>
</div>
<div class="paragraph">
<p>A Persons fixed-length record set such as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Tom       Fennelly  M 21 IE
Maurice  Zeijen     M 27 NL</pre>
</div>
</div>
<div class="paragraph">
<p>Can be bound to a Person of (no getters/setters):</p>
</div>
<div class="listingblock">
<div class="title">Person.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">country</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">gender</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using a config of the form:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:fl=</span><span class="s">"https://www.smooks.org/xsd/smooks/fixed-length-1.4.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;fl:reader</span> <span class="na">fields=</span><span class="s">"firstname[10]?trim,lastname[10]?trim,gende[1],age[3]?trim,country[2]"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- Note how the field names match the property names on the Person class. --&gt;</span>
        <span class="nt">&lt;fl:listBinding</span> <span class="na">beanId=</span><span class="s">"people"</span> <span class="na">class=</span><span class="s">"org.smooks.fixedlength.Person"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/fl:reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To execute this configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">configStream</span><span class="o">);</span>
<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">fixedLengthStream</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"people"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Smooks also supports creation of maps from the fixed-length record set:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:csv=</span><span class="s">"https://www.smooks.org/xsd/smooks/csv-1.7.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;csv:reader</span> <span class="na">fields=</span><span class="s">"firstname,lastname,gender,age,country"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;csv:mapBinding</span> <span class="na">beanId=</span><span class="s">"people"</span> <span class="na">class=</span><span class="s">"org.smooks.csv.Person"</span> <span class="na">keyField=</span><span class="s">"firstname"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/csv:reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration would produce a map of Person instances, keyed by the "firstname" value of each Person. It would be executed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="n">configStream</span><span class="o">);</span>
<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">fixedLengthStream</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"people"</span><span class="o">);</span>

<span class="nc">Person</span> <span class="n">tom</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Tom"</span><span class="o">);</span>
<span class="nc">Person</span> <span class="n">mike</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Maurice"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#virtual-object-models-maps&#8212;&#8203;lists">Virtual Models</a> are also supported, so you can define the <code>class</code> attribute as a <code>java.util.Map</code> and have the fixed-length field values bound into Map instances, which are in turn added to a list or a map.</p>
</div>
</div>
<div class="sect3">
<h4 id="java_api_2">Java API</h4>
<div class="paragraph">
<p>Programmatically configuring the FixedLengthReader on a Smooks instance is trivial. A number of options are available.</p>
</div>
<div class="sect4">
<h5 id="configuring_directly_on_the_smooks_instance_2">Configuring Directly on the Smooks Instance</h5>
<div class="paragraph">
<p>The following code configures a Smooks instance with a FixedLengthReader for reading a people record set (see above), binding the record set into a List of Person instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">setReaderConfig</span><span class="o">(</span><span class="k">new</span> <span class="nc">FixedLengthReaderConfigurator</span><span class="o">(</span><span class="s">"firstname,lastname,gender,age,country"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">setBinding</span><span class="o">(</span><span class="k">new</span> <span class="nc">FixedLengthBinding</span><span class="o">(</span><span class="s">"people"</span><span class="o">,</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">CSVBindingType</span><span class="o">.</span><span class="na">LIST</span><span class="o">)));</span>

<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">csvReader</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"people"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course configuring the Java Binding is totally optional. The Smooks instance could instead (or in conjunction with) be programmatically configured with other visitor for carrying out other forms of processing on the fixed-length record set.</p>
</div>
</div>
<div class="sect4">
<h5 id="fixed_length_list_map_binders">Fixed-Length List &amp; Map Binders</h5>
<div class="paragraph">
<p>If you&#8217;re just interested in binding fixed-length records directly onto a List or Map of a Java type that reflects the data in your fixed-length records, then you can use the <code>FixedLengthListBinder</code> or <code>FixedLengthMapBinder</code> classes.</p>
</div>
<div class="paragraph">
<p>FixedLengthListBinder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Note: The binder instance should be cached and reused...</span>
<span class="nc">FixedLengthListBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FixedLengthListBinder</span><span class="o">(</span><span class="s">"firstname[10]?trim,lastname[10]?trim,gender[1],age[3]?trim,country[2]"</span><span class="o">,</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">fixedLengthStream</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>FixedLengthMapBinder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Note: The binder instance should be cached and reused...</span>
<span class="nc">FixedLengthMapBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FixedLengthMapBinder</span><span class="o">(</span><span class="s">"firstname[10]?trim,lastname[10]?trim,gender[1],age[3]?trim,country[2]"</span><span class="o">,</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"firstname"</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">fixedLengthStream</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need more control over the binding process, revert back to the lower level APIs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#configuring-directly-on-the-smooks-instance">Configuring Directly on the Smooks Instance</a></p>
</li>
<li>
<p><a href="#java-binding">Java Binding</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven_coordinates_3">Maven Coordinates</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-fixed-length-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml_namespace_2">XML Namespace</h4>
<div class="literalblock">
<div class="content">
<pre>xmlns:fl="https://www.smooks.org/xsd/smooks/fixed-length-1.4.xsd"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dfdl">DFDL</h3>
<div class="paragraph">
<p>The DFDL cartridge opens up Smooks to an incredible number of data formats (e.g., SWIFT, ISO8583, HL7). In fact, this cartridge forms the foundations of the <a href="https://github.com/smooks/smooks-edi-cartridge">EDI and EDIFACT cartridges</a>. The DFDL cartridge deserializes (i.e., parses) non-XML data and serializes (i.e., unparses) XML according to the structure described in a <a href="https://daffodil.apache.org/docs/dfdl/">DFDL</a> schema. Take the subsequent DFDL schema as an example:</p>
</div>
<div class="listingblock">
<div class="title">csv.dfdl.xsd</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;xs:schema</span> <span class="na">xmlns:xs=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span> <span class="na">xmlns:fn=</span><span class="s">"http://www.w3.org/2005/xpath-functions"</span>
  <span class="na">xmlns:dfdl=</span><span class="s">"http://www.ogf.org/dfdl/dfdl-1.0/"</span> <span class="na">xmlns:ex=</span><span class="s">"http://example.com"</span>
  <span class="na">targetNamespace=</span><span class="s">"http://example.com"</span> <span class="na">elementFormDefault=</span><span class="s">"unqualified"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;xs:include</span> <span class="na">schemaLocation=</span><span class="s">"org/apache/daffodil/xsd/DFDLGeneralFormat.dfdl.xsd"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;xs:annotation&gt;</span>
    <span class="nt">&lt;xs:appinfo</span> <span class="na">source=</span><span class="s">"http://www.ogf.org/dfdl/"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;dfdl:format</span> <span class="na">ref=</span><span class="s">"ex:GeneralFormat"</span> <span class="na">separator=</span><span class="s">""</span> <span class="na">initiator=</span><span class="s">""</span>
        <span class="na">terminator=</span><span class="s">""</span> <span class="na">textTrimKind=</span><span class="s">"none"</span> <span class="na">initiatedContent=</span><span class="s">"no"</span> <span class="na">ignoreCase=</span><span class="s">"no"</span>
        <span class="na">separatorPosition=</span><span class="s">"infix"</span> <span class="na">occursCountKind=</span><span class="s">"implicit"</span>
        <span class="na">emptyValueDelimiterPolicy=</span><span class="s">"both"</span> <span class="na">representation=</span><span class="s">"text"</span> <span class="na">textNumberRep=</span><span class="s">"standard"</span>
        <span class="na">lengthKind=</span><span class="s">"delimited"</span> <span class="na">encoding=</span><span class="s">"ASCII"</span> <span class="na">encodingErrorPolicy=</span><span class="s">"error"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/xs:appinfo&gt;</span>
  <span class="nt">&lt;/xs:annotation&gt;</span>

  <span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"file"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;xs:complexType&gt;</span>
      <span class="nt">&lt;xs:sequence</span> <span class="na">dfdl:separator=</span><span class="s">"%NL;"</span> <span class="na">dfdl:separatorPosition=</span><span class="s">"postfix"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"header"</span> <span class="na">minOccurs=</span><span class="s">"0"</span> <span class="na">maxOccurs=</span><span class="s">"1"</span>
          <span class="na">dfdl:occursCountKind=</span><span class="s">"implicit"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;xs:complexType&gt;</span>
            <span class="nt">&lt;xs:sequence</span> <span class="na">dfdl:separator=</span><span class="s">","</span><span class="nt">&gt;</span>
              <span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"title"</span> <span class="na">type=</span><span class="s">"xs:string"</span> <span class="na">maxOccurs=</span><span class="s">"unbounded"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/xs:sequence&gt;</span>
          <span class="nt">&lt;/xs:complexType&gt;</span>
        <span class="nt">&lt;/xs:element&gt;</span>
        <span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"record"</span> <span class="na">maxOccurs=</span><span class="s">"unbounded"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;xs:complexType&gt;</span>
            <span class="nt">&lt;xs:sequence</span> <span class="na">dfdl:separator=</span><span class="s">","</span><span class="nt">&gt;</span>
              <span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"item"</span> <span class="na">type=</span><span class="s">"xs:string"</span> <span class="na">maxOccurs=</span><span class="s">"unbounded"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/xs:sequence&gt;</span>
          <span class="nt">&lt;/xs:complexType&gt;</span>
        <span class="nt">&lt;/xs:element&gt;</span>
      <span class="nt">&lt;/xs:sequence&gt;</span>
    <span class="nt">&lt;/xs:complexType&gt;</span>
  <span class="nt">&lt;/xs:element&gt;</span>
<span class="nt">&lt;/xs:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This schema describes the structure of CSV data like the one below:</p>
</div>
<div class="listingblock">
<div class="title">input.csv</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csv">last,first,middle,DOB
smith,robert,brandon,1988-03-24
johnson,john,henry,1986-01-23
jones,arya,cat,1986-02-19</code></pre>
</div>
</div>
<div class="paragraph">
<p>A Smooks config parsing the above CSV using the DFDL cartridge would be written as:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:parser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span><span class="nt">/&gt;</span>

    ...

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>dfdl:parser</code> is a reader and its <code>schemaUri</code> attribute references the DFDL schema driving the parsing behaviour. Assuming <em>input.csv</em> is the source, <code>dfdl:parser</code> will generate the event stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ex:file</span> <span class="na">xmlns:ex=</span><span class="s">"http://example.com"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;title&gt;</span>last<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;title&gt;</span>first<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;title&gt;</span>middle<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;title&gt;</span>DOB<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;record&gt;</span>
        <span class="nt">&lt;item&gt;</span>smith<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>robert<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>brandon<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>1988-03-24<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/record&gt;</span>
    <span class="nt">&lt;record&gt;</span>
        <span class="nt">&lt;item&gt;</span>johnson<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>john<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>henry<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>1986-01-23<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/record&gt;</span>
    <span class="nt">&lt;record&gt;</span>
        <span class="nt">&lt;item&gt;</span>jones<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>arya<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>cat<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>1986-02-19<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/record&gt;</span>
<span class="nt">&lt;/ex:file&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Shown in the next snippet is a <a href="https://github.com/smooks/smooks/blob/master/README.adoc#pipeline">pipeline</a> enclosing the <code>dfdl:unparser</code> visitor:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    ...

    <span class="nt">&lt;core:smooks</span> <span class="na">filterSourceOn=</span><span class="s">"#document"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;core:action&gt;</span>
            <span class="nt">&lt;core:inline&gt;</span>
                <span class="nt">&lt;core:replace/&gt;</span>
            <span class="nt">&lt;/core:inline&gt;</span>
        <span class="nt">&lt;/core:action&gt;</span>
        <span class="nt">&lt;core:config&gt;</span>
            <span class="nt">&lt;smooks-resource-list&gt;</span>
                <span class="nt">&lt;dfdl:unparser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span> <span class="na">unparseOnNode=</span><span class="s">"*"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/smooks-resource-list&gt;</span>
        <span class="nt">&lt;/core:config&gt;</span>
    <span class="nt">&lt;/core:smooks&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In contrast to the <code>dfdl:parser</code> <code>schemaUri</code> attribute , the <code>schemaUri</code> schema in <code>dfdl:unparser</code> drives the unparsing behaviour. <code>dfdl:unparser</code> replaces each node in the event stream with its serialized CSV counterpart, essentially implementing a pass-through application.</p>
</div>
<div class="paragraph">
<p>The DFDL cartridge supports variables, on disk caching, and trace debugging. Consult the <a href="src/main/resources/META-INF/xsd/smooks/dfdl-1.0.xsd">XSD documentation</a> for further information. It is strongly advised to learn DFDL before authoring a DFDL schema. Resources to get started with DFDL include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://ogf.org/ogf/doku.php/standards/dfdl/dfdl">Open Grid Forum DFDL page</a></p>
</li>
<li>
<p><a href="https://daffodil.apache.org/community/">Apache Daffodil user mailing list</a></p>
</li>
<li>
<p><a href="https://daffodil.apache.org/docs/dfdl/">DFDL specification</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="parser_reader_options">Parser reader options</h4>
<div class="sect4">
<h5 id="indent">Indent</h5>
<div class="paragraph">
<p>Indent the generated event stream to make it easier to read. Useful for troubleshooting. The default value is <code>false</code>. Example:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:parser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span> <span class="na">indent=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cache_on_disk">Cache on disk</h5>
<div class="paragraph">
<p>Persist DFDL schema on disk to reduce compilation time in subsequent runs. The default value is <code>false</code>. Example:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:parser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span> <span class="na">cacheOnDisk=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="validation_mode">Validation mode</h5>
<div class="paragraph">
<p>Validation modes for validating the resulting infoset against the DFDL schema. The following values are supported:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Off</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Turn off all validation against the DFDL schema.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limited</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Perform XSD validation of facets, minLength, maxLength, enumeration, minInclusive, minExclusive, maxInclusive, maxExclusive, and maxOccurs constraints. Validation failures will be printed in the log but will not interrupt parsing or unparsing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Full</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Perform full schema validation using Xerces. A validation failure will abort parsing and throw a <code>org.smooks.api.SmooksException</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The default value is <code>Off</code>. Example:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:parser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span> <span class="na">validationMode=</span><span class="s">"Limited"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Validation failures can be retrieved from the Smooks execution context as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">...</span>

<span class="n">org</span><span class="o">.</span><span class="na">smooks</span><span class="o">.</span><span class="na">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">smooks</span><span class="o">.</span><span class="na">Smooks</span><span class="o">();</span>
<span class="n">org</span><span class="o">.</span><span class="na">smooks</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">ExecutionContext</span> <span class="n">executionContext</span> <span class="o">=</span> <span class="n">smooks</span><span class="o">.</span><span class="na">createExecutionContext</span><span class="o">();</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span> <span class="n">source</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">daffodil</span><span class="o">.</span><span class="na">japi</span><span class="o">.</span><span class="na">Diagnostic</span><span class="o">&gt;</span> <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">executionContext</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">smooks</span><span class="o">.</span><span class="na">cartridges</span><span class="o">.</span><span class="na">dfdl</span><span class="o">.</span><span class="na">parser</span><span class="o">.</span><span class="na">DfdlParser</span><span class="o">.</span><span class="na">DIAGNOSTICS_TYPED_KEY</span><span class="o">);</span>
<span class="o">...</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="debugging">Debugging</h5>
<div class="paragraph">
<p>Enable/disable trace debugging. The default value is <code>false</code>. Example:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:parser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span> <span class="na">debugging=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="schematron_validation">Schematron validation</h5>
<div class="paragraph">
<p>Apply standalone or embedded <a href="https://www.schematron.com/">Schematron</a> rules within the DFDL schema. Note that Schematron validation leads to the <a href="https://issues.apache.org/jira/browse/DAFFODIL-2386">input stream being loaded into memory</a> therefore such validation is not recommended for large streams.</p>
</div>
<div class="paragraph">
<p>Standalone Schematron rules are applied like this:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:parser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;dfdl:schematron</span> <span class="na">url=</span><span class="s">"rules.sch"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/dfdl:parser&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Embedded rules are applied as follows:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:parser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;dfdl:schematron/&gt;</span>
    <span class="nt">&lt;/dfdl:parser&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="unparser_visitor_options">Unparser visitor options</h4>
<div class="sect4">
<h5 id="cache_on_disk_2">Cache on disk</h5>
<div class="paragraph">
<p>Persist DFDL schema on disk to reduce compilation time in subsequent runs. The default value is <code>false</code>. Example:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:unparser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span> <span class="na">unparseOnNode=</span><span class="s">"*"</span> <span class="na">cacheOnDisk=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="validation_mode_2">Validation mode</h5>
<div class="paragraph">
<p>Validation modes for validating the input infoset against the DFDL schema. The following values are supported:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Off</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Turn off all validation against the DFDL schema.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limited</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Perform XSD validation of facets, minLength, maxLength, enumeration, minInclusive, minExclusive, maxInclusive, maxExclusive, and maxOccurs constraints. Validation failures will be printed in the log but will not interrupt parsing or unparsing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Full</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Perform full schema validation using Xerces. A validation failure will abort unparsing and throw a <code>org.smooks.api.SmooksException</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The default value is <code>Off</code>. Example:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:unparser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span> <span class="na">unparseOnNode=</span><span class="s">"*"</span> <span class="na">validationMode=</span><span class="s">"Limited"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="debugging_2">Debugging</h5>
<div class="paragraph">
<p>Enable/disable trace debugging. The default value is <code>false</code>. Example:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:dfdl=</span><span class="s">"https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dfdl:unparser</span> <span class="na">schemaUri=</span><span class="s">"/csv.dfdl.xsd"</span> <span class="na">unparseOnNode=</span><span class="s">"*"</span> <span class="na">debugging=</span><span class="s">"true"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven_coordinates_4">Maven Coordinates</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-dfdl-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml_namespace_3">XML Namespace</h4>
<div class="literalblock">
<div class="content">
<pre>xmlns:dfdl="https://www.smooks.org/xsd/smooks/dfdl-1.0.xsd"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="edi">EDI</h3>
<div class="paragraph">
<p>The EDI cartridge inherits from the <a href="https://github.com/smooks/smooks-javabean-cartridge/blob/master/README.adoc">DFDL cartridge</a> to provide a reader for parsing EDI documents, and a visitor for serialising the event stream into EDI. Many of the options that are available from the DFDL cartridge are supported in the EDI cartridge as well (e.g., <a href="https://github.com/smooks/smooks-dfdl-cartridge#validation-mode">validation mode</a>).</p>
</div>
<div class="paragraph">
<p>In the following pass-through configuration, Smooks parses an EDI document and then serialises, or unparses in DFDL nomenclature, the generated event stream to produce an EDI document identical to the parsed document.</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:edi=</span><span class="s">"https://www.smooks.org/xsd/smooks/edi-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Configure the reader to parse the EDI stream into a stream of SAX events. --&gt;</span>
    <span class="nt">&lt;edi:parser</span> <span class="na">schemaUri=</span><span class="s">"/edi-to-xml-mapping.dfdl.xsd"</span> <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="na">segmentTerminator=</span><span class="s">"%NL;"</span> <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="na">compositeDataElementSeparator=</span><span class="s">"^"</span><span class="nt">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="c">&lt;!-- Apply a pipeline on the root event and replace the XML result produced from &lt;edifact:parser .../&gt; with the pipeline EDI result. --&gt;</span>
    <span class="nt">&lt;core:smooks</span> <span class="na">filterSourceOn=</span><span class="s">"/Order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;core:action&gt;</span>
            <span class="nt">&lt;core:inline&gt;</span>
                <span class="nt">&lt;core:replace/&gt;</span>
            <span class="nt">&lt;/core:inline&gt;</span>
        <span class="nt">&lt;/core:action&gt;</span>
        <span class="nt">&lt;core:config&gt;</span>
            <span class="nt">&lt;smooks-resource-list&gt;</span>
                <span class="c">&lt;!-- Configure the writer to serialise the event stream into EDI. --&gt;</span>
                <span class="nt">&lt;edi:unparser</span> <span class="na">schemaUri=</span><span class="s">"/edi-to-xml-mapping.dfdl.xsd"</span> <i class="conum" data-value="1"></i><b>(1)</b>
                              <span class="na">segmentTerminator=</span><span class="s">"%NL;"</span> <i class="conum" data-value="2"></i><b>(2)</b>
                              <span class="na">compositeDataElementSeparator=</span><span class="s">"^"</span> <i class="conum" data-value="3"></i><b>(3)</b>
                              <span class="na">unparseOnNode=</span><span class="s">"*"</span><span class="nt">/&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="nt">&lt;/smooks-resource-list&gt;</span>
        <span class="nt">&lt;/core:config&gt;</span>
    <span class="nt">&lt;/core:smooks&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Config attributes common to the parser and unparser resources are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>schemaUri</em>: the DFDL schema describing the structure of the EDI document to be parser or unparsed.</p>
</li>
<li>
<p><em>segmentTerminator</em>: the terminator for groups of related data elements. DFDL interprets <em>%NL;</em> as a newline.</p>
</li>
<li>
<p><em>compositeDataElementSeparator</em>: the delimiter for compound data elements.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>unparseOnNode</code> attribute is exclusive to the unparser visitor. It tells the unparser which event to intercept and serialise. Consult  with the EDI cartridge&#8217;s <a href="/xsd/smooks/edi-2.0.xsd">XSD documentation</a> for the complete list of config attributes and elements.</p>
</div>
<div class="sect3">
<h4 id="edi_dfdl_schema">EDI DFDL Schema</h4>
<div class="paragraph">
<p>The user-defined DFDL schema supplied to the <em>parser</em> and <em>unparser</em> config elements  drives the event mapping, whether it is EDI to SAX or SAX to EDI. This schema must import the bundled <em>IBM_EDI_Format.dfdl.xsd</em> DFDL schema which defines common EDI constructs like segments and data elements.</p>
</div>
<div class="paragraph">
<p>The following figure illustrates the mapping process:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks-edi-cartridge/master/docs/images/Edi-mapping.svg" alt="Image:Edi-mapping.svg"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>input-message.edi</em> is the input/output EDI document.</p>
</li>
<li>
<p><em>edi-to-xml-order-mapping.dfdl.xsd</em> describes the EDI to SAX, or SAX to EDI, event mapping.</p>
</li>
<li>
<p><em>expected.xml</em> is the result event stream from applying the mapping.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="segments">Segments</h5>
<div class="paragraph">
<p>The next snippet shows a segment declaration in DFDL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>
<span class="nt">&lt;xsd:schema</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span>
            <span class="na">xmlns:dfdl=</span><span class="s">"http://www.ogf.org/dfdl/dfdl-1.0/"</span>
            <span class="na">xmlns:ibmEdiFmt=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xsd:import</span> <span class="na">namespace=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span> <span class="na">schemaLocation=</span><span class="s">"/EDIFACT-Common/IBM_EDI_Format.dfdl.xsd"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xsd:annotation&gt;</span>
        <span class="nt">&lt;xsd:appinfo</span> <span class="na">source=</span><span class="s">"http://www.ogf.org/dfdl/"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;dfdl:format</span> <span class="na">ref=</span><span class="s">"ibmEdiFmt:EDIFormat"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/xsd:appinfo&gt;</span>
    <span class="nt">&lt;/xsd:annotation&gt;</span>

    <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"HDR"</span> <i class="conum" data-value="1"></i><b>(1)</b>
                 <span class="na">name=</span><span class="s">"header"</span> <i class="conum" data-value="2"></i><b>(2)</b>
                 <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span><span class="nt">&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nt">&lt;xsd:complexType&gt;</span>
            ...
        <span class="nt">&lt;/xsd:complexType&gt;</span>
    <span class="nt">&lt;/xsd:element&gt;</span>
<span class="nt">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>dfdl:initiator</em> identifies the segment code .</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>name</em> attribute specifies the segment&#8217;s XML mapping.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>ibmEdiFmt:EDISegmentFormat</em> holds the segment structure definition; it is important to reference it from within the <em>dfdl:ref</em> attribute.</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="segment_cardinality">Segment Cardinality</h6>
<div class="paragraph">
<p>What is not demonstrated in the previous section is the segment element&#8217;s optional attributes <em>minOccurs</em> and <em>maxOccurs</em> (default value of 1 in both cases). These attributes can be used to control the optional and required characteristics of a segment. An <em>unbounded</em> maxOccurs indicates that the segment can repeat any number of times in that location of the EDI document.</p>
</div>
</div>
<div class="sect5">
<h6 id="segment_groups">Segment Groups</h6>
<div class="paragraph">
<p>You implicitly create segment groups when:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setting the "maxOccurs" in a segment element to more than one, and</p>
</li>
<li>
<p>Adding within the segment element other segment elements</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <em>HDR</em> segment in the next example is a segment group because it is unbounded, and it encloses the <em>CUS</em> and <em>ORD</em> segments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>
<span class="nt">&lt;xsd:schema</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span>
            <span class="na">xmlns:dfdl=</span><span class="s">"http://www.ogf.org/dfdl/dfdl-1.0/"</span>
            <span class="na">xmlns:ibmEdiFmt=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xsd:import</span> <span class="na">namespace=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span> <span class="na">schemaLocation=</span><span class="s">"/EDIFACT-Common/IBM_EDI_Format.dfdl.xsd"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xsd:annotation&gt;</span>
        <span class="nt">&lt;xsd:appinfo</span> <span class="na">source=</span><span class="s">"http://www.ogf.org/dfdl/"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;dfdl:format</span> <span class="na">ref=</span><span class="s">"ibmEdiFmt:EDIFormat"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/xsd:appinfo&gt;</span>
    <span class="nt">&lt;/xsd:annotation&gt;</span>

    <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"HDR"</span> <span class="na">name=</span><span class="s">"order"</span> <span class="na">maxOccurs=</span><span class="s">"unbounded"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;xsd:complexType&gt;</span>
            <span class="nt">&lt;xsd:sequence&gt;</span>
                <span class="nt">&lt;xsd:sequence</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span><span class="nt">&gt;</span>
                    ...
                <span class="nt">&lt;/xsd:sequence&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"CUS"</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span> <span class="na">name=</span><span class="s">"customer-details"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;xsd:complexType&gt;</span>
                        ...
                    <span class="nt">&lt;/xsd:complexType&gt;</span>
                <span class="nt">&lt;/xsd:element&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"ORD"</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span> <span class="na">name=</span><span class="s">"order-item"</span>
                             <span class="na">maxOccurs=</span><span class="s">"unbounded"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;xsd:complexType&gt;</span>
                        ...
                    <span class="nt">&lt;/xsd:complexType&gt;</span>
                <span class="nt">&lt;/xsd:element&gt;</span>
            <span class="nt">&lt;/xsd:sequence&gt;</span>
        <span class="nt">&lt;/xsd:complexType&gt;</span>
    <span class="nt">&lt;/xsd:element&gt;</span>
<span class="nt">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="data_elements">Data Elements</h5>
<div class="paragraph">
<p>Segment data elements are children within a sequence element referencing the DFDL format <em>ibmEdiFmt:EDISegmentSequenceFormat</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>
<span class="nt">&lt;xsd:schema</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span>
            <span class="na">xmlns:dfdl=</span><span class="s">"http://www.ogf.org/dfdl/dfdl-1.0/"</span>
            <span class="na">xmlns:ibmEdiFmt=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xsd:import</span> <span class="na">namespace=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span> <span class="na">schemaLocation=</span><span class="s">"/EDIFACT-Common/IBM_EDI_Format.dfdl.xsd"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xsd:annotation&gt;</span>
        <span class="nt">&lt;xsd:appinfo</span> <span class="na">source=</span><span class="s">"http://www.ogf.org/dfdl/"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;dfdl:format</span> <span class="na">ref=</span><span class="s">"ibmEdiFmt:EDIFormat"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/xsd:appinfo&gt;</span>
    <span class="nt">&lt;/xsd:annotation&gt;</span>

    <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"HDR"</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span> <span class="na">name=</span><span class="s">"header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;xsd:complexType&gt;</span>
            <span class="nt">&lt;xsd:sequence</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentSequenceFormat"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"order-id"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"status-code"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"net-amount"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"total-amount"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"tax"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"date"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/xsd:sequence&gt;</span>
        <span class="nt">&lt;/xsd:complexType&gt;</span>
    <span class="nt">&lt;/xsd:element&gt;</span>
<span class="nt">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each child <em>xsd:element</em> within <em>xsd:sequence</em> represents an EDI data element. The <em>name</em> attribute is the name of the target XML element capturing the data element&#8217;s value.</p>
</div>
<div class="sect5">
<h6 id="composite_data_elements">Composite Data Elements</h6>
<div class="paragraph">
<p>Data elements made up of components are yet another <em>xsd:sequence</em> referencing the DFDL format <em>ibmEdiFmt:EDICompositeSequenceFormat</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>
<span class="nt">&lt;xsd:schema</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span>
            <span class="na">xmlns:dfdl=</span><span class="s">"http://www.ogf.org/dfdl/dfdl-1.0/"</span>
            <span class="na">xmlns:ibmEdiFmt=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xsd:import</span> <span class="na">namespace=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span> <span class="na">schemaLocation=</span><span class="s">"/EDIFACT-Common/IBM_EDI_Format.dfdl.xsd"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xsd:annotation&gt;</span>
        <span class="nt">&lt;xsd:appinfo</span> <span class="na">source=</span><span class="s">"http://www.ogf.org/dfdl/"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;dfdl:format</span> <span class="na">ref=</span><span class="s">"ibmEdiFmt:EDIFormat"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/xsd:appinfo&gt;</span>
    <span class="nt">&lt;/xsd:annotation&gt;</span>

    <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"CUS"</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span> <span class="na">name=</span><span class="s">"customer-details"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;xsd:complexType&gt;</span>
            <span class="nt">&lt;xsd:sequence</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentSequenceFormat"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"name"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;xsd:complexType&gt;</span>
                        <span class="nt">&lt;xsd:sequence</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDICompositeSequenceFormat"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"firstname"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                            <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"lastname"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;/xsd:sequence&gt;</span>
                    <span class="nt">&lt;/xsd:complexType&gt;</span>
                <span class="nt">&lt;/xsd:element&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"state"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/xsd:sequence&gt;</span>
        <span class="nt">&lt;/xsd:complexType&gt;</span>
    <span class="nt">&lt;/xsd:element&gt;</span>
<span class="nt">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="imports">Imports</h5>
<div class="paragraph">
<p>Many EDI messages use the same segment definitions. Being able to define these segments once and import them into a top-level configuration saves on duplication. A simple configuration demonstrating the import feature would be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>
<span class="nt">&lt;xsd:schema</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span>
            <span class="na">xmlns:dfdl=</span><span class="s">"http://www.ogf.org/dfdl/dfdl-1.0/"</span>
            <span class="na">xmlns:ibmEdiFmt=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span>
            <span class="na">xmlns:def=</span><span class="s">"def"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xsd:import</span> <span class="na">namespace=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span> <span class="na">schemaLocation=</span><span class="s">"/EDIFACT-Common/IBM_EDI_Format.dfdl.xsd"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;xsd:import</span> <span class="na">namespace=</span><span class="s">"def"</span> <span class="na">schemaLocation=</span><span class="s">"example/edi-segment-definition.xml"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xsd:annotation&gt;</span>
        <span class="nt">&lt;xsd:appinfo</span> <span class="na">source=</span><span class="s">"http://www.ogf.org/dfdl/"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;dfdl:format</span> <span class="na">ref=</span><span class="s">"ibmEdiFmt:EDIFormat"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/xsd:appinfo&gt;</span>
    <span class="nt">&lt;/xsd:annotation&gt;</span>

    <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"Order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;xsd:complexType&gt;</span>
            <span class="nt">&lt;xsd:sequence&gt;</span>
                <span class="nt">&lt;xsd:sequence</span> <span class="na">dfdl:initiatedContent=</span><span class="s">"yes"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"HDR"</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span> <span class="na">name=</span><span class="s">"header"</span> <span class="na">type=</span><span class="s">"def:HDR"</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"CUS"</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span> <span class="na">name=</span><span class="s">"customer-details"</span> <span class="na">type=</span><span class="s">"def:CUS"</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"ORD"</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span> <span class="na">name=</span><span class="s">"order-item"</span> <span class="na">maxOccurs=</span><span class="s">"unbounded"</span> <span class="na">type=</span><span class="s">"def:ORD"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/xsd:sequence&gt;</span>
            <span class="nt">&lt;/xsd:sequence&gt;</span>
        <span class="nt">&lt;/xsd:complexType&gt;</span>
    <span class="nt">&lt;/xsd:element&gt;</span>
<span class="nt">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above schema demonstrates the use of the <em>import</em> element, where just about anything can be moved into its own file for reuse.</p>
</div>
</div>
<div class="sect4">
<h5 id="type_support">Type Support</h5>
<div class="paragraph">
<p>The <em>type</em> attribute on segment data elements allows datatype specification for validation. The following example shows type support in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>
<span class="nt">&lt;xsd:schema</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span>
            <span class="na">xmlns:dfdl=</span><span class="s">"http://www.ogf.org/dfdl/dfdl-1.0/"</span>
            <span class="na">xmlns:ibmEdiFmt=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xsd:import</span> <span class="na">namespace=</span><span class="s">"http://www.ibm.com/dfdl/EDI/Format"</span> <span class="na">schemaLocation=</span><span class="s">"/EDIFACT-Common/IBM_EDI_Format.dfdl.xsd"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;xsd:annotation&gt;</span>
        <span class="nt">&lt;xsd:appinfo</span> <span class="na">source=</span><span class="s">"http://www.ogf.org/dfdl/"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;dfdl:format</span> <span class="na">ref=</span><span class="s">"ibmEdiFmt:EDIFormat"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/xsd:appinfo&gt;</span>
    <span class="nt">&lt;/xsd:annotation&gt;</span>

    <span class="nt">&lt;xsd:element</span> <span class="na">dfdl:initiator=</span><span class="s">"HDR"</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentFormat"</span> <span class="na">name=</span><span class="s">"header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;xsd:complexType&gt;</span>
            <span class="nt">&lt;xsd:sequence</span> <span class="na">dfdl:ref=</span><span class="s">"ibmEdiFmt:EDISegmentSequenceFormat"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"order-id"</span> <span class="na">type=</span><span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"status-code"</span> <span class="na">type=</span><span class="s">"xsd:int"</span> <span class="na">dfdl:textNumberPattern=</span><span class="s">"0"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"net-amount"</span> <span class="na">type=</span><span class="s">"xsd:decimal"</span> <span class="na">dfdl:textNumberPattern=</span><span class="s">"0"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"total-amount"</span> <span class="na">type=</span><span class="s">"xsd:decimal"</span> <span class="na">dfdl:textNumberPattern=</span><span class="s">"#.#"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"tax"</span> <span class="na">type=</span><span class="s">"xsd:decimal"</span> <span class="na">dfdl:textNumberPattern=</span><span class="s">"#.#"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;xsd:element</span> <span class="na">name=</span><span class="s">"date"</span> <span class="na">type=</span><span class="s">"xsd:date"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/xsd:sequence&gt;</span>
        <span class="nt">&lt;/xsd:complexType&gt;</span>
    <span class="nt">&lt;/xsd:element&gt;</span>
<span class="nt">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven_coordinates_5">Maven Coordinates</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges.edi<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-edi-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml_namespaces">XML Namespaces</h4>
<div class="literalblock">
<div class="content">
<pre>xmlns:edi="https://www.smooks.org/xsd/smooks/edi-2.0.xsd"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="edifact">EDIFACT</h3>
<div class="paragraph">
<p>Smooks 2 provides out-of-the-box support for UN EDIFACT interchanges in terms of pre-generated EDI DFDL schemas derived from the <a href="http://www.unece.org/trade/untdid/down_index.htm">official UN EDIFACT
message definition zip directories</a>. This allows you to easily convert a UN EDIFACT message interchange into a consumable XML document. Specialised <em>edifact:parser</em> and <em>edifact:unparser</em> resources support UN EDIFACT interchanges as shown in the next example:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:edifact=</span><span class="s">"https://www.smooks.org/xsd/smooks/edifact-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Configure the reader to parse the EDIFACT stream into a stream of SAX events. --&gt;</span>
    <span class="nt">&lt;edifact:parser</span> <span class="na">schemaUri=</span><span class="s">"/d03b/EDIFACT-Messages.dfdl.xsd"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Apply a pipeline on the root event and replace the XML result produced from &lt;edifact:parser .../&gt; with the pipeline EDIFACT result. --&gt;</span>
    <span class="nt">&lt;core:smooks</span> <span class="na">filterSourceOn=</span><span class="s">"/Interchange"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;core:action&gt;</span>
            <span class="nt">&lt;core:inline&gt;</span>
                <span class="nt">&lt;core:replace/&gt;</span>
            <span class="nt">&lt;/core:inline&gt;</span>
        <span class="nt">&lt;/core:action&gt;</span>
        <span class="nt">&lt;core:config&gt;</span>
            <span class="nt">&lt;smooks-resource-list&gt;</span>
                <span class="c">&lt;!-- Configure the writer to serialise the event stream into EDIFACT. --&gt;</span>
                <span class="nt">&lt;edifact:unparser</span> <span class="na">schemaUri=</span><span class="s">"/d03b/EDIFACT-Messages.dfdl.xsd"</span> <span class="na">unparseOnNode=</span><span class="s">"*"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/smooks-resource-list&gt;</span>
        <span class="nt">&lt;/core:config&gt;</span>
    <span class="nt">&lt;/core:smooks&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>edifact:parser</em> and <em>edifact:unparser</em>, analogous to the <em>edi:parser</em> and <em>edi:unparser</em>, convert the stream according to the pre-generated DFDL schema referenced in the <em>schemaUri</em> attribute. Given that an EDIFACT schema can be very big compared to your average EDI schema, it may take minutes for the parser to compile it. Even having the <em>cacheOnDisk</em> attribute enabled may not be sufficient to meet your compilation time needs. For such situations, you can mitigate this problem by declaring ahead of time which message types the parser will process:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:edifact=</span><span class="s">"https://www.smooks.org/xsd/smooks/edifact-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;edifact:parser</span> <span class="na">schemaUri=</span><span class="s">"/d03b/EDIFACT-Messages.dfdl.xsd"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;edifact:messageTypes&gt;</span>
            <span class="nt">&lt;edifact:messageType&gt;</span>ORDERS<span class="nt">&lt;/edifact:messageType&gt;</span>
            <span class="nt">&lt;edifact:messageType&gt;</span>INVOIC<span class="nt">&lt;/edifact:messageType&gt;</span>
        <span class="nt">&lt;/edifact:messageTypes&gt;</span>
    <span class="nt">&lt;/edifact:parser&gt;</span>

    <span class="nt">&lt;core:smooks</span> <span class="na">filterSourceOn=</span><span class="s">"/Interchange"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;core:action&gt;</span>
            <span class="nt">&lt;core:inline&gt;</span>
                <span class="nt">&lt;core:replace/&gt;</span>
            <span class="nt">&lt;/core:inline&gt;</span>
        <span class="nt">&lt;/core:action&gt;</span>
        <span class="nt">&lt;core:config&gt;</span>
            <span class="nt">&lt;smooks-resource-list&gt;</span>
                <span class="nt">&lt;edifact:unparser</span> <span class="na">schemaUri=</span><span class="s">"/d03b/EDIFACT-Messages.dfdl.xsd"</span> <span class="na">unparseOnNode=</span><span class="s">"*"</span><span class="nt">&gt;</span>
                   <span class="nt">&lt;edifact:messageTypes&gt;</span>
                        <span class="nt">&lt;edifact:messageType&gt;</span>ORDERS<span class="nt">&lt;/edifact:messageType&gt;</span>
                        <span class="nt">&lt;edifact:messageType&gt;</span>INVOIC<span class="nt">&lt;/edifact:messageType&gt;</span>
                    <span class="nt">&lt;/edifact:messageTypes&gt;</span>
                <span class="nt">&lt;/edifact:unparser&gt;</span>
            <span class="nt">&lt;/smooks-resource-list&gt;</span>
        <span class="nt">&lt;/core:config&gt;</span>
    <span class="nt">&lt;/core:smooks&gt;</span>
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The schema compilation time is directly proportional to the number of declared message types. The EDIFACT resources will reject any message which does not have its message type declared within the <em>messageTypes</em> child element. Apart from XML configuration, it is also possible to programmatically control the EDIFACT parser message types via a <em>EdifactReaderConfigurator</em> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">setReaderConfig</span><span class="o">(</span><span class="k">new</span> <span class="nc">EdifactReaderConfigurator</span><span class="o">(</span><span class="s">"/d03b/EDIFACT-Messages.dfdl.xsd"</span><span class="o">).</span><span class="na">setMessageTypes</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"ORDERS"</span><span class="o">,</span> <span class="s">"INVOIC"</span><span class="o">)));</span>

<span class="n">etc</span><span class="o">...</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="schema_packs">Schema Packs</h4>
<div class="paragraph">
<p>In an effort to simplify the processing of UN EDIFACT Interchanges, we have created tools to generate EDIFACT schema packs from <a href="http://www.unece.org/trade/untdid/down_index.htm">the official UN EDIFACT message definition zip directories</a>. The generated schema packs are deployed to a public Maven repository from where users can easily access the EDIFACT schemas for the UN EDIFACT message sets they need to support.</p>
</div>
<div class="paragraph">
<p>Schema packs are available for most of the UN EDIFACT directories. These are available from the Maven Snapshot and Central repositories and can be added to your application using standard Maven dependency management.</p>
</div>
<div class="paragraph">
<p>As an example, to add the D93A DFDL schema pack to your application classpath, add the following dependency to your application&#8217;s POM:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="c">&lt;!-- The mapping model sip set for the D93A directory... --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges.edi<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>edifact-schemas<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;classifier&gt;</span>d93a<span class="nt">&lt;/classifier&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you add an EDIFACT schema pack set to the application&#8217;s classpath, you configure Smooks to use the schemas by referencing the root schema in <em>schemaUri</em> attribute of the <em>edifact:parser</em> or <em>edifact:unparser</em> configuration (<em>&lt;version&gt;/EDIFACT-Messages.dfdl.xsd</em>):</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:edifact=</span><span class="s">"https://www.smooks.org/xsd/smooks/edifact-1.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;edifact:parser</span> <span class="na">schemaUri=</span><span class="s">"/d03b/EDIFACT-Messages.dfdl.xsd"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;edifact:messages&gt;</span>
            <span class="nt">&lt;edifact:message&gt;</span>ORDERS<span class="nt">&lt;/edifact:message&gt;</span>
            <span class="nt">&lt;edifact:message&gt;</span>INVOIC<span class="nt">&lt;/edifact:message&gt;</span>
        <span class="nt">&lt;/edifact:messages&gt;</span>
    <span class="nt">&lt;/edifact:parser&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://github.com/smooks/smooks-examples">EDIFACT examples</a> for further reference.</p>
</div>
</div>
<div class="sect3">
<h4 id="maven_coordinates_6">Maven Coordinates</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges.edi<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-edifact-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml_namespaces_2">XML Namespaces</h4>
<div class="literalblock">
<div class="content">
<pre>xmlns:edifact="https://www.smooks.org/xsd/smooks/edifact-2.0.xsd"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="json">JSON</h3>
<div class="paragraph">
<p>Processing JSON with Smooks requires a JSON reader to be configured:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:json=</span><span class="s">"https://www.smooks.org/xsd/smooks/json-1.3.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;json:reader/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The XML element name of the root element, the element name of document and the element name of array elements can be configured with the following configuration options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rootName</code>: The name of the root element. Default: <code>json</code>.</p>
</li>
<li>
<p><code>arrayElementName</code>: The name of a sequence element. Default: <code>element</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>JSON allows characters in the key name that aren&#8217;t allowed in XML element name. To workaround that problem the reader offers multiple solutions. The JSON reader can search and replace whitespaces, illegal characters and the number in key names that start with a number. It is also possible to replace one key name with a completely different name. The following example demonstrates all these features:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:json=</span><span class="s">"https://www.smooks.org/xsd/smooks/json-1.3.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;json:reader</span> <span class="na">keyWhitspaceReplacement=</span><span class="s">"_"</span> <span class="na">keyPrefixOnNumeric=</span><span class="s">"n"</span> <span class="na">illegalElementNameCharReplacement=</span><span class="s">"."</span><span class="nt">&gt;</span>
        <span class="nt">&lt;json:keyMap&gt;</span>
            <span class="nt">&lt;json:key</span> <span class="na">from=</span><span class="s">"some key"</span><span class="nt">&gt;</span>someKey<span class="nt">&lt;/json:key&gt;</span>
            <span class="nt">&lt;json:key</span> <span class="na">from=</span><span class="s">"some&amp;amp;key"</span> <span class="na">to=</span><span class="s">"someAndKey"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/json:keyMap&gt;</span>
    <span class="nt">&lt;/json:reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>keyWhitspaceReplacement</code>: The replacement character for whitespaces in a json map key. By default this not defined, so that the reader doesn&#8217;t search for white spaces.</p>
</li>
<li>
<p><code>keyPrefixOnNumeric</code>: The prefix character to add if the JSON node name starts with a number. By default this is not defined, so that the reader doesn&#8217;t search for element names that start with a number.</p>
</li>
<li>
<p><code>illegalElementNameCharReplacement</code>: If illegal characters are encountered in a JSON element name then they are replaced with this value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following options can also be configured on the JSON reader:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nullValueReplacement</code>: The replacement string for JSON NULL values.
Default is an empty string.</p>
</li>
<li>
<p><code>encoding</code>: The default encoding of any JSON message InputStream
processed by this Reader. Default of 'UTF-8'.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You shouldn&#8217;t need this configuration parameter and <strong>it will be removed in a future release</strong>. Instead, you should manage the JSON stream Source character encoding by supplying a <code>java.io.Reader</code> to the <code>Smooks.filterSource()</code> method.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="java_api_3">Java API</h4>
<div class="paragraph">
<p>Smooks is programmatically configured to read a JSON configuration using the <a href="/javadoc/v1.7.1/smooks/org/milyn/json/JSONReaderConfigurator.html">JSONReaderConfigurator</a>
class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">setReaderConfig</span><span class="o">(</span><span class="k">new</span> <span class="nc">JSONReaderConfigurator</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setRootName</span><span class="o">(</span><span class="s">"root"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setArrayElementName</span><span class="o">(</span><span class="s">"e"</span><span class="o">));</span>

<span class="c1">// Use Smooks as normal...</span>
<span class="o">...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven_coordinates_7">Maven Coordinates</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-json-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml_namespace_4">XML Namespace</h4>
<div class="literalblock">
<div class="content">
<pre>xmlns:json="https://www.smooks.org/xsd/smooks/json-1.3.xsd"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="yaml">YAML</h3>
<div class="paragraph">
<p>Processing YAML with Smooks requires a YAML reader to be configured:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:yaml=</span><span class="s">"https://www.smooks.org/xsd/smooks/yaml-1.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;yaml:reader/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>YAML stream can contain multiple documents. The reader handles this by adding an element as a child of the root element. An XML serialized YAML stream with one empty YAML document looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;yaml&gt;</span>
    <span class="nt">&lt;document&gt;</span>
    <span class="nt">&lt;/document&gt;</span>
<span class="nt">&lt;/yaml&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The XML element name of the root element, the element name of the document, and the element name of array elements can be configured with the following configuration options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rootName</code>: The name of the root element. Default: <code>yaml</code>.</p>
</li>
<li>
<p><code>documentName</code>: The name of the document element. Default: <code>document</code>.</p>
</li>
<li>
<p><code>elementName</code>: The name of a sequence element. Default: <code>element</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>YAML allows characters in the key name that aren&#8217;t allowed in XML element name. To workaround that problem the reader offers multiple solutions. The YAML reader can search and replace white spaces, illegal characters and the number in key names that start with a number. It is also possible to replace one key name with a completely different name. The following example demonstrates all these features:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:yaml=</span><span class="s">"https://www.smooks.org/xsd/smooks/yaml-1.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;yaml:reader</span> <span class="na">keyWhitspaceReplacement=</span><span class="s">"_"</span> <span class="na">keyPrefixOnNumeric=</span><span class="s">"n"</span> <span class="na">illegalElementNameCharReplacement=</span><span class="s">"."</span><span class="nt">&gt;</span>
        <span class="nt">&lt;yaml:keyMap&gt;</span>
            <span class="nt">&lt;yaml:key</span> <span class="na">from=</span><span class="s">"some key"</span><span class="nt">&gt;</span>someKey<span class="nt">&lt;/yaml:key&gt;</span>
            <span class="nt">&lt;yaml:key</span> <span class="na">from=</span><span class="s">"some&amp;amp;key"</span> <span class="na">to=</span><span class="s">"someAndKey"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/yaml:keyMap&gt;</span>
    <span class="nt">&lt;/yaml:reader&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>keyWhitspaceReplacement</code>: The replacement character for whitespaces in a yaml map key. By default this not defined, so that the reader doesn&#8217;t search for white spaces.</p>
</li>
<li>
<p><code>keyPrefixOnNumeric</code>: The prefix character to add if the YAML node name starts with a number. By default this is not defined, so that the reader doesn&#8217;t search for element names that start with a number.</p>
</li>
<li>
<p><code>illegalElementNameCharReplacement</code>: If illegal characters are encountered in a YAML element name then they are replaced with this value. By default this is not defined, so that the reader doesn&#8217;t search for element names with illegal characters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>YAML has the concept of anchors and aliases. The YAML reader can handle anchors and aliasses with three different strategies. The strategy is defined via the <code>aliasStrategy</code> configuration option. This option can have the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>REFER</code>: The reader creates reference attributes on the element that have an anchor or an alias. The element with the anchor gets the <code>id</code> attribute containing the name from the anchor as the attribute value. The element with the alias gets the <code>ref</code> attribute also containing the name of the anchor as the attribute value. The anchor and alias attribute names can be defined by the <code>anchorAttributeName</code> and <code>aliasAttributeName</code>.</p>
</li>
<li>
<p><code>RESOLVE</code>: The reader resolves the value or the data structure of an anchor when its alias is encountered. This means that the SAX events of the anchor are repeated as child events of the alias element. When a YAML document contains a lot of anchors or anchors with a huge data structure then this can lead to memory problems.</p>
</li>
<li>
<p><code>REFER_RESOLVE</code>: This is a combination of <code>REFER</code> and <code>RESOLVE</code>. The anchor and alias attributes are set but the anchor value or data structure is also resolved. This option is useful when the name of the anchor has a business meaning.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By the default the YAML reader uses the <code>REFER</code> strategy.</p>
</div>
<div class="sect3">
<h4 id="java_api_4">Java API</h4>
<div class="paragraph">
<p>Smooks is programmatically configured to read a YAML configuration using the <a href="/javadoc/v1.7.1/smooks/org/milyn/yaml/YamlReaderConfigurator.html">YamlReaderConfigurator</a> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">setReaderConfig</span><span class="o">(</span><span class="k">new</span> <span class="nc">YamlReaderConfigurator</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setRootName</span><span class="o">(</span><span class="s">"root"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setDocumentName</span><span class="o">(</span><span class="s">"doc"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setArrayElementName</span><span class="o">(</span><span class="s">"e"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">setAliasStrategy</span><span class="o">(</span><span class="nc">AliasStrategy</span><span class="o">.</span><span class="na">REFER_RESOLVE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setAnchorAttributeName</span><span class="o">(</span><span class="s">"anchor"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setAliasAttributeName</span><span class="o">(</span><span class="s">"alias"</span><span class="o">);</span>

<span class="c1">// Use Smooks as normal...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven_coordinates_8">Maven Coordinates</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-yaml-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml_namespace_5">XML Namespace</h4>
<div class="literalblock">
<div class="content">
<pre>xmlns:yaml="https://www.smooks.org/xsd/smooks/yaml-1.5.xsd"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="javabeans">JavaBeans</h3>
<div class="paragraph">
<p>Smooks can map a Java object graph to another Java object graph. This mapping is accomplished through events, which means no intermediate object is constructed for populating the target Java object graph. In other words, the source Java object graph is turned into a stream of events that are bound to the target Java object graph.</p>
</div>
<div class="paragraph">
<p>Consider an <em>Order</em> object needing to be mapped to a <em>LineOrder</em> object. Conceptually,  the mapping from the source to target object model would be:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks-javabean-cartridge/master/docs/images/Java-to-java3.gif" alt="Image:java-to-java3.gif"></span></p>
</div>
<div class="paragraph">
<p>One can easily view the event stream produced from the source object (i.e., <em>Order</em>) if Smooks&#8217;s <em>HTML Report Generator</em> is running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;example.srcmodel.Order&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;customerNumber&gt;</span>...<span class="nt">&lt;/customerNumber&gt;</span>
        <span class="nt">&lt;customerName&gt;</span>...<span class="nt">&lt;/customerName&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;orderItems&gt;</span>
        <span class="nt">&lt;example.srcmodel.OrderItem&gt;</span>
            <span class="nt">&lt;productId&gt;</span>...<span class="nt">&lt;/productId&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>...<span class="nt">&lt;/quantity&gt;</span>
            <span class="nt">&lt;price&gt;</span>...<span class="nt">&lt;/price&gt;</span>
        <span class="nt">&lt;/example.srcmodel.OrderItem&gt;</span>
    <span class="nt">&lt;/orderItems&gt;</span>
<span class="nt">&lt;/example.srcmodel.Order&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mapping the source object is a matter of targeting the Smooks Javabean resources at the above event stream. Such a Smooks config performing the mapping would look like:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"lineOrder"</span> <span class="na">class=</span><span class="s">"example.trgmodel.LineOrder"</span> <span class="na">createOnElement=</span><span class="s">"example.srcmodel.Order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"lineItems"</span> <span class="na">beanIdRef=</span><span class="s">"lineItems"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerId"</span> <span class="na">data=</span><span class="s">"header/customerNumber"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerName"</span> <span class="na">data=</span><span class="s">"header/customerName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"lineItems"</span> <span class="na">class=</span><span class="s">"example.trgmodel.LineItem[]"</span> <span class="na">createOnElement=</span><span class="s">"orderItems"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">beanIdRef=</span><span class="s">"lineItem"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"lineItem"</span> <span class="na">class=</span><span class="s">"example.trgmodel.LineItem"</span> <span class="na">createOnElement=</span><span class="s">"example.srcmodel.OrderItem"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productCode"</span> <span class="na">data=</span><span class="s">"example.srcmodel.OrderItem/productId"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"unitQuantity"</span> <span class="na">data=</span><span class="s">"example.srcmodel.OrderItem/quantity"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"unitPrice"</span> <span class="na">data=</span><span class="s">"example.srcmodel.OrderItem/price"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="java_to_java">Java to Java</h4>
<div class="paragraph">
<p>The source object is provided to Smooks via a <code>org.smooks.io.payload.JavaSource</code> instance. This object is created by passing the constructor the root object of the source model. The resulting <code>JavaSource</code> object is used in the <code>Smooks#filter</code> method. The resulting code could look like as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">protected</span> <span class="nc">LineOrder</span> <span class="nf">runSmooksTransform</span><span class="o">(</span><span class="nc">Order</span> <span class="n">srcOrder</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="s">"smooks-config.xml"</span><span class="o">);</span>
    <span class="nc">ExecutionContext</span> <span class="n">executionContext</span> <span class="o">=</span> <span class="n">smooks</span><span class="o">.</span><span class="na">createExecutionContext</span><span class="o">();</span>

    <span class="c1">// Transform the source Order to the target LineOrder via a</span>
    <span class="c1">// JavaSource and JavaResult instance...</span>
    <span class="nc">JavaSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaSource</span><span class="o">(</span><span class="n">srcOrder</span><span class="o">);</span>
    <span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

    <span class="c1">// Configure the execution context to generate a report...</span>
    <span class="n">executionContext</span><span class="o">.</span><span class="na">setEventListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">HtmlReportGenerator</span><span class="o">(</span><span class="s">"target/report/report.html"</span><span class="o">));</span>

    <span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span> <span class="n">source</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

    <span class="k">return</span> <span class="o">(</span><span class="nc">LineOrder</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"lineOrder"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="java_to_text_xml_csv_edi_etc">Java to Text (XML, CSV, EDI, etc&#8230;&#8203;)</h4>
<div class="paragraph">
<p>The Smooks core runtime works by processing a stream of SAX events produced by an input source of some type (XML, EDI, Java, etc&#8230;&#8203;) and using those events to fire visitors. In the case of a Java source (see previous section on "Java to Java"), Smooks uses XStream to generate this stream of SAX events.</p>
</div>
<div class="paragraph">
<p>Sometimes, however, you just want to apply a template (e.g. a FreeMarker template) to a Java Source object model and produce XML, CSV, EDI, etc&#8230;&#8203; You don&#8217;t want to incur the wasted overhead of generating a stream of SAX events that you are not going to use. To do this, you need to tell the Smooks core runtime to not generate the stream of events. This can be done in one of two ways.</p>
</div>
<div class="paragraph">
<p>By calling <code>setEventStreamRequired(false)</code> on the <code>JavaSource</code> instance being supplied to <code>Smooks.filterSource</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">JavaSource</span> <span class="n">javaSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaSource</span><span class="o">(</span><span class="n">orderBean</span><span class="o">);</span>

<span class="c1">// Turn streaming off via the JavaSource...</span>
<span class="n">javaSource</span><span class="o">.</span><span class="na">setEventStreamRequired</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">javaSource</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, by turning off the "http://www.smooks.org/sax/features/generate-java-event-stream" <code>&lt;reader&gt;</code> feature in the Smooks configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;reader&gt;</span>
        <span class="nt">&lt;features&gt;</span>
            <span class="nt">&lt;setOff</span> <span class="na">feature=</span><span class="s">"http://www.smooks.org/sax/features/generate-java-event-stream"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/features&gt;</span>
    <span class="nt">&lt;/reader&gt;</span>

    <span class="c">&lt;!-- Other Smooks configurations e.g. a FreeMarker template... --&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When applying the FreeMarker template, the name of the templating context beans (i.e. the names used in your template) depends on the Object type in the JavaSource:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the object is a <code>Map</code>, then that Map instance becomes the templating context and so you can just use the Map entry keys as the bean names in your template.</p>
</li>
<li>
<p>For non-map objects, the <code>JavaSource</code> class takes the Object Class SimpleName and creates a JavaBean property name from it. This is the name of the context bean used for the templating. So, if the bean class name is <code>com.acme.Order</code>, then the context bean name, for the purpose of templating, will be "order".</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="java_binding">Java Binding</h4>
<div class="paragraph">
<p>The JavaBean Cartridge allows you to create and populate Java POJOs from your message data (i.e., bind data).</p>
</div>
<div class="sect4">
<h5 id="java_binding_overview">Java Binding Overview</h5>
<div class="paragraph">
<p>This feature of Smooks can be used in its own right purely as a Java binding framework for XML, EDI, CSV, etc&#8230;&#8203; However, it is very important to remember that the Java Binding capabilities in Smooks are the cornerstone of many other capabilities provided by Smooks. This is because Smooks makes the Java objects it creates (and binds data into) available through the <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/bean/contedxt/BeanContext.html">BeanContext</a> class. This is essentially a Java Bean context that is made available to any Smooks visitor via the Smooks <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/ExecutionContext.html">ExecutionContext</a>.</p>
</div>
<div class="paragraph">
<p>Some of the existing features that build on the functionality provided in the Javabean Cartridge include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#templating">Templating</a>: Templating typically involves applying a template (FreeMarker or other) to the objects in the BeanContext.</p>
</li>
<li>
<p><a href="#rule-based-validation">Validation</a>: Business Rules Validation (e.g. via MVEL) typically involves applying a rule (expression, etc&#8230;&#8203;) to the objects in the BeanContext.</p>
</li>
<li>
<p><a href="#message-splitting&#8212;&#8203;routing">Message Splitting &amp; Routing</a>: Message Splitting typically works by generating split messages from the Objects in the BeanContext, either by using the objects themselves and routing them, or by applying a template to them and routing the result of that templating operation (e.g. a new XML, CSV, etc&#8230;&#8203;).</p>
</li>
<li>
<p><a href="#routing-to-a-database-using-sql">Persistence (Database Reading and Writing)</a>: The Persistence features depend on the Java Binding functions for creating and populating the Java objects (Entities etc) to be persisted. Data read from a database is typically bound into the BeanContext.</p>
</li>
<li>
<p><a href="#enriching-output-data">Message Enrichment</a>: As stated above, enrichment data (e.g. read from a DB) is typically bound into the BeanContext, from where it is available to all other features, including the Java Binding functionality itself e.g. for expression-based bindings. This allows messages generated by Smooks to be enriched.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="when_to_use_smooks_java_binding">When to use Smooks Java Binding</h5>
<div class="paragraph">
<p>A question that often comes to mind is "<em>Why would I use Smooks to perform binding to a Java objects model instead of JAXB or <a href="http://jibx.sourceforge.net/">JiBX</a>?</em>". Well there are a number of reasons why you would use Smooks and there are a number of reasons why you would not use Smooks.</p>
</div>
<div class="paragraph">
<p>When Smooks makes sense:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Binding non-XML data to a Java object model e.g. EDI, CSV, JSON, etc&#8230;&#8203;</p>
</li>
<li>
<p>Binding data (XML or other) whose data model (hierarchical structure) does not match that of the target Java object model. <a href="http://jibx.sourceforge.net/">JiBX</a> also supports this, but only for XML (AFAIK!!).</p>
</li>
<li>
<p>When you are binding data from an XML data structure for which there is no defined schema (XSD). Some frameworks effectively require a well defined XML data model via schema.</p>
</li>
<li>
<p>When binding data from multiple existing and different data formats into a single pre-existing Java object model. Related to the above points.</p>
</li>
<li>
<p>When binding data into existing 3rd Party Object Models that you cannot modify e.g. through a post-compile step.</p>
</li>
<li>
<p>In situations where the Data (XML or other) and Java object models may vary in isolation from each other. Because of #2 above, Smooks can handle this by simply modifying the binding configuration. Other frameworks often require binding/schema regeneration, redeployment, etc&#8230;&#8203; (see #3 above).</p>
</li>
<li>
<p>Where you need to execute additional logic in parallel to the binding process e.g. Validation, Split Message Generation (via Templates), Split Message Routing, Fragment Persistence, or any custom logic that you may wish to implement. This is often a very powerful capability e.g. when processing huge message streams.</p>
</li>
<li>
<p>Processing huge message streams by splitting them into a series of many small object models and routing them to other systems for processing.</p>
</li>
<li>
<p>When using other Smooks features that rely on the Smooks Java Binding capabilities.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When Smooks may not make sense:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When you have a well defined data model (via schema/XSD) and all you need to do is bind data into an object model (no required validation, persistence, etc&#8230;&#8203;).</p>
</li>
<li>
<p>When the object model is isolated from other systems and so can change without impacting such systems.</p>
</li>
<li>
<p>Where processing XML and performance is paramount over all other considerations (where nanoseconds matter), frameworks such as <a href="http://jibx.sourceforge.net/">JiBX</a> are definitely worth considering over Smooks. This is not to imply that the performance of Smooks Java Binding is poor in any way, but it does acknowledge the fact that frameworks that utilise post-compile optimizations targeted at a specific data format (e.g. XML) will always have the edge under the right conditions.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="basics_of_java_binding">Basics of Java Binding</h5>
<div class="paragraph">
<p>As you know, Smooks supports a range of source data formats (XML, EDI, CSV, Java, etc&#8230;&#8203;), but for the purposes of this topic, we will always refer to the message data in terms of an XML format. In the examples, we will continuously refer to the following XML message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;date&gt;</span>Wed Nov 15 13:45:28 EST 2006<span class="nt">&lt;/date&gt;</span>
        <span class="nt">&lt;customer</span> <span class="na">number=</span><span class="s">"123123"</span><span class="nt">&gt;</span>Joe<span class="nt">&lt;/customer&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;order-items&gt;</span>
        <span class="nt">&lt;order-item&gt;</span>
            <span class="nt">&lt;product&gt;</span>111<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;</span>
            <span class="nt">&lt;price&gt;</span>8.90<span class="nt">&lt;/price&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
        <span class="nt">&lt;order-item&gt;</span>
            <span class="nt">&lt;product&gt;</span>222<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>7<span class="nt">&lt;/quantity&gt;</span>
            <span class="nt">&lt;price&gt;</span>5.20<span class="nt">&lt;/price&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
    <span class="nt">&lt;/order-items&gt;</span>
<span class="nt">&lt;/order&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In some examples we will use different XML message data. Where this happens, the data is explicitly defined there then.</p>
</div>
<div class="paragraph">
<p>The JavaBean Cartridge is used via the <a href="https://www.smooks.org/xsd/smooks/javabean-1.6.xsd" class="bare">https://www.smooks.org/xsd/smooks/javabean-1.6.xsd</a> configuration namespace. Install the schema in your IDE and avail of autocompletion.</p>
</div>
<div class="paragraph">
<p>An example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"example.model.Order"</span> <span class="na">createOnElement=</span><span class="s">"#document"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration simply creates an instance of the <code>example.model.Order</code> class and binds it into the <strong>bean context</strong> under the beanId <code>order</code>. The instance is created at the very start of the message on the #document element (i.e. the start of the root element).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>beanId</code>: The id of this bean. Please see <a href="#the-bean-context">The Bean Context</a> for more details.</p>
</li>
<li>
<p><code>class</code>: The fully qualified class name of the bean.</p>
</li>
<li>
<p><code>createOnElement</code>: attribute controls when the bean instance is created. Population of the bean properties is controlled through the binding configurations (child elements of the element).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Javabean cartridge has the following conditions for javabeans:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A public no-argument constructor</p>
</li>
<li>
<p>Public property setter methods. The don&#8217;t need to follow any specific name formats, but it would be better if they do follow the standard property setter method names.</p>
</li>
<li>
<p>Setting javabean properties directly is not supported.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="java_binding_configuration_details">Java Binding Configuration Details</h5>
<div class="paragraph">
<p>The configuration shown above simply created the <em>example.model.Order</em> bean instance and bound it into the bean context. This section will describe how to bind data into that bean instance.</p>
</div>
<div class="paragraph">
<p>The Javabean Cartridge provides support for 3 types of data bindings, which are added as child elements of the <code>&lt;jb:bean&gt;</code> element:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;jb:value&gt;</code>: This is used to bind data values from the Source message event stream into the target bean.</p>
</li>
<li>
<p><code>&lt;jb:wiring&gt;</code>: This is used to "wire" another bean instance from the bean context into a bean property on the target bean. This is the configuration that allows you to construct an object graph (Vs just a loose bag of Java object instances). Beans can be wired in based on their "beanId", their Java class type, or by Annotation (by being annotated with a specific Annotation).</p>
</li>
<li>
<p><code>&lt;jb:expression&gt;</code>: As it&#8217;s name suggests, this configuration is used to bind in a value calculated from an expression (in the <a href="http://mvel.documentnode.com/">MVEL</a> language), a simple example being the binding of an order item total value into an OrderItem bean based on the result of an expression that calculates the value from the items price and quantity (e.g. "price * quantity"). The <code>execOnElement</code> attribute expression defines the element on which the expression is to be evaluated and the result bound. If not defined, the expression is executed based on the value of the parent . The value of the targeted element is available in the expression as a String variable under the name <code>_VALUE</code> (notice the underscore).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Taking the Order XML message (previous section), lets see what the full XML to Java binding configuration might be. We&#8217;ve seen the order XML (above). Now lets look at the Java objects that we want to populate from that XML message (getters and setters not shown):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Header</span> <span class="n">header</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Header</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">date</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">customerNumber</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">customerName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">total</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderItem</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">productId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">quantity</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">price</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Smooks config required to bind the data from the order XML and into this object model is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span> <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

(1)   <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"com.acme.Order"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
(1.a)     <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"header"</span> <span class="na">beanIdRef=</span><span class="s">"header"</span> <span class="nt">/&gt;</span>
(1.b)     <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"orderItems"</span> <span class="na">beanIdRef=</span><span class="s">"orderItems"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/jb:bean&gt;</span>

(2)   <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"header"</span> <span class="na">class=</span><span class="s">"com.acme.Header"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
(2.a)     <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"date"</span> <span class="na">decoder=</span><span class="s">"Date"</span> <span class="na">data=</span><span class="s">"header/date"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>EEE MMM dd HH:mm:ss z yyyy<span class="nt">&lt;/jb:decodeParam&gt;</span>
          <span class="nt">&lt;/jb:value&gt;</span>
(2.b)     <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerNumber"</span> <span class="na">data=</span><span class="s">"header/customer/@number"</span> <span class="nt">/&gt;</span>
(2.c)     <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerName"</span> <span class="na">data=</span><span class="s">"header/customer"</span> <span class="nt">/&gt;</span>
(2.d)     <span class="nt">&lt;jb:expression</span> <span class="na">property=</span><span class="s">"total"</span> <span class="na">execOnElement=</span><span class="s">"order-item"</span> <span class="nt">&gt;</span>
              += (orderItem.price * orderItem.quantity);
          <span class="nt">&lt;/jb:expression&gt;</span>
      <span class="nt">&lt;/jb:bean&gt;</span>

(3)   <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItems"</span> <span class="na">class=</span><span class="s">"java.util.ArrayList"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
(3.a)     <span class="nt">&lt;jb:wiring</span> <span class="na">beanType=</span><span class="s">"com.acme.OrderItem"</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- Could also wire using beanIdRef="orderItem" --&gt;</span>
      <span class="nt">&lt;/jb:bean&gt;</span>

(4)   <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">class=</span><span class="s">"com.acme.OrderItem"</span> <span class="na">createOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
(4.a)     <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productId"</span> <span class="na">data=</span><span class="s">"order-item/product"</span> <span class="nt">/&gt;</span>
(4.b)     <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">data=</span><span class="s">"order-item/quantity"</span> <span class="nt">/&gt;</span>
(4.c)     <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">data=</span><span class="s">"order-item/price"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/jb:bean&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<table border="1" cellspacing="0" cellpadding="3" style="border: 1px solid; background-color: rgb(238, 238, 238)" width="100%">
   <tbody>
      <tr>
         <td width="15%" align="center"> <i>(1)</i>
         </td>
         <td width="85%">
            Configuration <b>(1)</b> defines the creation rules for the <i>com.acme.Order</i> bean instance (top level bean). We create this bean instance at the very start of the message i.e. on the &lt;order&gt; element . In fact, we create each of the beans instances (<b>(1)</b>, <b>(2)</b>, <b>(3)</b> - all accepts <b>(4)</b>) at the very start of the message (on the &lt;order&gt; element). We do this because there will only ever be a single instance of these beans in the populated model.
            <p>Configurations <b>(1.a)</b> and <b>(1.b)</b> define the <b>wiring</b> configuration for wiring the <i>Header</i> and <i>List&lt;OrderItem&gt;</i> bean instances (<b>(2)</b> and <b>(3)</b>) into the Order bean instance (see the <b>beanIdRef</b> attribute values and how the reference the <b>beanId</b> values defined on <b>(2)</b> and <b>(3)</b>). The <b>property</b> attributes on <b>(1.a)</b> and <b>(1.b)</b> define the <i>Order</i> bean properties on which the wirings are to be made.  Note also that beans can also be wired into an object based on their Java class type (<b>beanType</b>), or by being annotated with a specific Annotation (<b>beanAnnotation</b>).
            </p>
         </td>
      </tr>
      <tr>
         <td width="15%" align="center"> <i>(2)</i>
         </td>
         <td width="85%">
            Configuration <b>(2)</b> creates the <i>com.acme.Header</i> bean instance.
            <p>Configuration <b>(2.a)</b> defines a <b>value</b> binding onto the <i>Header.date</i> property. Note that the <b>data</b> attribute defines where the binding value is selected from the source message; in this case it is coming from the header/date element. Also note how it defines a <b>decodeParam</b> sub-element. This configures the DateDecoder.
            </p>
            <p>Configuration <b>(2.b)</b> defines a <b>value</b> binding configuration onto <i>Header.customerNumber</i> property. What should be noted here is how to configure the <b>data</b> attribute to select a binding value from an element attribute on the source message. Configuration <b>(2.b)</b> also defines an <b>expression</b> binding where the order total is calculated and set on the <i>Header.total</i> property. The <b>execOnElement</b> attribute tells Smooks that this expression needs to be evaluated (and bound/rebound) on the order-item element. So, if there are multiple &lt;order-item&gt; elements in the source message, this expression will be executed for each &lt;order-item&gt; and the new total value rebound into the <i>Header.total</i> property. Note how the expression adds the current orderItem total to the current order total (header.total).
            </p>
            <p>Configuration <b>(2.d)</b> defines an expression binding, where a running total is calculated by adding the total for each order item (quantity * price) to the current total.
            </p>
         </td>
      </tr>
      <tr>
         <td width="15%" align="center"> <i>(3)</i>
         </td>
         <td width="85%">
            Configuration <b>(3)</b> creates the <i>List&lt;OrderItem&gt;</i> bean instance for holding the <i>OrderItem</i> instances.
            <p>Configuration <b>(3.a)</b> wires all beans of type com.acme.OrderItem ( i.e. <b>(4)</b>) into the list. Note how this wiring does not define a <b>property</b> attribute. This is because it wires into a Collection (same applies if wiring into an array).  Also note that we could have performed this wiring using the <b>beanIdRef</b> attribute instead of the <b>beanType</b> attribute.
            </p>
         </td>
      </tr>
      <tr>
         <td width="15%" align="center"> <i>(4)</i>
         </td>
         <td width="85%">
            Configuration <b>(4)</b> creates the <i>OrderItem</i> bean instances. Note how the <b>createOnElement</b> is set to the &lt;order-item&gt; element. This is because we want a new instance of this bean to be created for every &lt;order-item&gt; element (and wired into the <i>List&lt;OrderItem&gt;</i> <b>(3.a)</b>).
            <p>If the <b>createOnElement</b> attribute for this configuration was not set to the &lt;order-item&gt; element (e.g. if it was set to one of the &lt;order&gt;, &lt;header&gt; or &lt;order-items&gt; elements), then only a single <i>OrderItem</i> bean instance would be created and the binding configurations (<b>(4.a)</b> etc) would overwrite the bean instance property bindings for every &lt;order-item&gt; element in the source message i.e. you would be left with a <i>List&lt;OrderItem&gt;</i> with just a single <i>OrderItem</i> instance containing the &lt;order-item&gt; data from the last &lt;order-item&gt; encountered in the source message.
            </p>
         </td>
      </tr>
   </tbody>
</table>
<br/>
<div class="paragraph">
<p><strong>Binding Tips</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;jb:bean createOnElement&gt;</code></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set it to the root element (or <code>#document</code>): For bean instances where only a single instance will exist in the model.</p>
</li>
<li>
<p>Set it to the recurring element: For Collection bean instances. If you don&#8217;t specify the correct element in this case, you could loose data.</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>&lt;jb:value decoder&gt;</code></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In most cases, Smooks will automatically detect the datatype decoder to be used for a <code>&lt;jb:value&gt;</code> binding. However, some decoders require configuration e.g. the DateDecoder (<code>decoder="Date"</code>). In these cases, the decoder attribute should be defined on the binding, as well as the &lt;jb:decodeParam&gt; child elements for specifying the decode parameters for that decoder. <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/package-summary.html">See the full list of DataDecoder available out-of-the-box</a>.</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>&lt;jb:wiring property&gt;</code></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Not required when binding into Collections.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Collections</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Just define the to be the required Collection type and wire in the Collection entries.</p>
</li>
<li>
<p>For arrays, just postfix the attribute value with square brackets e.g. <code>class="com.acme.OrderItem[]"</code>.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="type_converters">Type Converters</h6>
<div class="paragraph">
<p>In most cases, Smooks will automatically detect the datatype type converter to be used for a given <code>&lt;jb:value&gt;</code> binding. However, some decoders require configuration e.g. the TypeConverter (decoder="Date").In these cases, the converter attribute should be defined on the binding, as well as the <code>&lt;jb:decodeParam&gt;</code> child elements for specifying the decode parameters for that converter.</p>
</div>
<div class="sect6">
<h7 id="type_conversion">Type Conversion</h7>
<div class="paragraph">
<p>A number of date-based type converter implementations are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToDateConverterFactory.html">Date</a></strong>: Decode/Encode a String to a <em>java.util.Date</em> instance.</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToXmlGregorianCalendarConverterFactory.html">Calendar</a></strong>: Decode/Encode a String to a <em>java.util.Calendar</em> instance.</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/SqlDateConverterFactory.html">SqlDate</a></strong>: Decode/Encode a String to a <em>java.sql.Date</em> instance.</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/SqlTimeConverterFactory.html">SqlTime</a></strong>: Decode/Encode a String to a <em>java.sql.Time</em> instance.</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/SqlTimestampConverterFactory.html">SqlTimestamp</a></strong>: Decode/Encode a String to a <em>java.sql.Timestamp</em> instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these date-based type converter implementations are configured in the same way.</p>
</div>
<div class="paragraph">
<p><strong>Date</strong> Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"date"</span> <span class="na">decoder=</span><span class="s">"Date"</span> <span class="na">data=</span><span class="s">"order/@date"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>EEE MMM dd HH:mm:ss z yyyy<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale"</span><span class="nt">&gt;</span>sv_SE<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>SqlTimestamp</strong> Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"date"</span> <span class="na">decoder=</span><span class="s">"SqlTimestamp"</span> <span class="na">data=</span><span class="s">"order/@date"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>EEE MMM dd HH:mm:ss z yyyy<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale"</span><span class="nt">&gt;</span>sv<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>format</em> decodeParam is based on the <a href="http://www.w3.org/TR/NOTE-datetime">ISO 8601</a> standard for Date formatting. See <a href="https://docs.oracle.com/javase/8/docs/api/java/text/SimpleDateFormat.html">SimpleDateFormat</a> Javadoc and <a href="https://en.wikipedia.org/wiki/ISO_8601">Wikipedia</a> for more information.</p>
</div>
<div class="paragraph">
<p>The <em>locale</em> decodeParam value is an underscore separated string, with the first token being the <a href="https://www.loc.gov/standards/iso639-2/php/English_list.php">ISO Language Code</a> for the Locale and the second token being the <a href="https://www.iso.org/obp/ui/#iso:pub:PUB500001:en">ISO Country Code</a>. This decodeParam can also be specified as 2 separate parameters for language and country e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"date"</span> <span class="na">decoder=</span><span class="s">"Date"</span> <span class="na">data=</span><span class="s">"order/@date"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>EEE MMM dd HH:mm:ss z yyyy<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale-language"</span><span class="nt">&gt;</span>sv<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale-country"</span><span class="nt">&gt;</span>SE<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="number_decoding">Number Decoding</h7>
<div class="paragraph">
<p>A number of Number based type converter implementations are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToBigDecimalConverterFactory.html">BigDecimalDecoder</a></strong>: Decode/Encode a String to a <em>java.math. BigDecimal</em> instance.</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToBigIntegerConverterFactory.html">BigIntegerDecoder</a></strong>: Decode/Encode a String to a <em>java.math. BigInteger</em> instance.</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToDoubleConverterFactory.html">DoubleDecoder</a></strong>: Decode/Encode a String to a <em>java.lang.Double</em> instance (including primitive).</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToFloatConverterFactory.html">FloatDecoder</a></strong>: Decode/Encode a String to a <em>java.lang.Float</em> instance (including primitive).</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToIntegerConverterFactory.html">IntegerDecoder</a></strong>: Decode/Encode a String to a <em>java.lang.Integer</em> instance (including primitive).</p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToLongConverterFactory.html">LongDecoder</a></strong>: Decode/Encode a String to a <em>java.lang.Long' instance (including primitive).</em></p>
</li>
<li>
<p><strong><a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/engine/converter/StringToShortConverterFactory.html">ShortDecoder</a></strong>: Decode/Encode a String to a <em>java.lang.Short</em> instance (including primitive).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these Number based type converter implementations are configured in the same way.</p>
</div>
<div class="paragraph">
<p><strong>BigDecimal</strong> Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"BigDecimal"</span> <span class="na">data=</span><span class="s">"orderItem/price"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>#,###.##<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale"</span><span class="nt">&gt;</span>en_IE<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Integer</strong> Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"percentage"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"vote/percentage"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>#%<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>format</em> decodeParam is based on the <a href="https://docs.oracle.com/javase/tutorial/i18n/format/decimalFormat.html">NumberFormat</a> pattern syntax.</p>
</div>
<div class="paragraph">
<p>The <em>locale</em> decodeParam value is an underscore separated string, with the first token being the
<a href="https://www.loc.gov/standards/iso639-2/php/English_list.php">ISO Language Code</a> for the Locale and the second token being the <a href="https://www.iso.org/obp/ui/#iso:pub:PUB500001:en">ISO Country Code</a>. This decodeParam can also be specified as 2 separate parameters for language and country e.g.,:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"Double"</span> <span class="na">data=</span><span class="s">"orderItem/price"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>#,###.##<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale-language"</span><span class="nt">&gt;</span>sv<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale-country"</span><span class="nt">&gt;</span>SE<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="mapping_decoding">Mapping Decoding</h7>
<div class="paragraph">
<p>Sometimes you want to bind a different value into your object model, based on the data in your input message. You could use an expression based binding to do this, but you could also use a Mapping type converter as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"name"</span> <span class="na">decoder=</span><span class="s">"Mapping"</span> <span class="na">data=</span><span class="s">"history/@warehouse"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"1"</span><span class="nt">&gt;</span>Dublin<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"2"</span><span class="nt">&gt;</span>Belfast<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"3"</span><span class="nt">&gt;</span>Cork<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, an input data value of "1" is mapped onto the "name" property as a value of "Dublin". Likewise for values "2" and "3".</p>
</div>
</div>
<div class="sect6">
<h7 id="enum_decoding">Enum Decoding</h7>
<div class="paragraph">
<p>The Enum type converter is a specialized version of the <a href="#mapping-decoding">Mapping type converter</a>. Decoding of enumerations will typically happen automatically (without any specific configuration) if the data input values map exactly to the enum values/names. However when this is not the case, you need to define mappings from the input data value to the enum value/name.</p>
</div>
<div class="paragraph">
<p>In the following example, the <code>header/priority</code> field in the input message contains values of <code>LOW</code>, <code>MEDIUM</code> and <code>HIGH</code>. This need to be mapped the <code>example.trgmodel.LineOrderPriority</code> enum values of <code>NOT_IMPORTANT</code>, <code>IMPORTANT</code> and <code>VERY_IMPORTANT</code> respectfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"priority"</span> <span class="na">data=</span><span class="s">"header/priority"</span> <span class="na">decoder=</span><span class="s">"Enum"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"enumType"</span><span class="nt">&gt;</span>example.trgmodel.LineOrderPriority<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"LOW"</span><span class="nt">&gt;</span>NOT_IMPORTANT<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"MEDIUM"</span><span class="nt">&gt;</span>IMPORTANT<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"HIGH"</span><span class="nt">&gt;</span>VERY_IMPORTANT<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that if mappings are required, you must also explicitly specify the enumeration type using the <code>enumType</code> decodeParam.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="bean_retention">Bean Retention</h6>
<div class="paragraph">
<p>By default, all but the first bean configured in the Smooks configuration are removed from the BeanContext after the fragment that created the bean (createOnElement) is processed i.e. the bean is added to the BeanContext on the start/visitBefore of the createOnElement fragment, and is removed from the BeanContext at the end/visitAfter. By default, this rule applies to all but the first bean configured in the Smooks configuration i.e. <strong>by default, the first bean is the only bean that is retained</strong> in the BeanContext, and so can be accessed after the message has been processed.</p>
</div>
<div class="paragraph">
<p>To change this default behavior, use the <strong>retain</strong> configuration attribute on the <code>&lt;jb:bean&gt;</code> element. This attribute allows you to manually control bean retention within the Smooks BeanContext.</p>
</div>
</div>
<div class="sect5">
<h6 id="preprocessing_binding_values">Preprocessing Binding Values</h6>
<div class="paragraph">
<p>The Java Bean cartridge works by:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Extracting String values from the source/input message stream.</p>
</li>
<li>
<p>Decoding the String value based on the "decoder" and "decodeParam" configurations (note that, if not defined, an attempt is made to reflectively resolve the decoder).</p>
</li>
<li>
<p>The decoded value is set on the target bean.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Sometimes it is necessary to perform some rudimentary "pre-processing" on the String data value before the decode step (between steps #1 and #2 above). An example of this might be where the source data has some characters not supported by the <strong>locale</strong> configuration on <a href="#number-decoding">Numeric Decoding</a> e.g. the numeric value 876592.00 might be represented as "876_592!00" (who knows why). In order to decode this value as (for example) a double value, we need to eliminate the underscore and exclamation mark characters, replacing the exclamation mark with a period i.e. we need to convert it to "876592.00" before decoding.</p>
</div>
<div class="paragraph">
<p>One way of doing this is to write a custom <strong>DataDecoder</strong> implementation (which is recommended if it&#8217;s a recurring decoding operation), but if you need a quick-n-dirty solution, you can specify a <code>valuePreprocess</code>, which is a simple expression to be applied to the Sting value before decoding.</p>
</div>
<div class="paragraph">
<p>As an example for solving the numeric decoding issue described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="c">&lt;!-- A bean property binding example: --&gt;</span>
<span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">class=</span><span class="s">"org.smooks.javabean.OrderItem"</span> <span class="na">createOnElement=</span><span class="s">"price"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">data=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"Double"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"valuePreprocess"</span><span class="nt">&gt;</span>value.replace("_", "").replace("!", ".")<span class="nt">&lt;/jb:decodeParam&gt;</span>
    <span class="nt">&lt;/jb:value&gt;</span>
<span class="nt">&lt;/jb:bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="c">&lt;!-- A direct value binding example: --&gt;</span>
<span class="nt">&lt;jb:value</span> <span class="na">beanId=</span><span class="s">"price"</span> <span class="na">data=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"BigDecimal"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"valuePreprocess"</span><span class="nt">&gt;</span>value.replace("_", "").replace("!", ".")<span class="nt">&lt;/jb:decodeParam&gt;</span>
<span class="nt">&lt;/jb:value&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note in the above example how the String data value is referenced in the expression using the <code>value</code> variable name. The expression can be any valid <a href="http://mvel.documentnode.com/">MVEL</a> expression that operates on the <code>value</code> String and returns a String.</p>
</div>
</div>
<div class="sect5">
<h6 id="creating_beans_using_a_factory">Creating Beans Using a Factory</h6>
<div class="paragraph">
<p>The Java Bean cartridge supports factories for creating the beans. In that case you don’t need a public parameterless constructor. You don’t even have to define the actual class name in the class attribute. Any of the interfaces of the object suffices. However only the methods of that interface are available for binding to. So even if you define a factory, you must always set the class attribute in the bean definition.</p>
</div>
<div class="paragraph">
<p>The factory definition is set in the <code>factory</code> attribute of the bean element. The default factory definition language looks like this:</p>
</div>
<div class="paragraph">
<p>The default factory definition language looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">some</span><span class="o">.</span><span class="na">package</span><span class="o">.</span><span class="na">FactoryClass</span><span class="err">#</span><span class="n">staticMethod</span><span class="o">{.</span><span class="na">instanceMethod</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This basic definition language enables you to define a static public parameterless method that Smooks should call to create the bean. The '<em>instanceMethod</em> part is optional. If it is set it defines the method that will be called on the object that is returned from static method, which should create the bean (The { } chars only illustrates the part that is optional and should be left out of the actual definition!).</p>
</div>
<div class="paragraph">
<p>Here is an example where we instantiate an ArrayList object using a static factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orders"</span>
         <span class="na">class=</span><span class="s">"java.util.List"</span>
         <span class="na">factory=</span><span class="s">"some.package.ListFactory#newList"</span>
        <span class="na">createOnElement=</span><span class="s">"orders"</span><span class="nt">&gt;</span>
     <span class="c">&lt;!-- ... bindings --&gt;</span>
<span class="nt">&lt;/jb:bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The factory definition "some.package.ListFactory#newList" defines that the newList method must be called on the "some.package.ListFactory" class for creating the bean. The class attributes defines that the bean is a List object. What kind of List object (ArrayList, LinkedList) is up to the ListFactory to decide. Here is another example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orders"</span>
         <span class="na">class=</span><span class="s">"java.util.List"</span>
         <span class="na">factory=</span><span class="s">"some.package.ListFactory#getInstance.newList"</span>
         <span class="na">createOnElement=</span><span class="s">"orders"</span><span class="nt">&gt;</span>
     <span class="c">&lt;!-- ... bindings --&gt;</span>
<span class="nt">&lt;/jb:bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we defined that an instance of the ListFactory needs to be retrieved using the static method getInstance and that then the newList method needs to be called on the ListFactory object to create the List object. This construct makes it possible to easily use Singleton Factories.</p>
</div>
<div class="sect6">
<h7 id="other_definition_languages">Other Definition Languages</h7>
<div class="paragraph">
<p>You can use a different definition language then the default basic language. For instance you can use MVEL as the factory definition language.</p>
</div>
<div class="paragraph">
<p>There are three methods to declare which definition language you want to use:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each definition language can have an alias. For instance MVEL has the alias 'mvel'. To define that you want to use MVEL for a specific factory definition you put 'mvel:' in front of the definition. e.g. <code>mvel:some.package.ListFactory.getInstance().newList()</code>. The alias of the default basic language is 'basic'.</p>
</li>
<li>
<p>To set a language as a global default you need to set the ‘factory.definition.parser.class’ global parameter to the full class path of the class that implements the FactoryDefinitionParser interface for the language that you want to use.<br></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have a definition with your default language that includes a ':' then you must prefix that definition with 'default:' else you will run into an Exception.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Instead of using an alias you can also set the full class path of the class that implements the FactoryDefinitionParser interface for the language that you want to use. e.g.
'org.smooks.javabean.factory.MVELFactoryDefinitionParser:some.package.ListFactory.getInstance().newList()'. You probably only should use this for test purposes only. It is much better to define an alias for your language.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you want to define your own language then you need to implement the <code>org.smooks.javabean.factory.FactoryDefinitionParser</code> interface. Take a look at the <code>org.smooks.javabean.factory.MVELFactoryDefinitionParser</code> or <code>org.smooks.javabean.factory.BasicFactoryDefinitionParser</code> for a good example.</p>
</div>
<div class="paragraph">
<p>To define the alias for a definition language you need to add the 'org.smooks.javabean.factory.Alias' annotation with the alias name to your FactoryDefinitionParser class.</p>
</div>
<div class="paragraph">
<p>For Smooks to find your alias you need create the file 'META-INF/smooks-javabean-factory-definition-parsers.inf' on the root of your classpath. This file must contain the full class path of all the files that implement the FactoryDefinitionParser interface having the Alias annotation (separated by new lines).</p>
</div>
<div class="paragraph">
<div class="title">MVEL as factory definition language</div>
<p>MVEL has some advantages over the basic default definition language, for example you can use objects from the bean context as the factory object or you can call factory methods with parameters. These parameters can be defined within the definition or they can be objects from the bean context. To be able to use MVEL use the alias <code>mvel</code> or you can set the <code>factory.definition.parser.class</code> global parameter to <code>org.smooks.javabean.factory.MVELFactoryDefinitionParser</code>.</p>
</div>
<div class="paragraph">
<p>Here is an example with the same use case as before but then with MVEL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orders"</span> <span class="na">class=</span><span class="s">"java.util.List"</span> <span class="na">factory=</span><span class="s">"mvel:some.package.ListFactory.getInstance().newList()"</span>
             <span class="na">createOnElement=</span><span class="s">"orders"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- ... bindings --&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next example we use MVEL to extract a List object from an existing bean in the bean context. The Order object in this example has method that returns a list which we must use to add the order lines to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span> <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"some.package.Order"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- ... bindings --&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

     <span class="c">&lt;!--
         The factory attribute uses MVEL to access the order
         object in the bean context and calls its getOrderLines()
         method to get the List. This list is then added to the bean
         context under the beanId 'orderLines'
     --&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderLines"</span> <span class="na">class=</span><span class="s">"java.util.List"</span> <span class="na">factory=</span><span class="s">"mvel:order.getOrderLines()"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">beanIdRef=</span><span class="s">"orderLine"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderLine"</span> <span class="na">class=</span><span class="s">"java.util.List"</span> <span class="na">createOnElement=</span><span class="s">"order-line"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- ... bindings --&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maybe you wonder why we don’t use MVEL as the default factory definition language? Currently the performance of the basic definition language and MVEL are about equal. The reason that the basic definition language isn’t faster is because it currently uses reflection to call the factory
methods. However there are plans to use byte code generation instead of reflection. This should improve the performance dramatically. If MVEL where the default language then we couldn’t do anything to improve the performance for those people who don’t need any thing more than the basic features that the basic definition language offers.</p>
</div>
</div>
<div class="sect6">
<h7 id="restrictions">Restrictions</h7>
<div class="paragraph">
<p>Array objects are not supported. If a factory return an array then Smooks will throw an exception at some point.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="binding_key_value_pairs_into_maps">Binding Key Value Pairs into Maps</h6>
<div class="paragraph">
<p>If the attribute of a binding is not defined (or is empty), then the name of the selected node will be used as the map entry key (where the beanClass is a Map).</p>
</div>
<div class="paragraph">
<p>There is one other way to define the map key. The value of the attribute can start with the <code>@</code> character. The rest of the value then defines the attribute name of the selected node, from which the map key is selected. The following example demonstrates this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;root&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"key1"</span><span class="nt">&gt;</span>value1<span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"key2"</span><span class="nt">&gt;</span>value2<span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"key3"</span><span class="nt">&gt;</span>value3<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/root&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"keyValuePairs"</span> <span class="na">class=</span><span class="s">"java.util.HashMap"</span> <span class="na">createOnElement=</span><span class="s">"root"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"@name"</span> <span class="na">data=</span><span class="s">"root/property"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/jb:bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This would create a HashMap with three entries with the keys set [<strong>key1</strong>, <strong>key2</strong>, <strong>key3</strong>].</p>
</div>
<div class="paragraph">
<p>Of course the <code>@</code> the character notation doesn&#8217;t work for bean wiring. The cartridge will simply use the value of the <code>property</code> attribute, including the <code>@</code> character, as the map entry key.</p>
</div>
</div>
<div class="sect5">
<h6 id="virtual_object_models_maps_lists">Virtual Object Models (Maps &amp; Lists)</h6>
<div class="paragraph">
<p>It is possible to create a complete object model without writing your own Bean classes. This virtual model is created using only maps and lists . This is very convenient if you use the javabean cartridge between two processing steps. For example, as part of a model driven transform e.g. xml&#8594;java&#8594;xml or xml&#8594;java&#8594;edi.</p>
</div>
<div class="paragraph">
<p>The following example demonstrates the principle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span> <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--
        Bind data from the message into a Virtual object model in the bean context....
    --&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"java.util.HashMap"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"header"</span> <span class="na">beanIdRef=</span><span class="s">"header"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"orderItems"</span> <span class="na">beanIdRef=</span><span class="s">"orderItems"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"header"</span> <span class="na">class=</span><span class="s">"java.util.HashMap"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"date"</span> <span class="na">decoder=</span><span class="s">"Date"</span> <span class="na">data=</span><span class="s">"header/date"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>EEE MMM dd HH:mm:ss z yyyy<span class="nt">&lt;/jb:decodeParam&gt;</span>
        <span class="nt">&lt;/jb:value&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerNumber"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"header/customer/@number"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerName"</span> <span class="na">data=</span><span class="s">"header/customer"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:expression</span> <span class="na">property=</span><span class="s">"total"</span> <span class="na">execOnElement=</span><span class="s">"order-item"</span> <span class="nt">&gt;</span>
            header.total + (orderItem.price * orderItem.quantity);
        <span class="nt">&lt;/jb:expression&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItems"</span> <span class="na">class=</span><span class="s">"java.util.ArrayList"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">beanIdRef=</span><span class="s">"orderItem"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">class=</span><span class="s">"java.util.HashMap"</span> <span class="na">createOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productId"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"order-item/product"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order-item/quantity"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"Double"</span> <span class="na">data=</span><span class="s">"order-item/price"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="c">&lt;!--
        Use a FreeMarker template to perform the model driven transformation on the Virtual Object Model...
    --&gt;</span>
    <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ftl:template&gt;</span>/templates/orderA-to-orderB.ftl<span class="nt">&lt;/ftl:template&gt;</span>
    <span class="nt">&lt;/ftl:freemarker&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note above how we always define the <code>decoder</code> attribute for a Virtual Model (Map). This is because Smooks has no way of auto-detecting the decode type for data binding to a Map. So, if you need typed values bound into your Virtual Model, you need to specify an appropriate decoder. If the decoder is not specified in this case, Smooks will simply bind the data into the Virtual Model as a String.</p>
</div>
<div class="paragraph">
<p>Take a look at the <a href="https://github.com/smooks/smooks-examples/tree/v1.0.5">model-driven-basic
and model-driven-basic-virtual examples</a>.</p>
</div>
<div class="sect6">
<h7 id="wildcard_bindings">Wildcard Bindings</h7>
<div class="paragraph">
<p>Virtual models also support "wildcard" bindings. That is, you can bind all the child elements of an element into a Map using a single configuration, where the child element names act as the Map entry key and the child element text value acts as the Map entry value. To do this, you simply omit the <em>property</em> attribute from the configuration and use a wildcard in the <code>data</code> attribute.</p>
</div>
<div class="paragraph">
<p>In the following example, we have a element containing some values that we wish to populate into a Map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order-item&gt;</span>
    <span class="nt">&lt;product&gt;</span>111<span class="nt">&lt;/product&gt;</span>
    <span class="nt">&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;</span>
    <span class="nt">&lt;price&gt;</span>8.90<span class="nt">&lt;/price&gt;</span>
<span class="nt">&lt;/order-item&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The wildcard binding config for doing this would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">class=</span><span class="s">"java.util.HashMap"</span> <span class="na">createOnElement=</span><span class="s">"order-items/orderItem"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jb:value</span> <span class="na">data=</span><span class="s">"order-items/orderItem/*"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/jb:bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in the creation of an "orderItem" Map bean instance containing entries [product=111], [quantity=2] and [price=8.90].</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="merging_multiple_data_entities_into_a_single_binding">Merging Multiple Data Entities Into a Single Binding</h6>
<div class="paragraph">
<p>This can be achieved using Expression Based Bindings (&lt;jb:expression&gt;).</p>
</div>
</div>
<div class="sect5">
<h6 id="direct_value_binding">Direct Value Binding</h6>
<div class="paragraph">
<p>As of Smooks 1.3 the Javabean Cartridge has an new feature called direct value binding. Direct value binding uses the Smooks DataDecoder to create an Object from a selected data element/attribute and add it directly to the bean context.</p>
</div>
<div class="paragraph">
<p>The <strong>ValueBinder</strong> class is the visitor that does the value binding.</p>
</div>
<div class="sect6">
<h7 id="configuration">Configuration</h7>
<div class="paragraph">
<p>The value binding XML configuration is part of the JavaBean schema from Smooks 1.3 on:
<a href="/xsd/smooks/javabean-1.6.xsd"><a href="https://www.smooks.org/xsd/smooks/javabean-1.6.xsd" class="bare">https://www.smooks.org/xsd/smooks/javabean-1.6.xsd</a></a>. The element for the value binding is <code>&lt;value&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The <code>&lt;value&gt;</code> has the following attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>beanId</code>: The ID under which the created object is to be bound in the bean context.</p>
</li>
<li>
<p><code>data</code>: The data selector for the data value to be bound. e.g. <code>order/orderid</code> or <code>order/header/@date</code></p>
</li>
<li>
<p><code>dataNS</code>: The namespace for the <code>data</code> selector</p>
</li>
<li>
<p><code>decoder</code>: The DataDecoder name for converting the value from a String into a different type. The DataDecoder can be configured with the elements.</p>
</li>
<li>
<p><code>default</code>: The default value for if the selected data is null or an empty string.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="example">Example</h7>
<div class="paragraph">
<p>Taking the "classic" Order message as an example and getting the order number, name and date as Value Objects in the form of an Integer and String.</p>
</div>
<div class="listingblock">
<div class="title">The Message</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order</span> <span class="na">xmlns=</span><span class="s">"http://x"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;header&gt;</span>
         <span class="nt">&lt;y:date</span> <span class="na">xmlns:y=</span><span class="s">"http://y"</span><span class="nt">&gt;</span>Wed Nov 15 13:45:28 EST 2006<span class="nt">&lt;/y:date&gt;</span>
         <span class="nt">&lt;customer</span> <span class="na">number=</span><span class="s">"123123"</span><span class="nt">&gt;</span>Joe<span class="nt">&lt;/customer&gt;</span>
         <span class="nt">&lt;privatePerson&gt;&lt;/privatePerson&gt;</span>
     <span class="nt">&lt;/header&gt;</span>
     <span class="nt">&lt;order-items&gt;</span>
         <span class="c">&lt;!-- .... --&gt;</span>
     <span class="nt">&lt;/order-items&gt;</span>
 <span class="nt">&lt;/order&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The Configuration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
 <span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                       <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:value</span> <span class="na">beanId=</span><span class="s">"customerName"</span> <span class="na">data=</span><span class="s">"customer"</span> <span class="na">default=</span><span class="s">"unknown"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;jb:value</span> <span class="na">beanId=</span><span class="s">"customerNumber"</span> <span class="na">data=</span><span class="s">"customer/@number"</span> <span class="na">decoder=</span><span class="s">"Integer"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;jb:value</span> <span class="na">beanId=</span><span class="s">"orderDate"</span> <span class="na">data=</span><span class="s">"date"</span> <span class="na">dateNS=</span><span class="s">"http://y"</span> <span class="na">decoder=</span><span class="s">"Date"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>EEE MMM dd HH:mm:ss z yyyy<span class="nt">&lt;/jb:decodeParam&gt;</span>
         <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale-language"</span><span class="nt">&gt;</span>en<span class="nt">&lt;/jb:decodeParam&gt;</span>
         <span class="nt">&lt;jb:decodeParam</span> <span class="na">name=</span><span class="s">"locale-country"</span><span class="nt">&gt;</span>IE<span class="nt">&lt;/jb:decodeParam&gt;</span>
   <span class="nt">&lt;/jb:value&gt;</span>

 <span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="programmatic_configuration">Programmatic Configuration</h7>
<div class="paragraph">
<p>The value binder can be programmatic configured using the <code>org.smooks.javabean.Value</code> Object.</p>
</div>
<div class="paragraph">
<div class="title">Example</div>
<p>We use the same example message as the XML configuration example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//Create Smooks. normally done globally!</span>
<span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="c1">//Create the Value visitors</span>
<span class="nc">Value</span> <span class="n">customerNumberValue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Value</span><span class="o">(</span> <span class="s">"customerNumber"</span><span class="o">,</span> <span class="s">"customer/@number"</span><span class="o">).</span><span class="na">setDecoder</span><span class="o">(</span><span class="s">"Integer"</span><span class="o">);</span>
<span class="nc">Value</span> <span class="n">customerNameValue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Value</span><span class="o">(</span> <span class="s">"customerName"</span><span class="o">,</span> <span class="s">"customer"</span><span class="o">).</span><span class="na">setDefault</span><span class="o">(</span><span class="s">"Unknown"</span><span class="o">);</span>

<span class="c1">//Add the Value visitors</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">addVisitors</span><span class="o">(</span><span class="n">customerNumberValue</span><span class="o">);</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">addVisitors</span><span class="o">(</span><span class="n">customerNameValue</span><span class="o">);</span>

<span class="c1">//And the execution code:</span>
<span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">orderMessageStream</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>
<span class="nc">Integer</span> <span class="n">customerNumber</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Integer</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"customerNumber"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">customerName</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"customerName"</span><span class="o">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="programmatic_configuration_2">Programmatic Configuration</h5>
<div class="paragraph">
<p>Java Binding Configuratons can be programmatically added to a Smooks using the <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks-javabean-cartridge/org/smooks/cartridges/javabean/Bean.html">Bean</a> configuration class.</p>
</div>
<div class="paragraph">
<p>This class can be used to programmatically configure a Smooks instance for performing a Java Bindings on a specific class. To populate a graph, you simply create a graph of Bean instances by binding Beans onto Beans. The Bean class uses a Fluent API (all methods return the Bean instance), making it easy to string configurations together to build up a graph of Bean configuration.</p>
</div>
<div class="sect5">
<h6 id="example_2">Example</h6>
<div class="paragraph">
<p>Taking the classic Order message as an example and binding it into a corresponding Java object model.</p>
</div>
<div class="paragraph">
<p><strong>The Message</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order</span> <span class="na">xmlns=</span><span class="s">"http://x"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;y:date</span> <span class="na">xmlns:y=</span><span class="s">"http://y"</span><span class="nt">&gt;</span>Wed Nov 15 13:45:28 EST 2006<span class="nt">&lt;/y:date&gt;</span>
        <span class="nt">&lt;customer</span> <span class="na">number=</span><span class="s">"123123"</span><span class="nt">&gt;</span>Joe<span class="nt">&lt;/customer&gt;</span>
        <span class="nt">&lt;privatePerson&gt;&lt;/privatePerson&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;order-items&gt;</span>
        <span class="nt">&lt;order-item&gt;</span>
            <span class="nt">&lt;product&gt;</span>111<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;</span>
            <span class="nt">&lt;price&gt;</span>8.90<span class="nt">&lt;/price&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
        <span class="nt">&lt;order-item&gt;</span>
            <span class="nt">&lt;product&gt;</span>222<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>7<span class="nt">&lt;/quantity&gt;</span>
            <span class="nt">&lt;price&gt;</span>5.20<span class="nt">&lt;/price&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
    <span class="nt">&lt;/order-items&gt;</span>
<span class="nt">&lt;/order&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>The Java Model</strong> (not including getters/setters):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Header</span> <span class="n">header</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Header</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">customerNumber</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">customerName</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderItem</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">productId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">quantity</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">price</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>The Configuration Code</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="nc">Bean</span> <span class="n">orderBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bean</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"order"</span><span class="o">,</span> <span class="s">"/order"</span><span class="o">);</span>

<span class="n">orderBean</span><span class="o">.</span><span class="na">bindTo</span><span class="o">(</span><span class="s">"header"</span><span class="o">,</span>
    <span class="n">orderBean</span><span class="o">.</span><span class="na">newBean</span><span class="o">(</span><span class="nc">Header</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"/order"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">bindTo</span><span class="o">(</span><span class="s">"customerNumber"</span><span class="o">,</span> <span class="s">"header/customer/@number"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">bindTo</span><span class="o">(</span><span class="s">"customerName"</span><span class="o">,</span> <span class="s">"header/customer"</span><span class="o">)</span>
    <span class="o">).</span><span class="na">bindTo</span><span class="o">(</span><span class="s">"orderItems"</span><span class="o">,</span>
    <span class="n">orderBean</span><span class="o">.</span><span class="na">newBean</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"/order"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">bindTo</span><span class="o">(</span><span class="n">orderBean</span><span class="o">.</span><span class="na">newBean</span><span class="o">(</span><span class="nc">OrderItem</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"order-item"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">bindTo</span><span class="o">(</span><span class="s">"productId"</span><span class="o">,</span> <span class="s">"order-item/product"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">bindTo</span><span class="o">(</span><span class="s">"quantity"</span><span class="o">,</span> <span class="s">"order-item/quantity"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">bindTo</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="s">"order-item/price"</span><span class="o">))</span>
    <span class="o">);</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">addVisitors</span><span class="o">(</span><span class="n">orderBean</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>The Execution Code</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">JavaResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">orderMessageStream</span><span class="o">),</span> <span class="n">result</span><span class="o">);</span>
<span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Order</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"order"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The API supports factories. You can provide a factory object of the type org.smooks.javabean.factory.Factory, that will be called when a new bean instance needs to be created.</p>
</div>
<div class="paragraph">
<p>Here is an example where an anonymous Factory class is defined and used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Bean</span> <span class="n">orderBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bean</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"order"</span><span class="o">,</span> <span class="s">"/order"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Factory</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;()</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Order</span> <span class="nf">create</span><span class="o">(</span><span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Order</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="xml_to_java_reading_and_writing">XML to Java Reading and Writing</h5>
<div class="paragraph">
<p>The <code>XMLBinding</code> class is a special utility wrapper class around the Smooks runtime. It was introduced in Smooks v1.5 and it is designed specifically for reading and writing XML data to and from Java object models using nothing more than standard configurations i.e. no need to write a template for serializing the Java objects to an output character based format, as with Smooks v1.4 and before.</p>
</div>
<div class="paragraph">
<p>So basically, this functionality allows you to do what you can do with frameworks like JAXB or JiBX i.e. read <em>*and write*</em> between Java and XML using a single configuration, but with the added advantage of being able to easily handle multiple versions of an XML schema/model in a single Java model. You can read and write multiple versions of an XML message into a single/common Java object model. This is very useful in itself, but also means you can easily transform messages from one version to another by reading the XML into the common Java object model using an <code>XMLBinding</code> instance configured for one version of the XML, and then writing those Java objects back out using an <code>XMLBinding</code> instance configured for the other version of the XML.</p>
</div>
<div class="sect5">
<h6 id="simple_xmlbinding_use_case">Simple XMLBinding Use Case</h6>
<div class="paragraph">
<p>Using the XMLBinding class is really easy. You:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>write a standard <a href="#java-binding-configuration-details">Smooks Java Binding Configuration</a>,</p>
</li>
<li>
<p><code>add</code> it to the XMLBinding instance,</p>
</li>
<li>
<p><code>initialize</code> the XMLBinding instance,</p>
</li>
<li>
<p>call the <code>fromXML</code> and <code>toXML</code> methods on the XMLBinding instance.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Create and initialize the XMLBinding instance...</span>
<span class="nc">XMLBinding</span> <span class="n">xmlBinding</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLBinding</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"/smooks-configs/order-xml-binding.xml"</span><span class="o">);</span>
<span class="n">xmlBinding</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>

<span class="c1">// Read the order XML into the Order object model...</span>
<span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">xmlBinding</span><span class="o">.</span><span class="na">fromXML</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">inputReader</span><span class="o">),</span> <span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// Do something with the order....</span>

<span class="c1">// Write the Order object model instance back out to XML...</span>
<span class="n">xmlBinding</span><span class="o">.</span><span class="na">toXML</span><span class="o">(</span><span class="n">order</span><span class="o">,</span> <span class="n">outputWriter</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://github.com/smooks/smooks-examples/tree/v1.0.5/xml-read-write">xml-read-write</a>
example.</p>
</div>
</div>
<div class="sect5">
<h6 id="transforming_xml_messages_using_xmlbinding">Transforming XML Messages Using XMLBinding</h6>
<div class="paragraph">
<p>As stated above, one of the more powerful capabilities of the XMLBinding class is its ability to read and write multiple versions/formats of a given message into a single common Java object model. By extensions, this means that you can use it to transform messages from one version to another by reading the XML into the common Java object model using an XMLBinding instance configured for one version of the XML, and then writing those Java objects back out using an XMLBinding instance  configured for the other version of the XML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Create and initilise the XMLBinding instances for v1 and v2 of the XMLs...</span>
<span class="nc">XMLBinding</span> <span class="n">xmlBindingV1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLBinding</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"v1-binding-config.xml"</span><span class="o">);</span>
<span class="nc">XMLBinding</span> <span class="n">xmlBindingV2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLBinding</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"v2-binding-config.xml"</span><span class="o">);</span>
<span class="n">xmlBindingV1</span><span class="o">.</span><span class="na">intiailize</span><span class="o">();</span>
<span class="n">xmlBindingV2</span><span class="o">.</span><span class="na">intiailize</span><span class="o">();</span>

<span class="c1">// Read the v1 order XML into the Order object model...</span>
<span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">xmlBindingV1</span><span class="o">.</span><span class="na">fromXML</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">inputReader</span><span class="o">),</span> <span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// Write the Order object model instance back out to XML using the v2 XMLBinding instance...</span>
<span class="n">xmlBindingV2</span><span class="o">.</span><span class="na">toXML</span><span class="o">(</span><span class="n">order</span><span class="o">,</span> <span class="n">outputWriter</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://github.com/smooks/smooks-examples/tree/v1.0.5/xml-read-write-transform">xml-read-write-transform</a> example.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="generating_the_smooks_binding_configuration">Generating the Smooks Binding Configuration</h5>
<div class="paragraph">
<p>The Javabean Cartridge contains the <code>org.smooks.javabean.gen.ConfigGenerator</code> utility class that can be used to generate a binding configuration template. This template can then be used as the basis for defining a binding.</p>
</div>
<div class="paragraph">
<p>From the commandline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>$JAVA_HOME/bin/java -classpath org.smooks.javabean.gen.ConfigGenerator -c -o [-p ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>-c</code> commandline arg specifies the root class of the model whose binding config is to be generated.</p>
</li>
<li>
<p>The <code>-o</code> commandline arg specifies the path and filename for the generated config output.</p>
</li>
<li>
<p>The <code>-p</code> commandline arg specifies the path and filename optional binding configuration file that specifies additional binding parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The optional <code>-p</code> properties file parameter allows specification of additional config parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>packages.included</code>: Semi-colon separated list of packages. Any fields in the class matching these packages will be included in the binding configuration generated.</p>
</li>
<li>
<p><code>packages.excluded</code>: Semi-colon separated list of packages. Any fields in the class matching these packages will be excluded from the binding configuration generated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After running this utility against the target class, you typically need to perform the following follow-up tasks in order to make the binding configuration work for your Source data model.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For each <code>&lt;jb:bean&gt;</code> element, set the <code>createOnElement</code> attribute to the event element that should be used to create the bean instance.</p>
</li>
<li>
<p>Update the <code>&lt;jb:value data&gt;</code> attributes to select the event element/attribute supplying the binding data for that bean property.</p>
</li>
<li>
<p>Check the <code>&lt;jb:value decoder&gt;</code> attributes. Not all will be set, depending on the actual property type. These must be configured by hand e.g. you may need to configure <code>&lt;jb:decodeParam&gt;</code> sub-elements for the decoder on some of the bindings. E.g. for a date field.</p>
</li>
<li>
<p>Double-check the binding config elements (<code>&lt;jb:value&gt;</code> and <code>&lt;jb:wiring&gt;</code>), making sure all Java properties have been covered in the generated configuration.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Determining the selector values can sometimes be difficult, especially for non-XML Sources (Java, etc&#8230;&#8203;). The Html Reporting tool can be a great help here because it helps you visualise the input message model (against which the selectors will be applied) as seen by Smooks. So, first off, generate a report using your Source data, but with an empty transformation configuration. In the report, you can see the model against which you need to add your configurations. Add the configurations one at a time, rerunning the report to check they are being applied.</p>
</div>
<div class="paragraph">
<p>The following is an example of a generated configuration. Note the <code>$TODO$</code> tokens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"org.smooks.javabean.Order"</span> <span class="na">createOnElement=</span><span class="s">"$TODO$"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"header"</span> <span class="na">beanIdRef=</span><span class="s">"header"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"orderItems"</span> <span class="na">beanIdRef=</span><span class="s">"orderItems"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"orderItemsArray"</span> <span class="na">beanIdRef=</span><span class="s">"orderItemsArray"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"header"</span> <span class="na">class=</span><span class="s">"org.smooks.javabean.Header"</span> <span class="na">createOnElement=</span><span class="s">"$TODO$"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"date"</span> <span class="na">decoder=</span><span class="s">"$TODO$"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerNumber"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerName"</span> <span class="na">decoder=</span><span class="s">"String"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"privatePerson"</span> <span class="na">decoder=</span><span class="s">"Boolean"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"order"</span> <span class="na">beanIdRef=</span><span class="s">"order"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItems"</span> <span class="na">class=</span><span class="s">"java.util.ArrayList"</span> <span class="na">createOnElement=</span><span class="s">"$TODO$"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">beanIdRef=</span><span class="s">"orderItems_entry"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItems_entry"</span> <span class="na">class=</span><span class="s">"org.smooks.javabean.OrderItem"</span> <span class="na">createOnElement=</span><span class="s">"$TODO$"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productId"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"Double"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"order"</span> <span class="na">beanIdRef=</span><span class="s">"order"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItemsArray"</span> <span class="na">class=</span><span class="s">"org.smooks.javabean.OrderItem[]"</span> <span class="na">createOnElement=</span><span class="s">"$TODO$"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">beanIdRef=</span><span class="s">"orderItemsArray_entry"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItemsArray_entry"</span> <span class="na">class=</span><span class="s">"org.smooks.javabean.OrderItem"</span> <span class="na">createOnElement=</span><span class="s">"$TODO$"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productId"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"Double"</span> <span class="na">data=</span><span class="s">"$TODO$"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"order"</span> <span class="na">beanIdRef=</span><span class="s">"order"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="notes_on_javaresult">Notes on JavaResult</h5>
<div class="paragraph">
<p>Users should note that there is <strong>no guarantee</strong> as to the exact contents of a <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/io/payload/JavaResult.html">JavaResult</a> instance after calling the Smooks.filterSource method. After calling this method, the JavaResult instance will contain the final contents of the bean context, which can be added to by any visitor.</p>
</div>
<div class="paragraph">
<p>You can restrict the Bean set returned in a JavaResult by using a <code>&lt;jb:result&gt;</code> configuration in the Smooks configuration. In the following example configuration, we tell Smooks to only retain the  "order" bean in the ResultSet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Capture some data from the message into the bean context... --&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"com.acme.Order"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"orderId"</span> <span class="na">data=</span><span class="s">"order/@id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerNumber"</span> <span class="na">data=</span><span class="s">"header/customer/@number"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerName"</span> <span class="na">data=</span><span class="s">"header/customer"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"orderItems"</span> <span class="na">beanIdRef=</span><span class="s">"orderItems"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItems"</span> <span class="na">class=</span><span class="s">"java.util.ArrayList"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">beanIdRef=</span><span class="s">"orderItem"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">class=</span><span class="s">"com.acme.OrderItem"</span> <span class="na">createOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"itemId"</span> <span class="na">data=</span><span class="s">"order-item/@id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productId"</span> <span class="na">data=</span><span class="s">"order-item/product"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">data=</span><span class="s">"order-item/quantity"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">data=</span><span class="s">"order-item/price"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="c">&lt;!-- Only retain the "order" bean in the root of any final JavaResult. --&gt;</span>
    <span class="nt">&lt;jb:result</span> <span class="na">retainBeans=</span><span class="s">"order"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So after applying this configuration, calls to the JavaResult.getBean(String) method for anything other than the "order" bean will return null. This will work fine in cases such as the above example, because the other bean instances are wired into the "order" graph.</p>
</div>
<div class="paragraph">
<p>Note that as of Smooks v1.2, if a <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/io/payload/JavaSource.html">JavaSource</a> instance is supplied to the <code>Smooks#filterSource</code> method (as the filter Source instance), Smooks will use the JavaSource to construct the bean context associated with the <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks/org/smooks/api/ExecutionContext.html">ExecutionContext</a> for that Smooks.filterSource invocation. This will mean that some JavaSource bean instances may be visible in the JavaResult.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven_coordinates_9">Maven Coordinates</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-javabean-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml_namespace_6">XML Namespace</h4>
<div class="literalblock">
<div class="content">
<pre>xmlns:jb="https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="templating">Templating</h3>
<div class="paragraph">
<p>Smooks Templating Cartridge supports the following template providers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://freemarker.org/">FreeMarker</a></p>
</li>
<li>
<p><a href="https://www.w3.org/TR/xslt/">XSLT</a></p>
</li>
<li>
<p><a href="https://www.stringtemplate.org/">StringTemplate</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This cartridge adds the ability to use these templating technologies within the Smooks filtering process. This means that templates can:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Be applied to an input source on a per-fragment basis (e.g., for transformations) as opposed to the whole document. This could be useful in situations where you only wish to insert a piece of data into a stream at a specific position (e.g., add headers to a SOAP message) but do not wish to interfere with the rest of the stream. In this case, you can apply the template to the fragment of interest. This method of transformation is commonly known as enrichment.</p>
</li>
<li>
<p>Take advantage of other Smooks cartridges such as the <a href="https://github.com/smooks/smooks-javabean-cartridge/blob/master/README.adoc">JavaBean cartridge</a>. You can use the JavaBean cartridge to (1) decode and bind the stream data to the Smooks bean context, and then (2) reference that decoded data from within your FreeMarker template.</p>
</li>
<li>
<p>Be used to process huge message streams (e.g., gigabytes), while at the same time maintain a relatively simple processing model, with a low memory footprint. See <a href="https://www.smooks.org/documentation/#processing_huge_messages_gbs">Processing Huge Messages</a> for further information.</p>
</li>
<li>
<p>Be used for generating new fragments that can then be routed (using <a href="https://www.smooks.org/documentation/#splitting_routing">Smooks Routing components</a>) to physical endpoints (e.g., File, JMS), or logical endpoints on an ESB (a "Service").</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Smooks can be extended to support other templating technologies.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be sure to read the section on <a href="https://github.com/smooks/smooks-javabean-cartridge/blob/master/README.adoc#java-binding">Java Binding</a>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="freemarker_templating">FreeMarker Templating</h5>
<div class="paragraph">
<p><a href="http://freemarker.org/">FreeMarker</a> is a powerful templating engine. Smooks uses FreeMarker to create text from a fragment. This text can then be inserted into the result stream, or <a href="https://www.smooks.org/documentation/#splitting_routing">routed to another process</a>.</p>
</div>
<div class="paragraph">
<p>Add the schema declaration <code>https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd</code> to the Smooks XML config to configure FreeMarker resources with namespace elements.</p>
</div>
<div class="paragraph">
<p><strong>Example - Inline Template</strong>:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!--&lt;orderId&gt;${order.id}&lt;/orderId&gt;--&gt;</span><span class="nt">&lt;/ftl:template&gt;</span>
    <span class="nt">&lt;/ftl:freemarker&gt;</span>
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Example - External Template Reference</strong>:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ftl:template&gt;</span>/templates/shop/ordergen.ftl<span class="nt">&lt;/ftl:template&gt;</span>
    <span class="nt">&lt;/ftl:freemarker&gt;</span>
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="sect5">
<h6 id="freemarker_transformations_using_node_trees">FreeMarker transformations using node trees</h6>
<div class="paragraph">
<p>The easiest way to construct message transformations in FreeMarker is to leverage FreeMarker&#8217;s <a href="http://freemarker.org/docs/xgui_expose_dom.html">DOM tree</a> facility. This is where FreeMarker uses a W3C DOM for node variables, referencing the DOM nodes directly from inside the FreeMarker template. Smooks extends this by:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Capturing DOM nodes on a fragment-basis: you do not have to use the full document for the DOM model, just the targeted fragment.</p>
</li>
<li>
<p>Allowing the captured DOM nodes node trees to be referenced from Freemarker templates during filtering to create non-XML messages like CSV and JSON.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To take advantage of this facility in Smooks, you need to configure a <code>org.smooks.engine.resource.visitor.dom.DomModelCreator</code> resource that declares the node trees to be captured:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--
      Create a pipeline that replaces &lt;order&gt;...&lt;/order&gt; with &lt;salesorder&gt;...&lt;/salesorder&gt;. In this example, the total memory footprint is kept as low as possible. An &lt;order&gt; event will hold only the order ID and not the main bulk of data in the message (i.e., order-item elements). At any one time, Smooks will have just a single &lt;order-item&gt; in main memory.
    --&gt;</span>
    <span class="nt">&lt;core:smooks</span> <span class="na">filterSourceOn=</span><span class="s">"#document"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;core:action&gt;</span>
            <span class="nt">&lt;core:inline&gt;</span>
                <span class="nt">&lt;core:replace/&gt;</span>
            <span class="nt">&lt;/core:inline&gt;</span>
        <span class="nt">&lt;/core:action&gt;</span>
        <span class="nt">&lt;core:config&gt;</span>
            <span class="nt">&lt;smooks-resource-list&gt;</span>
                <span class="c">&lt;!--
                    Create 2 node trees.  One model for the "customer" and then one
                    per "order-item".

                    These model are used in the FreeMarker templating resources
                    defined below.  You need to make sure you set the selector such
                    that the total memory footprint is as low as possible. In this
                    example, the "customer" model will contain the customer name. The
                    "order-item" model only contains the current &lt;order-item&gt; data
                    (i.e., there's max 1 order-item in memory at any one time).
                --&gt;</span>
                <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"customer,order-item"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;resource&gt;</span>org.smooks.engine.resource.visitor.dom.DomModelCreator<span class="nt">&lt;/resource&gt;</span>
                <span class="nt">&lt;/resource-config&gt;</span>
                <span class="c">&lt;!--
                    Apply the first part of the template when we reach the start
                    of the &lt;order&gt; element.
                --&gt;</span>
                <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order"</span> <span class="na">applyBefore=</span><span class="s">"true"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!--&lt;salesorder&gt;
&lt;details&gt;
&lt;orderid&gt;${order.@id}&lt;/orderid&gt;
--&gt;</span>                 <span class="nt">&lt;/ftl:template&gt;</span>
                <span class="nt">&lt;/ftl:freemarker&gt;</span>
                <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"header/customer"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!-- &lt;customer&gt;
&lt;id&gt;${customer.@number}&lt;/id&gt;
&lt;name&gt;${customer}&lt;/name&gt;
&lt;/customer&gt;
&lt;/details&gt;
&lt;itemList&gt;--&gt;</span>       <span class="nt">&lt;/ftl:template&gt;</span>
                <span class="nt">&lt;/ftl:freemarker&gt;</span>
                <span class="c">&lt;!--
                    Output the &lt;order-items&gt; elements.
                --&gt;</span>
                <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!-- &lt;item&gt;
&lt;id&gt;${.vars["order-item"].@id}&lt;/id&gt;
&lt;productId&gt;${.vars["order-item"].product}&lt;/productId&gt;
&lt;quantity&gt;${.vars["order-item"].quantity}&lt;/quantity&gt;
&lt;price&gt;${.vars["order-item"].price}&lt;/price&gt;
&lt;/item&gt;--&gt;</span>           <span class="nt">&lt;/ftl:template&gt;</span>
                <span class="nt">&lt;/ftl:freemarker&gt;</span>
                <span class="c">&lt;!--
                    Apply the last part of the template when we reach the end
                    of the &lt;order&gt; element.
                --&gt;</span>
                <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!--&lt;/itemList&gt;
&lt;/salesorder&gt;--&gt;</span>    <span class="nt">&lt;/ftl:template&gt;</span>
                <span class="nt">&lt;/ftl:freemarker&gt;</span>
            <span class="nt">&lt;/smooks-resource-list&gt;</span>
        <span class="nt">&lt;/core:config&gt;</span>
    <span class="nt">&lt;/core:smooks&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="freemarker_and_javabean_cartridge">FreeMarker and JavaBean Cartridge</h6>
<div class="paragraph">
<p>FreeMarker node trees are very powerful and easy to use. The trade-off is performance. Constructing W3C DOMs is expensive. It also may be the case that the required data has already been extracted and populated into a Java object model (e.g., where the data also needs to be routed to a JMS endpoint as Java Objects).</p>
</div>
<div class="paragraph">
<p>In situations where using a node tree is not practical, Smooks allows you to use the JavaBean Cartridge to populate a POJO (or a Virtual Model). This model can then be referencing from the FreeMarker templated. See the docs on the <a href="https://github.com/smooks/smooks-javabean-cartridge/blob/master/README.adoc">JavaBean Cartridge</a> for more details.</p>
</div>
<div class="paragraph">
<p><strong>Example (using a Virtual Model)</strong>:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Extract and decode data from the message. Used in the freemarker template (below). --&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"java.util.Hashtable"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"orderId"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order/@id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerNumber"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"header/customer/@number"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerName"</span> <span class="na">data=</span><span class="s">"header/customer"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"orderItem"</span> <span class="na">beanIdRef=</span><span class="s">"orderItem"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">class=</span><span class="s">"java.util.Hashtable"</span> <span class="na">createOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"itemId"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order-item/@id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productId"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"order-item/product"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order-item/quantity"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"Double"</span> <span class="na">data=</span><span class="s">"order-item/price"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!--&lt;orderitem id="${order.orderItem.itemId}" order="${order.orderId}"&gt;
 &lt;customer&gt;
 &lt;name&gt;${order.customerName}&lt;/name&gt;
 &lt;number&gt;${order.customerNumber?c}&lt;/number&gt;
 &lt;/customer&gt;
 &lt;details&gt;
 &lt;productId&gt;${order.orderItem.productId}&lt;/productId&gt;
 &lt;quantity&gt;${order.orderItem.quantity}&lt;/quantity&gt;
 &lt;price&gt;${order.orderItem.price}&lt;/price&gt;
 &lt;/details&gt;
&lt;/orderitem&gt;--&gt;</span>
        <span class="nt">&lt;/ftl:template&gt;</span>
    <span class="nt">&lt;/ftl:freemarker&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
See full example in the <a href="https://github.com/smooks/smooks-examples/tree/v1.0.5/file-router">file-router</a> example
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="programmatic_configuration_3">Programmatic Configuration</h6>
<div class="paragraph">
<p>FreeMarker templating configurations can be programmatically added to a Smooks instance by configuring and adding a <a href="https://www.smooks.org/javadoc/v2.0.0-RC4/smooks-templating-cartridge/org/smooks/cartridges/templating/freemarker/FreeMarkerTemplateProcessor.html"><code>FreeMarkerTemplateProcessor</code></a> instance to the Smooks instance. The following example creates a Smooks instance with Java binding and FreeMarker templating configurations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">addVisitor</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bean</span><span class="o">(</span><span class="nc">OrderItem</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"orderItem"</span><span class="o">,</span> <span class="s">"order-item"</span><span class="o">).</span><span class="na">bindTo</span><span class="o">(</span><span class="s">"productId"</span><span class="o">,</span> <span class="s">"order-item/product/@id"</span><span class="o">));</span>
<span class="n">smooks</span><span class="o">.</span><span class="na">addVisitor</span><span class="o">(</span><span class="k">new</span> <span class="nc">FreeMarkerTemplateProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">TemplatingConfiguration</span><span class="o">(</span><span class="s">"/templates/order-tem.ftl"</span><span class="o">)),</span> <span class="s">"order-item"</span><span class="o">);</span>

<span class="c1">// And then just use Smooks as normal... filter a Source to a Result etc...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="xslt_templating">XSLT Templating</h5>
<div class="paragraph">
<p>Configuring XSL resources in Smooks is almost identical to that of configuring <a href="#freemarker-templating">FreeMarker resources</a>. Add the schema declaration <code>https://www.smooks.org/xsd/smooks/xsl-2.0.xsd</code> to the Smooks XML config to configure XSL resources with namespace elements.</p>
</div>
<div class="paragraph">
<p><strong>Example</strong>:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:xsl=</span><span class="s">"https://www.smooks.org/xsd/smooks/xsl-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;xsl:xsl</span> <span class="na">applyOnElement=</span><span class="s">"#document"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;xsl:template&gt;</span><span class="c">&lt;!--&lt;xxxxxx/&gt;--&gt;</span><span class="nt">&lt;/xsl:template&gt;</span>
    <span class="nt">&lt;/xsl:xsl&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with a FreeMarker resource, an XSLT script can be externally referenced from the XSL resource.</p>
</div>
<div class="paragraph">
<p>As already stated, configuring XSLT templates in Smooks is almost identical to that of configuring FreeMarker templates (see above). For this reason, please consult the FreeMarker configuration docs. Translating to XSL counterparts is simply a matter of changing the configuration namespace. However, please read the following sections.</p>
</div>
<div class="sect5">
<h6 id="points_to_note_regarding_xslt_support">Points to note regarding XSLT support</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It is not recommended to use Smooks for executing XSLT, unless:</p>
<div class="ulist">
<ul>
<li>
<p>You need to perform fragment transformations, in other words, you are not transforming the whole message.</p>
</li>
<li>
<p>You need to use other Smooks functionality to perform other operations on the input source, such as message splitting, persistence, etc&#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>Smooks applies XSLT scripts on a fragment-basis (i.e., DOM element nodes) instead of the whole document (i.e., DOM document node). This can be very useful for modularizing your XSLT scripts, however, one ought not to assume that an XSLT script written and working standalone (externally to Smooks and on the whole document) will behave as expected when called from Smooks without modification. The reason is that Smooks handles XSLT targeted at the document root node differently: Smooks applies the XSLT to the DOM document node instead of the root DOM element. You may need to tweak to the stylesheet if you already have XSLT scripts and are porting them to Smooks.</p>
</li>
<li>
<p>XSLT scripts typically contain a template matched to the root element. Because Smooks applies the XSLT on a fragment-basis, matching against the "root element" is no longer valid. You need to make sure the stylesheet contains a template that matches against the context node (i.e., the targeted fragment).</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="my_xslt_works_outside_smooks_but_not_from_within_smooks">My XSLT works outside Smooks but not from within Smooks?</h6>
<div class="paragraph">
<p>This can happen and is most likely going to be a result of your stylesheet containing a template that is using an absolute path reference to the document root node. This will cause issues in the Smooks fragment-based processing model because the element being targeted by Smooks is not the document root node. Your XSLT needs to contain a template that matches against the context node being targeted by Smooks.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="maven_coordinates_10">Maven Coordinates</h5>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-templating-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="validating_data">Validating Data</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="rules">Rules</h3>
<div class="paragraph">
<p>Rules in Smooks refer to a general concept and is not specific to any cartridge. A RuleProvider can be configured and referenced from other components. As of Smooks v1.2, the only Cartridge using Rules functionality is the <a href="https://github.com/smooks/smooks-validation-cartridge/blob/master/README.adoc">Validation Cartridge</a>.</p>
</div>
<div class="paragraph">
<p>So, lets start by looking at what rules in Smooks are, and how they are used.</p>
</div>
<div class="sect4">
<h5 id="rule_configuration">Rule Configuration</h5>
<div class="paragraph">
<p>Rules are centrally defined through <code>ruleBase</code> definitions. A single Smooks config can reference many <code>ruleBase</code> definitions. A <code>rulesBase</code> configuration consists of a <code>name</code>, a rule <code>src</code>, and a rule <code>provider</code>. The format of the rule source is entirely dependent on the provider implementation. The only requirement is that the individual rules be named (unique within the context of a single source) so as they can be referenced by their name.</p>
</div>
<div class="paragraph">
<p>An example of a <code>ruleBase</code> configuration is as follows:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:rules=</span><span class="s">"https://www.smooks.org/xsd/smooks/rules-1.1.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;rules:ruleBases&gt;</span>
        <span class="nt">&lt;rules:ruleBase</span> <span class="na">name=</span><span class="s">"regexAddressing"</span> <span class="na">src=</span><span class="s">"/org/smooks/validation/address.properties"</span>
                        <span class="na">provider=</span><span class="s">"org.smooks.rules.regex.RegexProvider"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;rules:ruleBase</span> <span class="na">name=</span><span class="s">"order"</span> <span class="na">src=</span><span class="s">"/org/smooks/validation/order/rules/order-rules.csv"</span>
                        <span class="na">provider=</span><span class="s">"org.smooks.rules.mvel.MVELProvider"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/rules:ruleBases&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="sect5">
<h6 id="rule_base_configuration_options">Rule Base Configuration Options</h6>
<div class="paragraph">
<p>The following are the configuration options for the configuration element.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code>: Is used to reference this rule from other components, like from a validation configuration that we will look at shortly. Required.</p>
</li>
<li>
<p><code>src</code>: Is a file or anything meaningful to the RuleProvider. This could be a file containing rules for example. Required.</p>
</li>
<li>
<p><code>provider</code>: Is the actual provider implementation that you want to use. This is where the different technologies come into play. In the above configuration we have one RuleProvider that uses regular expression. As you might have guessed you can specify multiple ruleBase element and have as many RuleProviders you need. Required.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ruleprovider_implementations">RuleProvider Implementations</h5>
<div class="paragraph">
<p>Rule Providers implement the <code>org.smooks.rules.RuleProvider</code> interface.</p>
</div>
<div class="paragraph">
<p>Smooks v1.2 supports 2 RuleProvider implementations out-of-the-box:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#regexprovider">RegexProvider</a></p>
</li>
<li>
<p><a href="#mvelprovider">MVELProvider</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can easily create custom RuleProvider implementations. Future versions of Smooks will probably include support for e.g. a Drools RuleProvider.</p>
</div>
<div class="sect5">
<h6 id="regexprovider">RegexProvider</h6>
<div class="paragraph">
<p>As it&#8217;s name suggests, the RegexProvider is based on regular expression.It allows you to define low level rules specific to the format of specific fields of data in the message being filtered e.g. that a particular field is a valid email address.</p>
</div>
<div class="paragraph">
<p>Configuration of a Regex <code>ruleBase</code> would look like this:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:rules=</span><span class="s">"https://www.smooks.org/xsd/smooks/rules-1.1.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;rules:ruleBases&gt;</span>
        <span class="nt">&lt;rules:ruleBase</span> <span class="na">name=</span><span class="s">"customer"</span> <span class="na">src=</span><span class="s">"/org/smooks/validation/order/rules/customer.properties"</span>
                        <span class="na">provider=</span><span class="s">"org.smooks.rules.regex.RegexProvider"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/rules:ruleBases&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Regex expressions are defined in standard <em>.properties</em> file format. An example of a <em>customer.properties</em> Regex rule definition file (from the above example) might be as follows:</p>
</div>
<div class="listingblock">
<div class="title">customer.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># Customer data rules...
</span><span class="py">customerId</span><span class="p">=</span><span class="s">[A-Z][0-9]{5}</span>
<span class="py">customerName</span><span class="p">=</span><span class="s">[A-Z][a-z]*, [A-Z][a-z]</span></code></pre>
</div>
</div>
<div class="sect6">
<h7 id="useful_regular_expressions">Useful Regular Expressions</h7>
<div class="paragraph">
<p>The following is a list of "useful" regular expressions that we hope to grow over time as a resource for people use Regex Rules.</p>
</div>
<div class="paragraph">
<p>See the <a href="http://regexlib.com/">Regular Expression Library</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># Email Address Validation
</span><span class="py">email</span><span class="p">=</span><span class="s">^((?&gt;[a-zA-Z</span><span class="se">\d</span><span class="c">!#$%&amp;'*+\-/=?^_`{|}~]+\x20*|"((?=[\x01-\x7f])[^"\\]|\\[\x01-\x7f])*"\x20*)*(?&lt;angle&gt;&lt;))?((?!\.)(?&gt;\.?[a-zA-Z\d!#$%&amp;'*+\-/=?^_`{|}~]+)+|"((?=[\x01-\x7f])[^"\\]|\\[\x01-\x7f])*")@(((?!-)[a-zA-Z\d\-]+(?&lt;!-)\.)+[a-zA-Z]{2,}|\[(((?(?&lt;!\[)\.)(25[0-5]|2[0-4]\d|[01]?\d?\d)){4}|[a-zA-Z\d\-]*[a-zA-Z\d]:((?=[\x01-\x7f])[^\\\[\]]|\\[\x01-\x7f])+)\])(?(angle)&gt;)$
</span>
<span class="c"># Matches a negative or positive percentage between 0 and 100 (inclusive). Accepts up to 2 decimal places.
</span><span class="py">percentage.withdecimal</span><span class="p">=</span><span class="s">^-?[0-9]{0,2}(</span><span class="se">\.</span><span class="s">[0-9]{1,2})?$|^-?(100)(</span><span class="se">\.</span><span class="s">[0]{1,2})?$</span>

<span class="c"># HTTP/HTTPS Url
</span><span class="py">url.http</span><span class="p">=</span><span class="s">^(http|https)</span><span class="se">\:</span><span class="s">//[a-zA-Z0-9</span><span class="se">\-\.</span><span class="s">]+</span><span class="se">\.</span><span class="s">[a-zA-Z]{2,3}(:[a-zA-Z0-9]*)?/?([a-zA-Z0-9</span><span class="se">\-\.</span><span class="s">_</span><span class="se">\?\,\'</span><span class="s">/</span><span class="se">\\\+</span><span class="s">&amp;amp;%</span><span class="se">\$</span><span class="s">#</span><span class="se">\=</span><span class="s">~])*$</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="mvelprovider">MVELProvider</h6>
<div class="paragraph">
<p>The <a href="http://mvel.documentnode.com/">MVEL</a> Provider allows rules to be defined as MVEL expressions. These expressions are executed on the contents of the Smooks Javabean bean context. That means they require Data to be bound (from the message being filtered) into Java objects in the Smooks bean context. This allows you to define more complex (higher level) rules on message fragments, such as "is the product in the targeted order item fragment within the age eligibility constraints of the customer specified in the order header details".</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be sure to read the section on <a href="https://github.com/smooks/smooks-javabean-cartridge/blob/master/README.adoc#java-binding">Java Binding</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configuration of an MVEL <code>ruleBase</code> would look like this:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:rules=</span><span class="s">"https://www.smooks.org/xsd/smooks/rules-1.1.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;rules:ruleBases&gt;</span>
        <span class="nt">&lt;rules:ruleBase</span> <span class="na">name=</span><span class="s">"order"</span> <span class="na">src=</span><span class="s">"/org/smooks/validation/order/rules/order-rules.csv"</span> <span class="na">provider=</span><span class="s">"org.smooks.rules.mvel.MVELProvider"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/rules:ruleBases&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MVEL rules must be defined as Comma Separated Value (CSV) files. The easiest way to edit these files is through a Spreadsheet Application (e.g. OpenOffice or Excel). Each rule record contains 2 fields:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A Rule Name</p>
</li>
<li>
<p>An MVEL Expression</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Comment/header rows can be added by prefixing the first field with a hash ('#') character.</p>
</div>
<div class="paragraph">
<p>An example of an MVEL rule CSV file as seen in OpenOffice is as follows:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks-rules-cartridge/master/docs/images/MVEL-csv-rulebase.png" alt="Image:MVEL-csv-rulebase.png"></span></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="maven_coordinates_11">Maven Coordinates</h5>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-rules-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="xml_namespace_7">XML Namespace</h5>
<div class="literalblock">
<div class="content">
<pre>xmlns:rules="https://www.smooks.org/xsd/smooks/rules-1.1.xsd</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rule_based_validation">Rule-Based Validation</h3>
<div class="paragraph">
<p>The Smooks Validation Cartridge builds on the functionality provided by the <a href="https://github.com/smooks/smooks-rules-cartridge/blob/master/README.adoc">rules cartridge</a>, to provide rules-based fragment validation.</p>
</div>
<div class="paragraph">
<p>The type of validation provided by the components of the Smooks Validation Cartridge allows you to perform more detailed validation (over the likes of XSD/Relax) on message fragments. As with everything in Smooks, the Validation functionality is supported across all supported data formats. This means you can perform strong validation on not just XML data, but also on EDI, JSON, CSV, etc&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Validation configurations are defined by the <code>https://www.smooks.org/xsd/smooks/validation-1.1.xsd configuration namespace</code>.</p>
</div>
<div class="sect4">
<h5 id="validation_configuration">Validation Configuration</h5>
<div class="paragraph">
<p>Smooks supports a number of different Rule Provider types that can be used by the Validation Cartridge. They provide different levels of validation. These different forms of Validation are configured in exactly the same way. The Smooks Validation Cartridge sees a Rule Provider as an abstract resource that it can target at message fragments in order to perform validation on the data in that message fragment.</p>
</div>
<div class="paragraph">
<p>A Validation rule configuration is very simple. You simply need to specify:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>executeOn</code>: The fragment on which the rule is to be executed.</p>
</li>
<li>
<p><code>excecuteOnNS</code>: The fragment namespace (NS) that that 'executeOn'
belongs to.</p>
</li>
<li>
<p><code>name</code>: The name of the rule to be applied. This is a
<a href="#composite-rule-name">Composite Rule Name</a> that references a
<code>ruleBase</code> and <code>ruleName</code> combination in a dot delimited format i.e., <em>ruleBaseName.ruleName</em>.</p>
</li>
<li>
<p><code>onFail</code>: The severity of a failed match for the Validation rule. See
<a href="#onfail">onFail</a> section for details.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example of a validation rule configuration would be:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;validation:rule</span> <span class="na">executeOn=</span><span class="s">"order/header/email"</span> <span class="na">name=</span><span class="s">"regexAddressing.email"</span> <span class="na">onFail=</span><span class="s">"ERROR"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
<div class="sect5">
<h6 id="configuring_max_failures">Configuring Max Failures</h6>
<div class="paragraph">
<p>One can set a maximum number of validation failures per Smooks filter operation. An exception will be thrown if this max value is exceeded.Note that validations configured with <code>onFail="FATAL"</code> will always throw an exception and stop processing.</p>
</div>
<div class="paragraph">
<p>To configure the maximum validation failures add this following to you Smooks configuration:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;params&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"validation.maxFails"</span><span class="nt">&gt;</span>5<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/params&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="onfail">onFail</h6>
<div class="paragraph">
<p>The <code>onFail</code> attribute in the validation configuration specified what action should be taken when a rule matches. This is all about reporting back validation failures.</p>
</div>
<div class="paragraph">
<p>The following options are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>OK</code>: Save the validation as an ok validation. Calling <code>ValidationResults.getOks</code> will return all validation warnings. This can be useful for content based routing.</p>
</li>
<li>
<p><code>WARN</code>: Save the validation as a warning. Calling <code>ValidationResults.getWarnings</code> will return all validation warnings.</p>
</li>
<li>
<p><code>ERROR</code>: Save the validation as an error. Calling <code>ValidationResults.getErrors</code> will return all validation errors.</p>
</li>
<li>
<p><code>FATAL</code>: Will throw a <code>ValidationException</code> as soon as a validation failure occurs. Calling <code>ValidationResults.getFatal</code> will return the fatal validation failure.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="composite_rule_name">Composite Rule Name</h6>
<div class="paragraph">
<p>When a RuleBase is referenced in Smooks you use a composite rule name in the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ruleProviderName&gt;</span>.<span class="nt">&lt;ruleName&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ruleProviderName</code> Identifies the rule provider and maps to the 'name' attribute in the 'ruleBase' element.</p>
</div>
<div class="paragraph">
<p><code>ruleName</code> Identifies a specific rule the rule provider knows about.This could be a rule defined in the 'src' file/resource.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="validation_results">Validation Results</h5>
<div class="paragraph">
<p>Validation results are captured by the Smooks.filterSource by specifying a <code>ValidationResult</code> instance in the <code>filterSource</code> method call. When the <code>filterSource</code> method returns, the <code>ValidationResult</code> instance will contain all validation data.</p>
</div>
<div class="paragraph">
<p>An example of executing Smooks in order to perform message fragment validation is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">ValidationResult</span> <span class="n">validationResult</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValidationResult</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">messageInStream</span><span class="o">),</span> <span class="k">new</span> <span class="nc">StreamResult</span><span class="o">(</span><span class="n">messageOutStream</span><span class="o">),</span> <span class="n">validationResult</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">OnFailResult</span><span class="o">&gt;</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">validationResult</span><span class="o">.</span><span class="na">getErrors</span><span class="o">();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">OnFailResult</span><span class="o">&gt;</span> <span class="n">warnings</span> <span class="o">=</span> <span class="n">validationResult</span><span class="o">.</span><span class="na">getWarnings</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the above code, individual warning, error, and other validation results are made available from the <code>ValidationResult</code> object in the form of <code>OnFailResult</code> instances. The <code>OnFailResult</code> object provides details about an individual failure.</p>
</div>
</div>
<div class="sect4">
<h5 id="localized_validation_messages">Localized Validation Messages</h5>
<div class="paragraph">
<p>The Validation Cartridge provides support for specifying localized messages relating to Validation failures. These messages can be defined in standard Java ResourceBundle files (<em>.properties</em> format). A convention is used here, based on the rule source name (<code>src</code>). The validation message bundle base name is derived from the rule source by dropping the rule source file extension and adding an extra folder named <em>i18n</em> e.g. for an MVEL ruleBase source of <em>/org/smooks/validation/order/rules/order-rules.csv</em>, the corresponding validation message bundle base name would be "/org/smooks/validation/order/rules/i18n/order-rules".</p>
</div>
<div class="paragraph">
<p>The validation cartridge supports application of FreeMarker templates on the localized messages, allowing the messages to contain contextual data from the bean context, as well as data about the actual rule failure. FreeMarker based messages must be prefixed with <code>ftl:</code> and the contextual data is references using the normal FreeMarker notation. The beans from the bean context can be referenced directly, while the RuleEvalResult and rule failure path can be referenced through the <code>ruleResult</code> and <code>path</code> beans.</p>
</div>
<div class="paragraph">
<p>Example message using RegexProvider rules:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>customerId=ftl:Invalid customer number '${ruleResult.text}' at '${path}'.  Customer number must match pattern '${ruleResult.pattern}'.</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example_3">Example</h5>
<div class="paragraph">
<p><a href="https://github.com/smooks/smooks-examples/tree/v1.0.2/validation-basic">See the Validation Example</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="maven_coordinates_12">Maven Coordinates</h5>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-validation-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="database_support">Database Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Smooks support for databases include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#jdbc">JDBC resources</a> to read from and write to the database using SQL.</p>
</li>
<li>
<p><a href="#persistence">Entity persistence resources</a> to leverage persistence frameworks such as MyBatis, Hibernate, or any JPA compatible framework.</p>
</li>
<li>
<p><a href="#data-access-objects">Data Access Object (DAO) resources</a> where CRUD methods are invoked to issue database reads and writes.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="jdbc">JDBC</h3>
<div class="paragraph">
<p>Consider an ETL scenario where order and order items needs to be saved to the database:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks-persistence-cartridge/master/docs/images/Db-split-required.png" alt="Image:db-split-required.png"></span></p>
</div>
<div class="paragraph">
<p>To route an order and order item data to a database, you should define a set of Java bindings that extract the <em>order</em> and <em>order-item</em> data from the input source stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Extract the order data... --&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"java.util.Hashtable"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"orderId"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order/@id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerNumber"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"header/customer/@number"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerName"</span> <span class="na">data=</span><span class="s">"header/customer"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="c">&lt;!-- Extract the order-item data... --&gt;</span>
    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderItem"</span> <span class="na">class=</span><span class="s">"java.util.Hashtable"</span> <span class="na">createOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"itemId"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order-item/@id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"productId"</span> <span class="na">decoder=</span><span class="s">"Long"</span> <span class="na">data=</span><span class="s">"order-item/product"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="na">data=</span><span class="s">"order-item/quantity"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"price"</span> <span class="na">decoder=</span><span class="s">"Double"</span> <span class="na">data=</span><span class="s">"order-item/price"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next you need to define datasource configuration, and a number of <code>jdbc:executor</code> configurations that will reference the datasource to insert the POJO fields into the database. This is the datasource configuration (namespace <code>https://www.smooks.org/xsd/smooks/datasource-1.4.xsd</code>) for retrieving a direct database connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:ds=</span><span class="s">"https://www.smooks.org/xsd/smooks/datasource-1.4.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;ds:direct</span> <span class="na">bindOnElement=</span><span class="s">"#document"</span>
              <span class="na">datasource=</span><span class="s">"DBExtractTransformLoadDS"</span>
              <span class="na">driver=</span><span class="s">"org.hsqldb.jdbcDriver"</span>
              <span class="na">url=</span><span class="s">"jdbc:hsqldb:hsql://localhost:9201/smooks-hsql-9201"</span>
              <span class="na">username=</span><span class="s">"sa"</span>
              <span class="na">password=</span><span class="s">""</span>
              <span class="na">autoCommit=</span><span class="s">"false"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to use a JNDI datasource for retrieving a database connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:ds=</span><span class="s">"https://www.smooks.org/xsd/smooks/datasource-1.4.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- This JNDI datasource can handle JDBC and JTA transactions or
         it can leave the transaction managment to an other external component.
         An external component could be an other Smooks visitor, the EJB transaction manager
         or you can do it your self. --&gt;</span>
    <span class="nt">&lt;ds:JNDI</span>
         <span class="na">bindOnElement=</span><span class="s">"#document"</span>
         <span class="na">datasource=</span><span class="s">"DBExtractTransformLoadDS"</span>
         <span class="na">datasourceJndi=</span><span class="s">"java:/someDS"</span>
         <span class="na">transactionManager=</span><span class="s">"JTA"</span>
         <span class="na">transactionJndi=</span><span class="s">"java:/mockTransaction"</span>
         <span class="na">targetProfile=</span><span class="s">"jta"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The datasource schema describes and documents how you can configure the datasource. This is the <code>jdbc:executor</code> configuration (namespace <code>https://www.smooks.org/xsd/smooks/jdbc-2.0.xsd</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jdbc=</span><span class="s">"https://www.smooks.org/xsd/smooks/jdbc-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Assert whether it's an insert or update. Need to do this just before we do the insert/update... --&gt;</span>
    <span class="nt">&lt;jdbc:executor</span> <span class="na">executeOnElement=</span><span class="s">"order-items"</span> <span class="na">datasource=</span><span class="s">"DBExtractTransformLoadDS"</span> <span class="na">executeBefore=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jdbc:statement&gt;</span>select OrderId from ORDERS where OrderId = ${order.orderId}<span class="nt">&lt;/jdbc:statement&gt;</span>
        <span class="nt">&lt;jdbc:resultSet</span> <span class="na">name=</span><span class="s">"orderExistsRS"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jdbc:executor&gt;</span>

    <span class="c">&lt;!-- If it's an insert (orderExistsRS.isEmpty()), insert the order before we process the order items... --&gt;</span>
    <span class="nt">&lt;jdbc:executor</span> <span class="na">executeOnElement=</span><span class="s">"order-items"</span> <span class="na">datasource=</span><span class="s">"DBExtractTransformLoadDS"</span> <span class="na">executeBefore=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;condition&gt;</span>orderExistsRS.isEmpty()<span class="nt">&lt;/condition&gt;</span>
        <span class="nt">&lt;jdbc:statement&gt;</span>INSERT INTO ORDERS VALUES(${order.orderId}, ${order.customerNumber}, ${order.customerName})<span class="nt">&lt;/jdbc:statement&gt;</span>
    <span class="nt">&lt;/jdbc:executor&gt;</span>

    <span class="c">&lt;!-- And insert each orderItem... --&gt;</span>
    <span class="nt">&lt;jdbc:executor</span> <span class="na">executeOnElement=</span><span class="s">"order-item"</span> <span class="na">datasource=</span><span class="s">"DBExtractTransformLoadDS"</span> <span class="na">executeBefore=</span><span class="s">"false"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;condition&gt;</span>orderExistsRS.isEmpty()<span class="nt">&lt;/condition&gt;</span>
        <span class="nt">&lt;jdbc:statement&gt;</span>INSERT INTO ORDERITEMS VALUES (${orderItem.itemId}, ${order.orderId}, ${orderItem.productId}, ${orderItem.quantity}, ${orderItem.price})<span class="nt">&lt;/jdbc:statement&gt;</span>
    <span class="nt">&lt;/jdbc:executor&gt;</span>

    <span class="c">&lt;!-- Ignoring updates for now!! --&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A functional version of this example is available <a href="https://github.com/smooks/smooks-examples/tree/v1.0.2/db-extract-transform-load">online</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="persistence">Persistence</h3>
<div class="paragraph">
<p>You can directly use several persistence frameworks from within Smooks (Hibernate, JPA, etc&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Let us take a look at a Hibernate example. The same principals follow for any JPA compliant framework.</p>
</div>
<div class="paragraph">
<p>The data we are going to process is an XML order message. It should be noted however, that the input data could also be CSV, JSON, EDI, Java or any other structured data format. The same principals apply, no matter what the data format is!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order&gt;</span>
    <span class="nt">&lt;ordernumber&gt;</span>1<span class="nt">&lt;/ordernumber&gt;</span>
    <span class="nt">&lt;customer&gt;</span>123456<span class="nt">&lt;/customer&gt;</span>
    <span class="nt">&lt;order-items&gt;</span>
        <span class="nt">&lt;order-item&gt;</span>
            <span class="nt">&lt;product&gt;</span>11<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
        <span class="nt">&lt;order-item&gt;</span>
            <span class="nt">&lt;product&gt;</span>22<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>7<span class="nt">&lt;/quantity&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
    <span class="nt">&lt;/order-items&gt;</span>
<span class="nt">&lt;/order&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Hibernate entities are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"orders"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">ordernumber</span><span class="o">;</span>

    <span class="nd">@Basic</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">customerId</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"order"</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span> <span class="n">orderItems</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addOrderLine</span><span class="o">(</span><span class="nc">OrderLine</span> <span class="n">orderLine</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">orderItems</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">orderLine</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Getters and Setters....</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"orderlines"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderLine</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"orderid"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Order</span> <span class="n">order</span><span class="o">;</span>

    <span class="nd">@Basic</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">quantity</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"productid"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Product</span> <span class="n">product</span><span class="o">;</span>

    <span class="c1">// Getters and Setters....</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"products"</span><span class="o">)</span>
<span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"product.byId"</span><span class="o">,</span> <span class="n">query</span><span class="o">=</span><span class="s">"from Product p where p.id = :id"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Basic</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="c1">// Getters and Setters....</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What we want to do here is to process and persist the <code>Order</code>. First thing we need to do is to bind the order data into the <code>Order</code> entities (<code>Order</code>, <code>OrderLine</code> and <code>Product</code>). To do this we need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Create</strong> and populate the Order and OrderLine entities using the <a href="#java-binding">Java Binding</a> framework.</p>
</li>
<li>
<p><strong>Wire</strong> each OrderLine instance into the Order instance.</p>
</li>
<li>
<p>Into each OrderLine instance, we need to <strong>lookup and wire</strong> in the associated order line Product entity.</p>
</li>
<li>
<p>And finally, we need to <strong>insert</strong> (persist) the Order instance.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To do this, we need the following Smooks configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span>
                      <span class="na">xmlns:persistence=</span><span class="s">"https://www.smooks.org/xsd/smooks/persistence-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"example.entity.Order"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"ordernumber"</span> <span class="na">data=</span><span class="s">"ordernumber"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerId"</span> <span class="na">data=</span><span class="s">"customer"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">setterMethod=</span><span class="s">"addOrderLine"</span> <span class="na">beanIdRef=</span><span class="s">"orderLine"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderLine"</span> <span class="na">class=</span><span class="s">"example.entity.OrderLine"</span> <span class="na">createOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">data=</span><span class="s">"quantity"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"order"</span> <span class="na">beanIdRef=</span><span class="s">"order"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"product"</span> <span class="na">beanIdRef=</span><span class="s">"product"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;persistence:locator</span> <span class="na">beanId=</span><span class="s">"product"</span> <span class="na">lookupOnElement=</span><span class="s">"order-item"</span> <span class="na">onNoResult=</span><span class="s">"EXCEPTION"</span> <span class="na">uniqueResult=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;persistence:query&gt;</span>from Product p where p.id = :id<span class="nt">&lt;/persistence:query&gt;</span>
        <span class="nt">&lt;persistence:params&gt;</span>
            <span class="nt">&lt;persistence:value</span> <span class="na">name=</span><span class="s">"id"</span> <span class="na">data=</span><span class="s">"product"</span> <span class="na">decoder=</span><span class="s">"Integer"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/persistence:params&gt;</span>
    <span class="nt">&lt;/persistence:locator&gt;</span>

    <span class="nt">&lt;persistence:inserter</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">insertOnElement=</span><span class="s">"order"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we want to use the named query <code>productById</code> instead of the query string then the DAO locator configuration will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;persistence:locator</span> <span class="na">beanId=</span><span class="s">"product"</span> <span class="na">lookupOnElement=</span><span class="s">"order-item"</span> <span class="na">lookup=</span><span class="s">"product.byId"</span> <span class="na">onNoResult=</span><span class="s">"EXCEPTION"</span> <span class="na">uniqueResult=</span><span class="s">"true"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;persistence:params&gt;</span>
        <span class="nt">&lt;persistence:value</span> <span class="na">name=</span><span class="s">"id"</span> <span class="na">data=</span><span class="s">"product"</span> <span class="na">decoder=</span><span class="s">"Integer"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/persistence:params&gt;</span>
<span class="nt">&lt;/persistence:locator&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code executes Smooks. Note that we use a <code>SessionRegister</code> object so that we can access the Hibernate Session from within Smooks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="s">"smooks-config.xml"</span><span class="o">);</span>

<span class="nc">ExecutionContext</span> <span class="n">executionContext</span> <span class="o">=</span> <span class="n">smooks</span><span class="o">.</span><span class="na">createExecutionContext</span><span class="o">();</span>

<span class="c1">// The SessionRegister provides the bridge between Hibernate and the</span>
<span class="c1">// Persistence Cartridge. We provide it with the Hibernate session.</span>
<span class="c1">// The Hibernate Session is set as default Session.</span>
<span class="nc">DaoRegister</span> <span class="n">register</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SessionRegister</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>

<span class="c1">// This sets the DAO Register in the executionContext for Smooks</span>
<span class="c1">// to access it.</span>
<span class="nc">PersistenceUtil</span><span class="o">.</span><span class="na">setDAORegister</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span> <span class="n">register</span><span class="o">);</span>

<span class="nc">Transaction</span> <span class="n">transaction</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filterSource</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>

<span class="n">transaction</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data_access_objects">Data Access Objects</h3>
<div class="paragraph">
<p>Now let’s take a look at a DAO based example. The example will read an XML file containing order information (note that this works just the same for EDI, CSV, etc&#8230;&#8203;). Using the javabean cartridge, it will bind the XML data into a set of entity beans. Using the id of the products within the order items (the element) it will locate the product entities and bind them to the order entity bean. Finally, the order bean will be persisted.</p>
</div>
<div class="paragraph">
<p>The order XML message looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;order&gt;</span>
    <span class="nt">&lt;ordernumber&gt;</span>1<span class="nt">&lt;/ordernumber&gt;</span>
    <span class="nt">&lt;customer&gt;</span>123456<span class="nt">&lt;/customer&gt;</span>
    <span class="nt">&lt;order-items&gt;</span>
        <span class="nt">&lt;order-item&gt;</span>
            <span class="nt">&lt;product&gt;</span>11<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
        <span class="nt">&lt;order-item&gt;</span>
            <span class="nt">&lt;product&gt;</span>22<span class="nt">&lt;/product&gt;</span>
            <span class="nt">&lt;quantity&gt;</span>7<span class="nt">&lt;/quantity&gt;</span>
        <span class="nt">&lt;/order-item&gt;</span>
    <span class="nt">&lt;/order-items&gt;</span>
<span class="nt">&lt;/order&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following custom DAO will be used to persist the Order entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Dao</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderDao</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EntityManager</span> <span class="n">em</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OrderDao</span><span class="o">(</span><span class="nc">EntityManager</span> <span class="n">em</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Insert</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertOrder</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When looking at this class you should notice the <code>@Dao</code> and <code>@Insert</code> annotations. The <code>@Dao</code> annotation declares that the <code>OrderDao</code> is a DAO object. The <code>@Insert</code> annotation declares that the <code>insertOrder</code> method should be used to insert <code>Order</code> entities.</p>
</div>
<div class="paragraph">
<p>The following custom DAO will be used to lookup the <code>Product</code> entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Dao</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductDao</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EntityManager</span> <span class="n">em</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ProductDao</span><span class="o">(</span><span class="nc">EntityManager</span> <span class="n">em</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Lookup</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">findProductById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When looking at this class, you should notice the <code>@Lookup</code> and <code>@Param</code> annotations. The <code>@Lookup</code> annotation declares that the <code>ProductDao#findByProductId</code> method is used to lookup <code>Product</code> entities. The name parameter in the <code>@Lookup</code> annotation sets the lookup name reference for that method. When the name isn’t declared, the method name will be used. The optional <code>@Param</code> annotation lets you name the  parameters. This creates a better abstraction between Smooks and the DAO. If you don’t declare the <code>@Param</code> annotation the parameters are resolved by there position.</p>
</div>
<div class="paragraph">
<p>The Smooks configuration look likes this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:jb=</span><span class="s">"https://www.smooks.org/xsd/smooks/javabean-1.6.xsd"</span>
                      <span class="na">xmlns:persistence=</span><span class="s">"https://www.smooks.org/xsd/smooks/persistence-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">class=</span><span class="s">"example.entity.Order"</span> <span class="na">createOnElement=</span><span class="s">"order"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"ordernumber"</span> <span class="na">data=</span><span class="s">"ordernumber"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"customerId"</span> <span class="na">data=</span><span class="s">"customer"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">setterMethod=</span><span class="s">"addOrderLine"</span> <span class="na">beanIdRef=</span><span class="s">"orderLine"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;jb:bean</span> <span class="na">beanId=</span><span class="s">"orderLine"</span> <span class="na">class=</span><span class="s">"example.entity.OrderLine"</span> <span class="na">createOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jb:value</span> <span class="na">property=</span><span class="s">"quantity"</span> <span class="na">data=</span><span class="s">"quantity"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"order"</span> <span class="na">beanIdRef=</span><span class="s">"order"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jb:wiring</span> <span class="na">property=</span><span class="s">"product"</span> <span class="na">beanIdRef=</span><span class="s">"product"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jb:bean&gt;</span>

    <span class="nt">&lt;persistence:locator</span> <span class="na">beanId=</span><span class="s">"product"</span> <span class="na">dao=</span><span class="s">"product"</span> <span class="na">lookup=</span><span class="s">"id"</span> <span class="na">lookupOnElement=</span><span class="s">"order-item"</span> <span class="na">onNoResult=</span><span class="s">"EXCEPTION"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;persistence:params&gt;</span>
            <span class="nt">&lt;persistence:value</span> <span class="na">name=</span><span class="s">"id"</span> <span class="na">data=</span><span class="s">"product"</span> <span class="na">decoder=</span><span class="s">"Integer"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/persistence:params&gt;</span>
    <span class="nt">&lt;/persistence:locator&gt;</span>

    <span class="nt">&lt;persistence:inserter</span> <span class="na">beanId=</span><span class="s">"order"</span> <span class="na">dao=</span><span class="s">"order"</span> <span class="na">insertOnElement=</span><span class="s">"order"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code executes Smooks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Smooks</span> <span class="n">smooks</span><span class="o">=</span><span class="k">new</span> <span class="nc">Smooks</span><span class="o">(</span><span class="s">"./smooks-configs/smooks-dao-config.xml"</span><span class="o">);</span>
<span class="nc">ExecutionContext</span> <span class="n">executionContext</span><span class="o">=</span><span class="n">smooks</span><span class="o">.</span><span class="na">createExecutionContext</span><span class="o">();</span>

<span class="c1">// The register is used to map the DAO's to a DAO name. The DAO name isbe used in</span>
<span class="c1">// the configuration.</span>
<span class="c1">// The MapRegister is a simple Map like implementation of the DaoRegister.</span>
<span class="nc">DaoRegister</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span><span class="n">register</span> <span class="o">=</span> <span class="nc">MapRegister</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"product"</span><span class="o">,</span><span class="k">new</span> <span class="nc">ProductDao</span><span class="o">(</span><span class="n">em</span><span class="o">))</span>
        <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"order"</span><span class="o">,</span><span class="k">new</span> <span class="nc">OrderDao</span><span class="o">(</span><span class="n">em</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="nc">PersistenceUtil</span><span class="o">.</span><span class="na">setDAORegister</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span><span class="n">mapRegister</span><span class="o">);</span>

<span class="c1">// Transaction management from within Smooks isn't supported yet,</span>
<span class="c1">// so we need to do it outside the filter execution</span>
<span class="nc">EntityTransaction</span> <span class="n">tx</span><span class="o">=</span><span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>
<span class="n">tx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>

<span class="n">smooks</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamSource</span><span class="o">(</span><span class="n">messageIn</span><span class="o">),</span><span class="kc">null</span><span class="o">,</span><span class="n">executionContext</span><span class="o">);</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="maven_coordinates_13">Maven Coordinates</h3>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges.persistence<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-persistence-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="xml_namespaces_3">XML Namespaces</h3>
<div class="literalblock">
<div class="content">
<pre>xmlns:ds="https://www.smooks.org/xsd/smooks/datasource-1.4.xsd"</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>xmlns:jdbc="https://www.smooks.org/xsd/smooks/jdbc-2.0.xsd"</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>xmlns:persistence="https://www.smooks.org/xsd/smooks/persistence-2.0.xsd"</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scripting">Scripting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="groovy">Groovy</h3>
<div class="paragraph">
<p>Support for <a href="https://groovy-lang.org/">Groovy</a> scripting is made available through the <code>https://www.smooks.org/xsd/smooks/groovy-2.0.xsd</code> configuration namespace.</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="title">smooks-config.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:g=</span><span class="s">"https://www.smooks.org/xsd/smooks/groovy-2.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;g:groovy</span> <span class="na">executeOnElement=</span><span class="s">"xxx"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;g:script&gt;</span>
        <span class="c">&lt;!--
 //Rename the target fragment element from "xxx" to "yyy"...
 DomUtils.renameElement(element, "yyy", true, true);
 --&gt;</span>
        <span class="nt">&lt;/g:script&gt;</span>
    <span class="nt">&lt;/g:groovy&gt;</span>

<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Usage Tips</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Imports can be added via the <code>imports</code> element. A number of classes are automatically imported:</p>
<div class="ulist">
<ul>
<li>
<p><code>org.smooks.support.DomUtils</code></p>
</li>
<li>
<p><code>org.smooks.api.bean.context.BeanContext</code></p>
</li>
<li>
<p><code>org.smooks.api.bean.repository.BeanRepository</code></p>
</li>
<li>
<p><code>org.w3c.dom.*</code></p>
</li>
<li>
<p><code>groovy.xml.dom.DOMCategory</code>, <code>groovy.xml.dom.DOMUtil</code>, <code>groovy.xml.DOMBuilder</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>The visited element is available to the script through the variable <code>element</code>. It is also available under a variable name equal to the element name, but only if the element name contains alpha-numeric characters only.</p>
</li>
<li>
<p>By default, the script is executed on the <em>visitAfter</em> event. You can direct it to be executed on the <em>visitBefore</em> by setting the <code>executeBefore</code> attribute to <code>true</code>.</p>
</li>
<li>
<p>If the script contains special XML characters, it can be wrapped in an XML Comment or CDATA section.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="groovy_scriptlet_variables_and_methods">Groovy Scriptlet Variables and Methods</h5>
<div class="paragraph">
<p>A number of variables and methods are made directly available to groovy scriptlet code i.e. you can reference them directly in your scriptlet.</p>
</div>
<div class="sect5">
<h6 id="variables">Variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>element</code>: The DOM/SAX Element (depending on which filter type is in use) i.e. <code>org.w3c.dom.Element</code> or <code>org.api.smooks.delivery.sax.SAXElement</code>.</p>
</li>
<li>
<p><code>executionContext</code>: The Smooks <code>ExecutionContext</code> instance associated with the Smooks filtering operation.</p>
</li>
<li>
<p><code>nodeModels</code>: A map containing all the DOM NodeModels currently available (i.e., <code>Map&lt;String, Element&gt;</code>).</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="methods">Methods</h6>
<div class="ulist">
<ul>
<li>
<p>Get a bean from <code>Object BeanContext#getBean(String beandId)</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="adding_beans_to_the_beancontext">Adding Beans to the BeanContext</h5>
<div class="paragraph">
<p>As shown above, all scriptlet code can access the beans by calling <code>BeanContext#getBean(String)</code> from inside the scriptlet code. One oversight when implementing this feature was that we didn&#8217;t provide an <code>addBean</code> method for adding beans to the bean context. However, it is still possible to do so in a slightly more long-winded method via the <code>executionContext</code> e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">executionContext</span><span class="o">.</span><span class="na">getBeanContext</span><span class="o">().</span><span class="na">addBean</span><span class="o">(</span><span class="s">"myBean"</span><span class="o">,</span> <span class="n">myBeanInstance</span><span class="o">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="maven_coordinates_14">Maven Coordinates</h5>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.smooks.cartridges<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smooks-scripting-cartridge<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-RC4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common_use_cases">Common use cases</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="processing_huge_messages_gbs">Processing Huge Messages (GBs)</h3>
<div class="paragraph">
<p>One of the main features introduced in Smooks v1.0 is the ability to process huge messages (Gbs in size). Smooks supports the following types of processing for huge messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>One-to-One Transformation</strong>: This is the process of transforming a huge message from its source format (e.g. XML), to a huge message in a target format e.g. EDI, CSV, XML etc.</p>
</li>
<li>
<p><strong>Splitting &amp; Routing</strong>: Splitting of a huge message into smaller (more consumable) messages in any format (EDI, XML, Java, etc&#8230;&#8203;) and <strong>Routing</strong> of those smaller messages to a number of different destination types (filesystem, JMS, database).</p>
</li>
<li>
<p><strong>Persistence</strong>: Persisting the components of the huge message to a database, from where they can be more easily queried and processed. Within Smooks, we consider this to be a form of Splitting and Routing (routing to a database).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of the above is possible without writing any code (i.e. in a declarative manner). Typically, any of the above types of processing would have required writing quite a bit of ugly/unmaintainable code. It might also have been implemented as a multi-stage process where the huge message is split into smaller messages (stage #1) and then each smaller message is processed in turn to persist, route, etc&#8230;&#8203; (stage #2). This would all be done in an effort to make that ugly/unmaintainable code a little more maintainable and reusable. With Smooks, most of these use-cases can be handled without writing any code. As well as that, they can also be handled in a single pass over the source message, splitting and routing in parallel (plus routing to multiple destinations of different types and in different formats).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be sure to read the section on <a href="https://github.com/smooks/smooks-javabean-cartridge#java-binding">Java Binding</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="one_to_one_transformation">One-to-One Transformation</h4>
<div class="paragraph">
<p>If the requirement is to process a huge message by transforming it into a single message of another format, the easiest mechanism with Smooks is to apply multiple FreeMarker templates to the Source message Event Stream, outputting to a Smooks.filterSource Result stream.</p>
</div>
<div class="paragraph">
<p>This can be done in one of 2 ways with FreeMarker templating, depending on the type of model that&#8217;s appropriate:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using FreeMarker + NodeModels for the model.</p>
</li>
<li>
<p>Using FreeMarker + a Java Object model for the model. The model can be constructed from data in the message, using the Javabean Cartridge.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Option #1 above is obviously the option of choice, if the tradeoffs are OK for your use case. Please see the FreeMarker Templating docs for more details.</p>
</div>
<div class="paragraph">
<p>The following images shows an message, as well as the message to which we need to transform the message:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks/master/docs/images/Huge-message.png" alt="Image:huge-message.png"></span></p>
</div>
<div class="paragraph">
<p>Imagine a situation where the message contains millions of elements. Processing a huge message in this way with Smooks and FreeMarker (using NodeModels) is quite straightforward. Because the message is huge, we need to identify multiple NodeModels in the message, such that the runtime memory footprint is as low as possible. We cannot process the message using a single model, as the full message is just too big to hold in memory. In the case of the message, there are 2 models, one for the main data (blue highlight) and one for the data (beige highlight):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/smooks/smooks/master/docs/images/Huge-message-models.png" alt="Image:huge-message-models.png"></span></p>
</div>
<div class="paragraph">
<p>So in this case, the most data that will be in memory at any one time is the main order data, plus one of the order-items. Because the NodeModels are nested, Smooks makes sure that the order data NodeModel never contains any of the data from the order-item NodeModels. Also, as Smooks filters the message, the order-item NodeModel will be overwritten for every order-item (i.e. they are not collected). See <a href="#sax-ng">SAX NG</a>.</p>
</div>
<div class="paragraph">
<p>Configuring Smooks to capture multiple NodeModels for use by the FreeMarker templates is just a matter of configuring the <strong>DomModelCreator</strong> visitor, targeting it at the root node of each of the models. Note again that Smooks also makes this available to SAX filtering (the key to processing huge message). The Smooks configuration for creating the NodeModels for this message are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;smooks-resource-list</span> <span class="na">xmlns=</span><span class="s">"https://www.smooks.org/xsd/smooks-2.0.xsd"</span>
                      <span class="na">xmlns:core=</span><span class="s">"https://www.smooks.org/xsd/smooks/smooks-core-1.6.xsd"</span>
                      <span class="na">xmlns:ftl=</span><span class="s">"https://www.smooks.org/xsd/smooks/freemarker-2.0.xsd"</span><span class="nt">&gt;</span>

     <span class="c">&lt;!--
        Create 2 NodeModels. One high level model for the "order"
        (header, etc...) and then one for the "order-item" elements...
     --&gt;</span>
    <span class="nt">&lt;resource-config</span> <span class="na">selector=</span><span class="s">"order,order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;resource&gt;</span>org.smooks.engine.resource.visitor.dom.DomModelCreator<span class="nt">&lt;/resource&gt;</span>
    <span class="nt">&lt;/resource-config&gt;</span>

    <span class="c">&lt;!-- FreeMarker templating configs to be added below... --&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the FreeMarker templates need to be added. We need to apply 3 templates in total:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A template to output the order "header" details, up to but not including the order items.</p>
</li>
<li>
<p>A template for each of the order items, to generate the elements in the .</p>
</li>
<li>
<p>A template to close out the message.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>With Smooks, we implement this by defining 2 FreeMarker templates. One to cover #1 and #3 (combined) above, and a seconds to cover the elements.</p>
</div>
<div class="paragraph">
<p>The first FreeMarker template is targeted at the element and looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order-items"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!--&lt;salesorder&gt;
    &lt;details&gt;
        &lt;orderid&gt;${order.@id}&lt;/orderid&gt;
        &lt;customer&gt;
            &lt;id&gt;${order.header.customer.@number}&lt;/id&gt;
            &lt;name&gt;${order.header.customer}&lt;/name&gt;
        &lt;/customer&gt;
    &lt;/details&gt;
    &lt;itemList&gt;
    &lt;?TEMPLATE-SPLIT-PI?&gt;
    &lt;/itemList&gt;
&lt;/salesorder&gt;--&gt;</span>
        <span class="nt">&lt;/ftl:template&gt;</span>
<span class="nt">&lt;/ftl:freemarker&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the <code>+&lt;?TEMPLATE-SPLIT-PI?&gt;</code>+ processing instruction. This tells Smooks where to split the template, outputting the first part of the template at the start of the element, and the other part at the end of the element. The element template (the second template) will be output in between.</p>
</div>
<div class="paragraph">
<p>The second FreeMarker template is very straightforward. It simply outputs the elements at the end of every element in the source message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;ftl:freemarker</span> <span class="na">applyOnElement=</span><span class="s">"order-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ftl:template&gt;</span><span class="c">&lt;!-- &lt;item&gt;
    &lt;id&gt;${.vars["order-item"].@id}&lt;/id&gt;
    &lt;productId&gt;${.vars["order-item"].product}&lt;/productId&gt;
    &lt;quantity&gt;${.vars["order-item"].quantity}&lt;/quantity&gt;
    &lt;price&gt;${.vars["order-item"].price}&lt;/price&gt;
&lt;/item&gt;--&gt;</span>
        <span class="nt">&lt;/ftl:template&gt;</span>
    <span class="nt">&lt;/ftl:freemarker&gt;</span>
<span class="nt">&lt;/smooks-resource-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the second template fires on the end of the elements, it effectively generates output into the location of the <strong>&lt;?TEMPLATE-SPLIT-PI?&gt;</strong> Processing Instruction in the first template. Note that the second template could have also referenced data in the "order" NodeModel.</p>
</div>
<div class="paragraph">
<p>And that&#8217;s it! This is available as a runnable example in the Tutorials section.</p>
</div>
<div class="paragraph">
<p>This approach to performing a One-to-One Transformation of a huge message works simply because the only objects in memory at any one time are the order header details and the current details (in the Virtual Object Model).? Obviously it can&#8217;t work if the transformation is so obscure as to always require full access to all the data in the source message e.g. if the messages needs to have all the order items reversed in order (or sorted).? In such a case however, you do have the option of routing the order details and items to a database and then using the database&#8217;s storage, query and paging features to perform the transformation.</p>
</div>
</div>
<div class="sect3">
<h4 id="splitting_routing">Splitting &amp; Routing</h4>
<div class="paragraph">
<p>Smooks supports a number of options when it comes to splitting and routing fragments. The ability to split the stream into fragments and route these fragments to different endpoints (File, JMS, etc&#8230;&#8203;) is a fundamental capability. Smooks improves this capability with the following features:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Basic Fragment Splitting</em>: basic splitting means that no fragment transformation happens prior to routing. Basic splitting and routing involves defining the XPath of the fragment to be split out and defining a routing component (e.g., Apache Camel) to route that unmodified split fragment.</p>
</li>
<li>
<p><em>Complex Fragment Splitting</em>: basic fragment splitting works for many use cases and is what most splitting and routing solutions offer. Smooks extends the basic splitting capabilities by allowing you to perform transformations on the split fragment data before routing is applied. For example, merging in the customer-details order information with each order-item information before performing the routing order-item split fragment routing.</p>
</li>
<li>
<p><em>In-Flight Stream Splitting &amp; Routing (Huge Message Support)</em>: Smooks is able to process gigabyte streams because it can perform in-flight event routing; events are not accumulated when the <code>max.node.depth</code> parameter is left unset.</p>
</li>
<li>
<p><em>Multiple Splitting and Routing</em>: conditionally split and route multiple fragments (different formats XML, EDI, POJOs, etc&#8230;&#8203;) to different endpoints in a single filtering pass of the source. One could route an <em>OrderItem</em> Java instance to the <em>HighValueOrdersValidation</em> JMS queue for order items with a value greater than $1,000 and route all order items as XML/JSON to an HTTP endpoint for logging.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
    </div><!-- /.container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/assets/js/jquery-3.1.0.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/assets/js/smooks.js"></script>
  </body>
</html>

